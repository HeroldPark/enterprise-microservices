version: '3.8'

# Enterprise Microservices Architecture with Kafka (KRaft Mode)
# PostgreSQL → MariaDB 10.11 변경
# MongoDB 대신 MariaDB 사용 (Admin Service용)
# Kafka 메시지 큐 추가 (Zookeeper 제거 - KRaft 모드 사용)
# PostgreSQL 추가 (Model Service용)

# 7개의 독립적인 DB 인스턴스 구성
# UTF-8 완전 지원을 위해 utf8mb4 문자셋 사용

# 포트 매핑
# User DB: 13306 포트 (MariaDB)
# Product DB: 13307 포트 (MariaDB)
# Order DB: 13308 포트 (MariaDB)
# Board DB: 13309 포트 (MariaDB)
# Admin DB: 13310 포트 (MariaDB)
# Message DB: 13311 포트 (MariaDB)
# Model DB: 15432 포트 (PostgreSQL)

# Kafka 포트 (KRaft 모드 - Zookeeper 불필요)
# Kafka Broker: 9092 (내부), 9093 (외부)
# Kafka Controller: 9094 (내부)
# Kafka UI: 8090

# 접속 정보 단순화
# MariaDB - Username: rozeta, Password: rozeta123, Root Password: maria123
# PostgreSQL - Username: rozeta, Password: rozeta123

# JDBC URL 변경
# jdbc:mariadb:// 형식 사용
# jdbc:postgresql:// 형식 사용 (Model DB)
# UTF-8 인코딩 파라미터 추가

# Enable BuildKit for better caching and parallel builds
# Run with: DOCKER_BUILDKIT=1 COMPOSE_DOCKER_CLI_BUILD=1 docker-compose build

services:
  # =====================================================
  # Message Queue - Kafka (KRaft Mode - No Zookeeper)
  # =====================================================
  
  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka
    ports:
      - "9092:9092"
      - "9093:9093"
    environment:
      # KRaft 설정 (Zookeeper 없이 실행)
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9094
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      
      # Listener 설정
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,PLAINTEXT_HOST://0.0.0.0:9093,CONTROLLER://0.0.0.0:9094
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:9093
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT,CONTROLLER:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      
      # 기타 설정
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
      KAFKA_LOG_RETENTION_HOURS: 168
      KAFKA_LOG_SEGMENT_BYTES: 1073741824
      KAFKA_LOG4J_ROOT_LOGLEVEL: WARN
      KAFKA_TOOLS_LOG4J_LOGLEVEL: ERROR
      
      # KRaft 클러스터 ID (고정값 사용)
      CLUSTER_ID: MkU3OEVBNTcwNTJENDM2Qk
    volumes:
      - kafka-data:/var/lib/kafka/data
    networks:
      - enterprise-network
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
      interval: 10s
      timeout: 10s
      retries: 5

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    depends_on:
      kafka:
        condition: service_healthy
    ports:
      - "8090:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: enterprise-kafka-cluster
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092
      DYNAMIC_CONFIG_ENABLED: 'true'
      LOGGING_LEVEL_ROOT: WARN
      LOGGING_LEVEL_COM_PROVECTUS: WARN
    networks:
      - enterprise-network

  # =====================================================
  # Databases - MariaDB
  # =====================================================
  
  mariadb-user:
    image: mariadb:10.11
    container_name: mariadb-user
    environment:
      MYSQL_DATABASE: user-db
      MYSQL_USER: rozeta
      MYSQL_PASSWORD: rozeta123
      MYSQL_ROOT_PASSWORD: maria123
    ports:
      - "13306:3306"
    volumes:
      - mariadb-user-data:/var/lib/mysql
    networks:
      - enterprise-network
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_general_ci
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # mariadb-product:
  #   image: mariadb:10.11
  #   container_name: mariadb-product
  #   environment:
  #     MYSQL_DATABASE: product-db
  #     MYSQL_USER: rozeta
  #     MYSQL_PASSWORD: rozeta123
  #     MYSQL_ROOT_PASSWORD: maria123
  #   ports:
  #     - "13307:3306"
  #   volumes:
  #     - mariadb-product-data:/var/lib/mysql
  #   networks:
  #     - enterprise-network
  #   command: --character-set-server=utf8mb4 --collation-server=utf8mb4_general_ci
  #   healthcheck:
  #     test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #   restart: unless-stopped

  # mariadb-order:
  #   image: mariadb:10.11
  #   container_name: mariadb-order
  #   environment:
  #     MYSQL_DATABASE: order-db
  #     MYSQL_USER: rozeta
  #     MYSQL_PASSWORD: rozeta123
  #     MYSQL_ROOT_PASSWORD: maria123
  #   ports:
  #     - "13308:3306"
  #   volumes:
  #     - mariadb-order-data:/var/lib/mysql
  #   networks:
  #     - enterprise-network
  #   command: --character-set-server=utf8mb4 --collation-server=utf8mb4_general_ci
  #   healthcheck:
  #     test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #   restart: unless-stopped

  mariadb-board:
    image: mariadb:10.11
    container_name: mariadb-board
    environment:
      MYSQL_DATABASE: board-db
      MYSQL_USER: rozeta
      MYSQL_PASSWORD: rozeta123
      MYSQL_ROOT_PASSWORD: maria123
    ports:
      - "13309:3306"
    volumes:
      - mariadb-board-data:/var/lib/mysql
    networks:
      - enterprise-network
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_general_ci
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  mariadb-admin:
    image: mariadb:10.11
    container_name: mariadb-admin
    environment:
      MYSQL_DATABASE: admin-db
      MYSQL_USER: rozeta
      MYSQL_PASSWORD: rozeta123
      MYSQL_ROOT_PASSWORD: maria123
    ports:
      - "13310:3306"
    volumes:
      - mariadb-admin-data:/var/lib/mysql
    networks:
      - enterprise-network
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_general_ci
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  mariadb-message:
    image: mariadb:10.11
    container_name: mariadb-message
    environment:
      MYSQL_DATABASE: message-db
      MYSQL_USER: rozeta
      MYSQL_PASSWORD: rozeta123
      MYSQL_ROOT_PASSWORD: maria123
    ports:
      - "13311:3306"
    volumes:
      - mariadb-message-data:/var/lib/mysql
    networks:
      - enterprise-network
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_general_ci
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # =====================================================
  # Database - PostgreSQL (for AI Model Service)
  # =====================================================
  
  postgres-model:
    image: postgres:16-alpine
    container_name: postgres-model
    environment:
      POSTGRES_DB: model-db
      POSTGRES_USER: rozeta
      POSTGRES_PASSWORD: rozeta123
    ports:
      - "15432:5432"
    volumes:
      - postgres-model-data:/var/lib/postgresql/data
    networks:
      - enterprise-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U rozeta"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # =====================================================
  # Service Discovery & Configuration
  # =====================================================
  
  config-server:
    build:
      context: ./backend/config-server
      dockerfile: Dockerfile
      cache_from:
        - config-server:latest
    image: config-server:latest
    container_name: config-server
    ports:
      - "8888:8888"
    networks:
      - enterprise-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8888/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    restart: unless-stopped

  eureka-server:
    build:
      context: ./backend/eureka-server
      dockerfile: Dockerfile
      cache_from:
        - eureka-server:latest
    image: eureka-server:latest
    container_name: eureka-server
    ports:
      - "8761:8761"
    networks:
      - enterprise-network
    depends_on:
      config-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8761/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  # =====================================================
  # Microservices
  # =====================================================
  
  user-service:
    build:
      context: ./backend/user-service
      dockerfile: Dockerfile
      cache_from:
        - user-service:latest
    image: user-service:latest
    container_name: user-service
    ports:
      - "8081:8081"
    environment:
      SPRING_DATASOURCE_URL: jdbc:mariadb://mariadb-user:3306/user-db?useUnicode=true&characterEncoding=UTF-8
      SPRING_DATASOURCE_USERNAME: rozeta
      SPRING_DATASOURCE_PASSWORD: rozeta123
      SPRING_DATASOURCE_DRIVER_CLASS_NAME: org.mariadb.jdbc.Driver
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
    networks:
      - enterprise-network
    depends_on:
      mariadb-user:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
      kafka:
        condition: service_healthy
    restart: on-failure

  # product-service:
  #   build:
  #     context: ./backend/product-service
  #     dockerfile: Dockerfile
  #     cache_from:
  #       - product-service:latest
  #   image: product-service:latest
  #   container_name: product-service
  #   ports:
  #     - "8082:8082"
  #   environment:
  #     SPRING_DATASOURCE_URL: jdbc:mariadb://mariadb-product:3306/product-db?useUnicode=true&characterEncoding=UTF-8
  #     SPRING_DATASOURCE_USERNAME: rozeta
  #     SPRING_DATASOURCE_PASSWORD: rozeta123
  #     SPRING_DATASOURCE_DRIVER_CLASS_NAME: org.mariadb.jdbc.Driver
  #     EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
  #     KAFKA_BOOTSTRAP_SERVERS: kafka:9092
  #   networks:
  #     - enterprise-network
  #   depends_on:
  #     mariadb-product:
  #       condition: service_healthy
  #     eureka-server:
  #       condition: service_healthy
  #     kafka:
  #       condition: service_healthy
  #   restart: on-failure

  # order-service:
  #   build:
  #     context: ./backend/order-service
  #     dockerfile: Dockerfile
  #     cache_from:
  #       - order-service:latest
  #   image: order-service:latest
  #   container_name: order-service
  #   ports:
  #     - "8083:8083"
  #   environment:
  #     SPRING_DATASOURCE_URL: jdbc:mariadb://mariadb-order:3306/order-db?useUnicode=true&characterEncoding=UTF-8
  #     SPRING_DATASOURCE_USERNAME: rozeta
  #     SPRING_DATASOURCE_PASSWORD: rozeta123
  #     SPRING_DATASOURCE_DRIVER_CLASS_NAME: org.mariadb.jdbc.Driver
  #     EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
  #     KAFKA_BOOTSTRAP_SERVERS: kafka:9092
  #   networks:
  #     - enterprise-network
  #   depends_on:
  #     mariadb-order:
  #       condition: service_healthy
  #     eureka-server:
  #       condition: service_healthy
  #     kafka:
  #       condition: service_healthy
  #     user-service:
  #       condition: service_started
  #     product-service:
  #       condition: service_started
  #   restart: on-failure

  board-service:
    build:
      context: ./backend/board-service
      dockerfile: Dockerfile
      cache_from:
        - board-service:latest
    image: board-service:latest
    container_name: board-service
    ports:
      - "8084:8084"
    environment:
      SPRING_DATASOURCE_URL: jdbc:mariadb://mariadb-board:3306/board-db?useUnicode=true&characterEncoding=UTF-8
      SPRING_DATASOURCE_USERNAME: rozeta
      SPRING_DATASOURCE_PASSWORD: rozeta123
      SPRING_DATASOURCE_DRIVER_CLASS_NAME: org.mariadb.jdbc.Driver
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
    networks:
      - enterprise-network
    depends_on:
      mariadb-board:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
      kafka:
        condition: service_healthy
      user-service:
        condition: service_started
      # product-service:
      #   condition: service_started
    restart: on-failure

  admin-service:
    build:
      context: ./backend/admin-service
      dockerfile: Dockerfile
      cache_from:
        - admin-service:latest
    image: admin-service:latest
    container_name: admin-service
    ports:
      - "8085:8085"
    environment:
      SPRING_DATASOURCE_URL: jdbc:mariadb://mariadb-admin:3306/admin-db?useUnicode=true&characterEncoding=UTF-8
      SPRING_DATASOURCE_USERNAME: rozeta
      SPRING_DATASOURCE_PASSWORD: rozeta123
      SPRING_DATASOURCE_DRIVER_CLASS_NAME: org.mariadb.jdbc.Driver
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
    networks:
      - enterprise-network
    depends_on:
      mariadb-admin:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
      kafka:
        condition: service_healthy
    restart: on-failure

  message-service:
    build:
      context: ./backend/message-service
      dockerfile: Dockerfile
      cache_from:
        - message-service:latest
    image: message-service:latest
    container_name: message-service
    ports:
      - "8086:8086"
    environment:
      SPRING_PROFILES_ACTIVE: dev
      
      # Query 결과 출력 어려움
      # SPRING_DATASOURCE_URL: jdbc:mariadb://mariadb-message:3306/message-db?useUnicode=true&characterEncoding=UTF-8
      # SPRING_DATASOURCE_USERNAME: rozeta
      # SPRING_DATASOURCE_PASSWORD: rozeta123
      # SPRING_DATASOURCE_DRIVER_CLASS_NAME: org.mariadb.jdbc.Driver
      
      # Query 결과 출력 보기 위해서 log4jdbc 사용
      SPRING_DATASOURCE_URL: jdbc:log4jdbc:mariadb://mariadb-message:3306/message-db?useUnicode=true&characterEncoding=UTF-8
      SPRING_DATASOURCE_DRIVER_CLASS_NAME: net.sf.log4jdbc.sql.jdbcapi.DriverSpy
      SPRING_DATASOURCE_USERNAME: rozeta
      SPRING_DATASOURCE_PASSWORD: rozeta123

      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
    networks:
      - enterprise-network
    depends_on:
      mariadb-message:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
      kafka:
        condition: service_healthy
    restart: on-failure

  model-service:
    build:
      context: ./backend/model-service
      dockerfile: Dockerfile
      cache_from:
        - model-service:latest
    image: model-service:latest
    container_name: model-service
    ports:
      - "8087:8087"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-model:5432/model-db?useUnicode=true&characterEncoding=UTF-8
      SPRING_DATASOURCE_USERNAME: rozeta
      SPRING_DATASOURCE_PASSWORD: rozeta123
      SPRING_DATASOURCE_DRIVER_CLASS_NAME: org.postgresql.Driver
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
    networks:
      - enterprise-network
    depends_on:
      postgres-model:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
      kafka:
        condition: service_healthy
    restart: on-failure

  # =====================================================
  # API Gateway
  # =====================================================
  
  api-gateway:
    build:
      context: ./backend/api-gateway
      dockerfile: Dockerfile
      cache_from:
        - api-gateway:latest
    image: api-gateway:latest
    container_name: api-gateway
    ports:
      - "8080:8080"
    environment:
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
    networks:
      - enterprise-network
    depends_on:
      eureka-server:
        condition: service_healthy
      user-service:
        condition: service_started
      # product-service:
      #   condition: service_started
      # order-service:
      #   condition: service_started
      board-service:
        condition: service_started
      admin-service:
        condition: service_started
      message-service:
        condition: service_started
      model-service:
        condition: service_started
    restart: on-failure

  # =====================================================
  # Frontend
  # =====================================================
  
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      cache_from:
        - frontend:latest
    image: frontend:latest
    container_name: frontend
    ports:
      - "3000:80"
    networks:
      - enterprise-network
    depends_on:
      - api-gateway
    restart: on-failure

networks:
  enterprise-network:
    driver: bridge

volumes:
  # Message Queue
  kafka-data:
  
  # Databases
  mariadb-user-data:
  # mariadb-product-data:
  # mariadb-order-data:
  mariadb-board-data:
  mariadb-admin-data:
  mariadb-message-data:
  postgres-model-data: