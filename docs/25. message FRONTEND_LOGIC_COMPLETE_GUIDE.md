# Message í”„ë¡ íŠ¸ì—”ë“œ ì™„ì „ ë¶„ì„ ê°€ì´ë“œ
## React + React Query + Framer Motion ê¸°ë°˜ ë©”ì‹œì§€ ì‹œìŠ¤í…œ

---

## ğŸ“š ëª©ì°¨

1. [ì „ì²´ êµ¬ì¡° ê°œìš”](#1-ì „ì²´-êµ¬ì¡°-ê°œìš”)
2. [í•µì‹¬ ê¸°ìˆ  ìŠ¤íƒ](#2-í•µì‹¬-ê¸°ìˆ -ìŠ¤íƒ)
3. [íŒŒì¼ë³„ ìƒì„¸ ë¶„ì„](#3-íŒŒì¼ë³„-ìƒì„¸-ë¶„ì„)
4. [ë°ì´í„° íë¦„](#4-ë°ì´í„°-íë¦„)
5. [ìƒíƒœ ê´€ë¦¬](#5-ìƒíƒœ-ê´€ë¦¬)
6. [API í†µì‹ ](#6-api-í†µì‹ )
7. [ì• ë‹ˆë©”ì´ì…˜](#7-ì• ë‹ˆë©”ì´ì…˜)
8. [ì‹¤ì „ ì‹œë‚˜ë¦¬ì˜¤](#8-ì‹¤ì „-ì‹œë‚˜ë¦¬ì˜¤)

---

## 1. ì „ì²´ êµ¬ì¡° ê°œìš”

### 1.1 ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
message/
â”œâ”€â”€ services/
â”‚   â””â”€â”€ messageService.js      # API í†µì‹  ë ˆì´ì–´
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ Inbox.jsx              # ë°›ì€ ìª½ì§€í•¨
â”‚   â”œâ”€â”€ Sent.jsx               # ë³´ë‚¸ ìª½ì§€í•¨
â”‚   â”œâ”€â”€ AllMessages.jsx        # ì „ì²´ ë©”ì‹œì§€
â”‚   â”œâ”€â”€ MessageDetail.jsx      # ë©”ì‹œì§€ ìƒì„¸
â”‚   â””â”€â”€ MessageCompose.jsx     # ìª½ì§€ ì‘ì„±
â””â”€â”€ components/
    â””â”€â”€ MessageList.jsx        # ë©”ì‹œì§€ ëª©ë¡ ì»´í¬ë„ŒíŠ¸
```

### 1.2 ì»´í¬ë„ŒíŠ¸ ê´€ê³„ë„

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  messageService â”‚
                    â”‚   (API Layer)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                â”‚                â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
    â”‚     Inbox     â”‚ â”‚   Sent    â”‚ â”‚ AllMessages  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
            â”‚                â”‚                â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  MessageList    â”‚
                    â”‚  (ê³µí†µ ì»´í¬ë„ŒíŠ¸) â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ MessageDetail   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. í•µì‹¬ ê¸°ìˆ  ìŠ¤íƒ

### 2.1 React Router

**ëª©ì **: SPA ë¼ìš°íŒ… ë° í˜ì´ì§€ ì „í™˜

```jsx
import { useNavigate, useLocation, useParams, useSearchParams } from 'react-router-dom'

// ì˜ˆì œ
const navigate = useNavigate()
navigate('/messages/inbox')           // í˜ì´ì§€ ì´ë™
navigate(-1)                          // ë’¤ë¡œ ê°€ê¸°

const location = useLocation()
const receiverId = location.state?.receiverId  // ì´ì „ í˜ì´ì§€ì—ì„œ ì „ë‹¬ëœ ë°ì´í„°

const { id } = useParams()            // URL íŒŒë¼ë¯¸í„°
const [searchParams] = useSearchParams()
const to = searchParams.get('to')     // ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°
```

### 2.2 React Query (TanStack Query)

**ëª©ì **: ì„œë²„ ìƒíƒœ ê´€ë¦¬ ë° ìºì‹±

```jsx
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query'

// ë°ì´í„° ì¡°íšŒ
const { data, isLoading, error, refetch } = useQuery({
    queryKey: ['messages', 'inbox', receiverId],  // ìºì‹œ í‚¤
    queryFn: () => messageService.getInbox(receiverId),  // API í˜¸ì¶œ
    enabled: !!receiverId,  // receiverIdê°€ ìˆì„ ë•Œë§Œ ì‹¤í–‰
    staleTime: 15000,       // 15ì´ˆ ë™ì•ˆ fresh ìƒíƒœ ìœ ì§€
    retry: 1                // ì‹¤íŒ¨ ì‹œ 1ë²ˆ ì¬ì‹œë„
})

// ë°ì´í„° ë³€ê²½ (ìƒì„±/ìˆ˜ì •/ì‚­ì œ)
const mutation = useMutation({
    mutationFn: (data) => messageService.sendMessage(data),
    onSuccess: () => {
        // ì„±ê³µ ì‹œ ì‹¤í–‰
        queryClient.invalidateQueries(['messages'])  // ìºì‹œ ë¬´íš¨í™”
    },
    onError: (error) => {
        // ì—ëŸ¬ ì‹œ ì‹¤í–‰
        console.error(error)
    }
})
```

**ìºì‹± ì „ëµ:**
```
1. ì²« ì¡°íšŒ: API í˜¸ì¶œ â†’ ìºì‹œ ì €ì¥
2. ì¬ì¡°íšŒ (15ì´ˆ ì´ë‚´): ìºì‹œ ë°˜í™˜ (API í˜¸ì¶œ X)
3. ì¬ì¡°íšŒ (15ì´ˆ ì´í›„): ë°±ê·¸ë¼ìš´ë“œì—ì„œ API í˜¸ì¶œ â†’ ìºì‹œ ì—…ë°ì´íŠ¸
4. ë¬´íš¨í™”: invalidateQueries() í˜¸ì¶œ ì‹œ ìºì‹œ ì‚­ì œ â†’ ë‹¤ìŒ ì¡°íšŒ ì‹œ ìƒˆë¡œ ê°€ì ¸ì˜´
```

### 2.3 Zustand (authStore)

**ëª©ì **: í´ë¼ì´ì–¸íŠ¸ ì „ì—­ ìƒíƒœ ê´€ë¦¬

```jsx
import { useAuthStore } from '../../app/authStore'

const { user, token, isAuthenticated, logout } = useAuthStore()

// ì‚¬ìš© ì˜ˆ:
if (!user || !token) {
    navigate('/login')
}
```

### 2.4 Framer Motion

**ëª©ì **: ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜

```jsx
import { motion } from 'framer-motion'

<motion.div
    initial={{ opacity: 0, y: 20 }}    // ì´ˆê¸° ìƒíƒœ
    animate={{ opacity: 1, y: 0 }}     // ì• ë‹ˆë©”ì´ì…˜ ëª©í‘œ
    transition={{ duration: 0.5 }}     // ì „í™˜ ì‹œê°„
    whileHover={{ scale: 1.01 }}       // í˜¸ë²„ íš¨ê³¼
    whileTap={{ scale: 0.99 }}         // í´ë¦­ íš¨ê³¼
>
    Content
</motion.div>
```

---

## 3. íŒŒì¼ë³„ ìƒì„¸ ë¶„ì„

### 3.1 messageService.js - API í†µì‹  ë ˆì´ì–´

**ì—­í• **: ë°±ì—”ë“œ APIì™€ì˜ ëª¨ë“  í†µì‹ ì„ ë‹´ë‹¹

```javascript
import api from '../../app/api'  // axios ì¸ìŠ¤í„´ìŠ¤

export const messageService = {
  // âœ… ìª½ì§€ ë³´ë‚´ê¸°
  sendMessage: async ({ senderId, receiverId, content }) => {
    const payload = { senderId, receiverId, content }
    const response = await api.post('/messages', payload)
    return response.data
  },

  // âœ… ë°›ì€ ìª½ì§€í•¨
  getInbox: async (receiverId) => {
    const response = await api.get(`/messages/inbox/${receiverId}`)
    return response.data
  },

  // âœ… ë³´ë‚¸ ìª½ì§€í•¨
  getSent: async (senderId) => {
    const response = await api.get(`/messages/sent/${senderId}`)
    return response.data
  },

  // âœ… ì „ì²´ ë©”ì‹œì§€ ì¡°íšŒ
  getAllMessages: async () => {
    const response = await api.get('/messages/all')
    return response.data
  },

  // âœ… ìª½ì§€ ë‹¨ê±´ ì¡°íšŒ
  getById: async (id) => {
    const response = await api.get(`/messages/${id}`)
    return response.data
  },

  // âœ… ì½ìŒ ì²˜ë¦¬
  markRead: async (id) => {
    const response = await api.patch(`/messages/${id}/read`)
    return response.data
  },

  // âœ… ì‚­ì œ
  deleteMessage: async (id) => {
    await api.delete(`/messages/${id}`)
  },
}
```

**ì‹¤í–‰ íë¦„:**
```
1. ì»´í¬ë„ŒíŠ¸ì—ì„œ messageService.getInbox(2) í˜¸ì¶œ
   â†“
2. axiosê°€ GET /api/messages/inbox/2 ìš”ì²­
   â†“
3. API Gateway â†’ message-service ë¼ìš°íŒ…
   â†“
4. ë°±ì—”ë“œì—ì„œ ë°ì´í„° ë°˜í™˜
   â†“
5. response.data ë°˜í™˜
   â†“
6. React Queryê°€ ìºì‹œì— ì €ì¥
```

---

### 3.2 Inbox.jsx - ë°›ì€ ìª½ì§€í•¨

#### ğŸ“Œ ì „ì²´ êµ¬ì¡°

```jsx
const Inbox = () => {
  // 1. Hooks
  const navigate = useNavigate()
  const queryClient = useQueryClient()
  const { user, token } = useAuthStore()

  // 2. State
  const [searchKeyword, setSearchKeyword] = useState('')
  const [tempKeyword, setTempKeyword] = useState('')
  const [onlyUnread, setOnlyUnread] = useState(false)

  // 3. Effects
  useEffect(() => {
    // ë¡œê·¸ì¸ ì²´í¬
  }, [user, token, navigate])

  // 4. Data Fetching
  const { data: messages, isLoading, error } = useQuery({...})
  const deleteMutation = useMutation({...})

  // 5. Computed Values
  const filtered = useMemo(() => {
    // í•„í„°ë§ ë¡œì§
  }, [messages, onlyUnread, searchKeyword])

  // 6. Event Handlers
  const handleSearch = (e) => {...}
  const handleDelete = (messageId, e) => {...}

  // 7. Render
  return (...)
}
```

#### ğŸ“Œ ë¡œì§ ìƒì„¸ ë¶„ì„

**1ï¸âƒ£ ë°ì´í„° ì¡°íšŒ**
```javascript
const receiverId = user?.id  // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ID

const { data: messages, isLoading, error, refetch } = useQuery({
    queryKey: ['messages', 'inbox', receiverId],
    queryFn: () => messageService.getInbox(receiverId),
    enabled: !!receiverId,  // receiverIdê°€ ìˆì„ ë•Œë§Œ ì‹¤í–‰
    retry: 1,
    staleTime: 15000,
})
```

**ë°ì´í„° ì¡°íšŒ íƒ€ì„ë¼ì¸:**
```
00:00 - ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸
00:01 - useQuery ì‹¤í–‰ (enabled=trueë©´)
00:02 - messageService.getInbox(2) í˜¸ì¶œ
00:03 - API í˜¸ì¶œ ì¤‘... (isLoading=true)
00:05 - ë°ì´í„° ë„ì°© (data ì—…ë°ì´íŠ¸, isLoading=false)
00:20 - 15ì´ˆ ê²½ê³¼ (stale ìƒíƒœ)
00:21 - ë‹¤ì‹œ ì¡°íšŒ ì‹œ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ìë™ ê°±ì‹ 
```

**2ï¸âƒ£ í•„í„°ë§ ë° ê²€ìƒ‰**
```javascript
const filtered = useMemo(() => {
    const list = Array.isArray(messages) ? messages : []
    
    return list.filter((m) => {
        // 1. ì½ìŒ í•„í„°
        if (onlyUnread && m.read) return false
        
        // 2. ê²€ìƒ‰ì–´ í•„í„°
        if (!searchKeyword.trim()) return true
        return String(m.content || '')
            .toLowerCase()
            .includes(searchKeyword.trim().toLowerCase())
    })
}, [messages, onlyUnread, searchKeyword])
```

**useMemoì˜ ì—­í• :**
```
1. messages, onlyUnread, searchKeywordê°€ ë³€ê²½ë  ë•Œë§Œ ì¬ê³„ì‚°
2. ë¶ˆí•„ìš”í•œ í•„í„°ë§ ì—°ì‚° ë°©ì§€
3. ì„±ëŠ¥ ìµœì í™”
```

**í•„í„°ë§ ì˜ˆì œ:**
```javascript
// ì›ë³¸ ë°ì´í„°
messages = [
    { id: 1, content: "Hello", read: false },
    { id: 2, content: "Hi there", read: true },
    { id: 3, content: "Good morning", read: false }
]

// onlyUnread=true, searchKeyword="Hello"
filtered = [
    { id: 1, content: "Hello", read: false }
]
// â†’ read=true ì œì™¸ + "Hello" í¬í•¨ë§Œ
```

**3ï¸âƒ£ ì‚­ì œ ê¸°ëŠ¥**
```javascript
const deleteMutation = useMutation({
    mutationFn: (messageId) => messageService.deleteMessage(messageId),
    onSuccess: () => {
        // ìºì‹œ ë¬´íš¨í™” â†’ ìë™ ì¬ì¡°íšŒ
        queryClient.invalidateQueries({ queryKey: ['messages', 'inbox', receiverId] })
        queryClient.invalidateQueries({ queryKey: ['messages', 'all'] })
    },
    onError: (err) => {
        alert(`ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${err.message}`)
    },
})

const handleDelete = (messageId, e) => {
    e?.stopPropagation()  // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€
    if (!window.confirm('ìª½ì§€ë¥¼ ì‚­ì œí• ê¹Œìš”?')) return
    deleteMutation.mutate(messageId)
}
```

**ì‚­ì œ í”Œë¡œìš°:**
```
1. ì‚¬ìš©ìê°€ íœ´ì§€í†µ ì•„ì´ì½˜ í´ë¦­
   â†“
2. handleDelete(1, event) í˜¸ì¶œ
   â†“
3. e.stopPropagation() â†’ ë©”ì‹œì§€ ìƒì„¸ë¡œ ì´ë™ ë°©ì§€
   â†“
4. window.confirm() â†’ ì‚¬ìš©ì í™•ì¸
   â†“
5. deleteMutation.mutate(1) â†’ API í˜¸ì¶œ
   â†“
6. ì„±ê³µ ì‹œ invalidateQueries() â†’ ìºì‹œ ë¬´íš¨í™”
   â†“
7. useQuery ìë™ ì¬ì‹¤í–‰ â†’ ìµœì‹  ë°ì´í„° ì¡°íšŒ
   â†“
8. í™”ë©´ ìë™ ì—…ë°ì´íŠ¸
```

**4ï¸âƒ£ ê²€ìƒ‰ ê¸°ëŠ¥**
```javascript
const [searchKeyword, setSearchKeyword] = useState('')    // ì‹¤ì œ ê²€ìƒ‰ì–´
const [tempKeyword, setTempKeyword] = useState('')        // ì…ë ¥ ì¤‘ì¸ ê²€ìƒ‰ì–´

const handleSearch = (e) => {
    e.preventDefault()
    setSearchKeyword(tempKeyword)  // ì—”í„° ë˜ëŠ” ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì‹œ ì ìš©
}

const handleClearSearch = () => {
    setTempKeyword('')
    setSearchKeyword('')
}
```

**ê²€ìƒ‰ ë¡œì§ ì´ìœ :**
```
tempKeyword: ì‚¬ìš©ìê°€ íƒ€ì´í•‘í•˜ëŠ” ë™ì•ˆ ì €ì¥
searchKeyword: ì‹¤ì œ í•„í„°ë§ì— ì‚¬ìš©

ì™œ ë¶„ë¦¬?
â†’ íƒ€ì´í•‘í•  ë•Œë§ˆë‹¤ í•„í„°ë§í•˜ë©´ ì„±ëŠ¥ ì €í•˜
â†’ ì—”í„°/ë²„íŠ¼ í´ë¦­ ì‹œì—ë§Œ ì ìš©
```

---

### 3.3 MessageCompose.jsx - ìª½ì§€ ì‘ì„±

#### ğŸ“Œ ì´ˆê¸°ê°’ ì„¤ì • ë¡œì§

```javascript
const location = useLocation()
const [searchParams] = useSearchParams()

// ë°›ëŠ” ì‚¬ëŒ IDë¥¼ ì—¬ëŸ¬ ë°©ì‹ìœ¼ë¡œ ë°›ì„ ìˆ˜ ìˆìŒ
const initialReceiverId =
    location.state?.receiverId ??                      // 1ìˆœìœ„: ì´ì „ í˜ì´ì§€ì—ì„œ stateë¡œ ì „ë‹¬
    (searchParams.get('to') ? Number(searchParams.get('to')) : '')  // 2ìˆœìœ„: URL ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°

const [receiverId, setReceiverId] = useState(initialReceiverId)
const [content, setContent] = useState('')
```

**ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤:**

**ì‹œë‚˜ë¦¬ì˜¤ 1: MessageDetailì—ì„œ ë‹µì¥ ë²„íŠ¼ í´ë¦­**
```javascript
// MessageDetail.jsx
navigate('/messages/compose', { 
    state: { receiverId: message.senderId } 
})

// MessageCompose.jsx
// location.state.receiverId = 100
// initialReceiverId = 100
```

**ì‹œë‚˜ë¦¬ì˜¤ 2: URLë¡œ ì§ì ‘ ì ‘ê·¼**
```javascript
// URL: /messages/compose?to=200

// MessageCompose.jsx
// searchParams.get('to') = "200"
// initialReceiverId = 200
```

**ì‹œë‚˜ë¦¬ì˜¤ 3: ì¼ë°˜ ìª½ì§€ ì‘ì„±**
```javascript
// URL: /messages/compose

// MessageCompose.jsx
// initialReceiverId = ""
// ì‚¬ìš©ìê°€ ì§ì ‘ ì…ë ¥í•´ì•¼ í•¨
```

#### ğŸ“Œ í¼ ì „ì†¡ ë¡œì§

```javascript
const sendMutation = useMutation({
    mutationFn: (payload) => messageService.sendMessage(payload),
    onSuccess: (created) => {
        navigate('/messages/sent')  // ë³´ë‚¸í•¨ìœ¼ë¡œ ì´ë™
    },
    onError: (error) => {
        if (error.response?.status === 401) {
            alert('ì¸ì¦ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤')
            navigate('/login')
        } else if (error.response?.status === 403) {
            alert('ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤')
        } else {
            alert(`ìª½ì§€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`)
        }
    },
})

const handleSubmit = (e) => {
    e.preventDefault()

    // 1ï¸âƒ£ ë¡œê·¸ì¸ ì²´í¬
    if (!user?.id) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤')
        navigate('/login')
        return
    }

    // 2ï¸âƒ£ ì…ë ¥ê°’ ê²€ì¦
    const rid = Number(receiverId)
    if (!rid || Number.isNaN(rid)) {
        alert('ë°›ëŠ” ì‚¬ëŒ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”')
        return
    }

    if (!String(content).trim()) {
        alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”')
        return
    }

    // 3ï¸âƒ£ API í˜¸ì¶œ
    sendMutation.mutate({
        senderId: user.id,
        receiverId: rid,
        content: String(content).trim(),
    })
}
```

**ì „ì†¡ í”Œë¡œìš°:**
```
1. ì‚¬ìš©ìê°€ í¼ ì‘ì„± í›„ "ì „ì†¡" ë²„íŠ¼ í´ë¦­
   â†“
2. handleSubmit(event) í˜¸ì¶œ
   â†“
3. e.preventDefault() â†’ ê¸°ë³¸ í¼ ì œì¶œ ë°©ì§€
   â†“
4. ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
   â†“
5. ì…ë ¥ê°’ ê²€ì¦ (receiverId, content)
   â†“
6. sendMutation.mutate() â†’ API í˜¸ì¶œ
   â†“ (isPending=true, ë²„íŠ¼ ë¹„í™œì„±í™”)
7. messageService.sendMessage() ì‹¤í–‰
   â†“
8. ì„±ê³µ ì‹œ:
   - onSuccess ì‹¤í–‰
   - navigate('/messages/sent')
   - ë³´ë‚¸í•¨ í˜ì´ì§€ë¡œ ì´ë™
   â†“
9. ì‹¤íŒ¨ ì‹œ:
   - onError ì‹¤í–‰
   - ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
```

---

### 3.4 MessageDetail.jsx - ë©”ì‹œì§€ ìƒì„¸

#### ğŸ“Œ ìë™ ì½ìŒ ì²˜ë¦¬

```javascript
const { id } = useParams()  // URLì—ì„œ ë©”ì‹œì§€ ID ì¶”ì¶œ
const messageId = Number(id)

// ë©”ì‹œì§€ ì¡°íšŒ
const { data: message, isLoading, error } = useQuery({
    queryKey: ['messages', 'detail', messageId],
    queryFn: () => messageService.getById(messageId),
    enabled: !!messageId,
    retry: 1,
    staleTime: 15000,
})

// ì½ìŒ ì²˜ë¦¬ mutation
const markReadMutation = useMutation({
    mutationFn: () => messageService.markRead(messageId),
    onSuccess: (updated) => {
        // 1. detail ìºì‹œ ì—…ë°ì´íŠ¸
        queryClient.setQueryData(['messages', 'detail', messageId], updated)
        
        // 2. inbox ìºì‹œ ë¬´íš¨í™” (ëª©ë¡ ê°±ì‹ )
        if (user?.id) {
            queryClient.invalidateQueries({ 
                queryKey: ['messages', 'inbox', user.id] 
            })
        }
    },
})

// ìë™ ì½ìŒ ì²˜ë¦¬ ë¡œì§
useEffect(() => {
    if (!message || !user?.id) return
    
    const isReceiver = message.receiverId === user.id
    
    // ë°›ì€ ìª½ì§€ì´ê³  + ì•ˆ ì½ìŒ ìƒíƒœì´ê³  + mutation ì‹¤í–‰ ì¤‘ì´ ì•„ë‹ˆë©´
    if (isReceiver && message.read === false && !markReadMutation.isPending) {
        markReadMutation.mutate()
    }
}, [message, user?.id])
```

**ìë™ ì½ìŒ ì²˜ë¦¬ í”Œë¡œìš°:**
```
1. ë©”ì‹œì§€ ìƒì„¸ í˜ì´ì§€ ì ‘ê·¼
   â†“
2. useQueryë¡œ ë©”ì‹œì§€ ì¡°íšŒ
   â†“
3. message ë°ì´í„° ë„ì°©
   â†“
4. useEffect ì‹¤í–‰
   â†“
5. ì¡°ê±´ í™•ì¸:
   - message ì¡´ì¬?
   - í˜„ì¬ ì‚¬ìš©ìê°€ ìˆ˜ì‹ ì?
   - ì•„ì§ ì•ˆ ì½ìŒ?
   - mutation ì‹¤í–‰ ì¤‘ ì•„ë‹˜?
   â†“
6. ëª¨ë‘ trueë©´ markReadMutation.mutate()
   â†“
7. PATCH /messages/{id}/read í˜¸ì¶œ
   â†“
8. ì„±ê³µ ì‹œ:
   - detail ìºì‹œ ì—…ë°ì´íŠ¸ (read: true)
   - inbox ìºì‹œ ë¬´íš¨í™” â†’ ëª©ë¡ì—ì„œ ì•ˆì½ìŒ ë°°ì§€ ì œê±°
```

#### ğŸ“Œ ì‚­ì œ ê¸°ëŠ¥

```javascript
const deleteMutation = useMutation({
    mutationFn: () => messageService.deleteMessage(messageId),
    onSuccess: () => {
        // ëª¨ë“  ê´€ë ¨ ìºì‹œ ë¬´íš¨í™”
        if (user?.id) {
            queryClient.invalidateQueries({ queryKey: ['messages', 'inbox', user.id] })
            queryClient.invalidateQueries({ queryKey: ['messages', 'sent', user.id] })
        }
        navigate(-1)  // ì´ì „ í˜ì´ì§€ë¡œ
    },
    onError: (err) => {
        alert(`ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${err.message}`)
    },
})

const handleDelete = () => {
    if (!window.confirm('ìª½ì§€ë¥¼ ì‚­ì œí• ê¹Œìš”?')) return
    deleteMutation.mutate()
}
```

#### ğŸ“Œ ë‹µì¥ ê¸°ëŠ¥

```javascript
const handleReply = () => {
    if (!message) return
    
    // ë°›ì€ ìª½ì§€ì— ëŒ€í•´ ë‹µì¥: ë°œì‹ ìì—ê²Œ ë³´ëƒ„
    navigate('/messages/compose', { 
        state: { receiverId: message.senderId } 
    })
}
```

**ë‹µì¥ í”Œë¡œìš°:**
```
ì‚¬ìš©ì A(id=1)ê°€ ì‚¬ìš©ì B(id=2)ì—ê²Œ ë©”ì‹œì§€ ë³´ëƒ„
   â†“
Bê°€ ë©”ì‹œì§€ ìƒì„¸ í˜ì´ì§€ì—ì„œ í™•ì¸
message = { senderId: 1, receiverId: 2, ... }
   â†“
Bê°€ "ë‹µì¥" ë²„íŠ¼ í´ë¦­
   â†“
navigate('/messages/compose', { state: { receiverId: 1 } })
   â†“
MessageCompose í˜ì´ì§€ ì—´ë¦¼
   â†“
ë°›ëŠ” ì‚¬ëŒ IDê°€ ìë™ìœ¼ë¡œ 1ë¡œ ì„¤ì •ë¨
```

---

### 3.5 MessageList.jsx - ê³µí†µ ëª©ë¡ ì»´í¬ë„ŒíŠ¸

#### ğŸ“Œ Props êµ¬ì¡°

```javascript
const MessageList = ({ 
    messages = [],           // ë©”ì‹œì§€ ë°°ì—´
    mode = 'inbox',         // 'inbox' | 'sent' | 'all'
    currentUserId,          // í˜„ì¬ ì‚¬ìš©ì ID
    onSelect,               // ë©”ì‹œì§€ í´ë¦­ í•¸ë“¤ëŸ¬
    onDelete,               // ì‚­ì œ ë²„íŠ¼ í•¸ë“¤ëŸ¬ (ì„ íƒì )
    isDeleting = false      // ì‚­ì œ ì¤‘ ìƒíƒœ (ì„ íƒì )
}) => {
    // ...
}
```

#### ğŸ“Œ ì •ë ¬ ë¡œì§

```javascript
const sorted = [...messages].sort((a, b) => {
    const da = new Date(a?.createdAt || 0).getTime()
    const db = new Date(b?.createdAt || 0).getTime()
    return db - da  // ìµœì‹ ìˆœ (ë‚´ë¦¼ì°¨ìˆœ)
})
```

**ì •ë ¬ ì˜ˆì œ:**
```javascript
// ì›ë³¸
messages = [
    { id: 1, createdAt: "2024-01-15T10:00:00" },
    { id: 2, createdAt: "2024-01-15T12:00:00" },
    { id: 3, createdAt: "2024-01-15T09:00:00" }
]

// ì •ë ¬ í›„ (ìµœì‹ ìˆœ)
sorted = [
    { id: 2, createdAt: "2024-01-15T12:00:00" },  // ê°€ì¥ ìµœê·¼
    { id: 1, createdAt: "2024-01-15T10:00:00" },
    { id: 3, createdAt: "2024-01-15T09:00:00" }
]
```

#### ğŸ“Œ Modeì— ë”°ë¥¸ í‘œì‹œ

```javascript
{sorted.map((m) => {
    const counterpartId = mode === 'inbox' ? m.senderId : m.receiverId
    const isUnread = !m.read

    return (
        <motion.div key={m.id}>
            {/* ì‚­ì œ ë²„íŠ¼ - ìš°ì¸¡ ìƒë‹¨ */}
            {onDelete && (
                <button onClick={(e) => onDelete(m.id, e)}>
                    <Trash2 />
                </button>
            )}

            <button onClick={() => onSelect?.(m)}>
                {/* ì½ìŒ/ì•ˆì½ìŒ ì•„ì´ì½˜ */}
                {isUnread ? <Mail /> : <MailOpen />}

                {/* ëª¨ë“œë³„ í‘œì‹œ */}
                {mode === 'all' ? (
                    <p>From: {m.senderId} â†’ To: {m.receiverId}</p>
                ) : (
                    <p>{mode === 'inbox' ? 'From' : 'To'}: {counterpartId}</p>
                )}

                {/* ë‚´ìš© ë¯¸ë¦¬ë³´ê¸° */}
                <p>{truncate(m.content, 120)}</p>

                {/* ì½ìŒ ë°°ì§€ */}
                {isUnread ? (
                    <span>UNREAD</span>
                ) : (
                    <span>READ</span>
                )}
            </button>
        </motion.div>
    )
})}
```

**Modeë³„ í‘œì‹œ ì˜ˆì œ:**

**Inbox mode (ë°›ì€ ìª½ì§€í•¨):**
```
From: 100
ì•ˆë…•í•˜ì„¸ìš”...
[UNREAD]
```

**Sent mode (ë³´ë‚¸ ìª½ì§€í•¨):**
```
To: 200
ì•ˆë…•í•˜ì„¸ìš”...
[READ]
```

**All mode (ì „ì²´ ë©”ì‹œì§€):**
```
From: 100 â†’ To: 200
ì•ˆë…•í•˜ì„¸ìš”...
[UNREAD]
```

---

## 4. ë°ì´í„° íë¦„

### 4.1 ë©”ì‹œì§€ ì „ì†¡ í”Œë¡œìš°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MessageCompose  â”‚
â”‚  ì‚¬ìš©ì ì…ë ¥    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ handleSubmit()
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ sendMutation    â”‚
â”‚  (React Query)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ mutate({ senderId, receiverId, content })
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ messageService  â”‚
â”‚  .sendMessage() â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ POST /api/messages
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Gateway    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ ë¼ìš°íŒ…
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ message-service â”‚
â”‚  (ë°±ì—”ë“œ)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ DB ì €ì¥ + Kafka ì´ë²¤íŠ¸ ë°œí–‰
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ì‘ë‹µ ë°˜í™˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ 201 Created
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  onSuccess()    â”‚
â”‚  navigate()     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 ë©”ì‹œì§€ ì¡°íšŒ í”Œë¡œìš°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Inbox       â”‚
â”‚  ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    useQuery     â”‚
â”‚  ì‹¤í–‰ ì¡°ê±´ í™•ì¸  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ enabled: !!receiverId
         â–¼
    [ìºì‹œ í™•ì¸]
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚         â”‚
  ìˆìŒ       ì—†ìŒ
    â”‚         â”‚
    â–¼         â–¼
 ìºì‹œ ë°˜í™˜   API í˜¸ì¶œ
    â”‚         â”‚
    â”‚    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚    â”‚ GET     â”‚
    â”‚    â”‚ /inbox  â”‚
    â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
    â”‚         â”‚
    â”‚         â–¼
    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚    â”‚ ë°±ì—”ë“œ  â”‚
    â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
    â”‚         â”‚
    â”‚         â–¼
    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚    â”‚ DB ì¡°íšŒ â”‚
    â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
    â”‚         â”‚
    â”‚         â–¼
    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚    â”‚ ì‘ë‹µ    â”‚
    â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
    â”‚         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â–º
              â”‚
              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ ìºì‹œ ì €ì¥â”‚
        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ data ì„¤ì •â”‚
        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ í™”ë©´ ë Œë”â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 ì‚­ì œ í”Œë¡œìš°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MessageList    â”‚
â”‚  íœ´ì§€í†µ í´ë¦­    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ onClick={(e) => onDelete(messageId, e)}
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  handleDelete   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ e.stopPropagation()  â† ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ window.confirm  â”‚
â”‚   "ì‚­ì œ?"       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ í™•ì¸ í´ë¦­
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ deleteMutation  â”‚
â”‚   .mutate()     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ DELETE /messages/{id}
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ë°±ì—”ë“œ ì‚­ì œ    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ 204 No Content
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   onSuccess()   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ queryClient.invalidateQueries()
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ìºì‹œ ë¬´íš¨í™”    â”‚
â”‚  - inbox        â”‚
â”‚  - sent         â”‚
â”‚  - all          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ìë™ ì¬ì¡°íšŒ    â”‚
â”‚  (refetch)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  í™”ë©´ ì—…ë°ì´íŠ¸  â”‚
â”‚  (ë©”ì‹œì§€ ì œê±°)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. ìƒíƒœ ê´€ë¦¬

### 5.1 ìƒíƒœì˜ ì¢…ë¥˜

#### ì„œë²„ ìƒíƒœ (React Query)
```javascript
// âœ… ì„œë²„ì—ì„œ ê°€ì ¸ì˜¨ ë°ì´í„°
const { data: messages } = useQuery({
    queryKey: ['messages', 'inbox', receiverId],
    queryFn: () => messageService.getInbox(receiverId),
})
```

**íŠ¹ì§•:**
- ë¹„ë™ê¸°ì 
- ìºì‹± í•„ìš”
- ìë™ ê°±ì‹  í•„ìš”
- ì—¬ëŸ¬ ì»´í¬ë„ŒíŠ¸ì—ì„œ ê³µìœ 

#### ë¡œì»¬ ìƒíƒœ (useState)
```javascript
// âœ… UI ìƒíƒœ
const [searchKeyword, setSearchKeyword] = useState('')
const [onlyUnread, setOnlyUnread] = useState(false)
```

**íŠ¹ì§•:**
- ë™ê¸°ì 
- ì»´í¬ë„ŒíŠ¸ ë‚´ë¶€ì—ì„œë§Œ ì‚¬ìš©
- í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì‹œ ì´ˆê¸°í™”

#### ì „ì—­ ìƒíƒœ (Zustand)
```javascript
// âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ ì „ì—­ ìƒíƒœ
const { user, token } = useAuthStore()
```

**íŠ¹ì§•:**
- ëª¨ë“  ì»´í¬ë„ŒíŠ¸ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥
- ë¡œê·¸ì¸ ì •ë³´ ë“± ê³µìœ  í•„ìš”í•œ ë°ì´í„°

### 5.2 ìƒíƒœ ì—…ë°ì´íŠ¸ íŒ¨í„´

#### Optimistic Update (ë‚™ê´€ì  ì—…ë°ì´íŠ¸)
```javascript
// ì˜ˆ: ì¢‹ì•„ìš” ë²„íŠ¼
const likeMutation = useMutation({
    mutationFn: likeMessage,
    onMutate: async (messageId) => {
        // 1. ê¸°ì¡´ ìºì‹œ ì €ì¥
        const previous = queryClient.getQueryData(['message', messageId])
        
        // 2. ì¦‰ì‹œ UI ì—…ë°ì´íŠ¸ (API ì‘ë‹µ ì „)
        queryClient.setQueryData(['message', messageId], (old) => ({
            ...old,
            liked: true
        }))
        
        return { previous }
    },
    onError: (err, messageId, context) => {
        // 3. ì‹¤íŒ¨ ì‹œ ë¡¤ë°±
        queryClient.setQueryData(['message', messageId], context.previous)
    },
})
```

#### Pessimistic Update (ë¹„ê´€ì  ì—…ë°ì´íŠ¸) âœ… í˜„ì¬ ì‚¬ìš©
```javascript
// ì˜ˆ: ì‚­ì œ
const deleteMutation = useMutation({
    mutationFn: deleteMessage,
    onSuccess: () => {
        // API ì„±ê³µ í›„ì—ë§Œ UI ì—…ë°ì´íŠ¸
        queryClient.invalidateQueries(['messages'])
    },
})
```

---

## 6. API í†µì‹ 

### 6.1 axios ì¸ìŠ¤í„´ìŠ¤ ì„¤ì •

```javascript
// app/api.js
import axios from 'axios'

const api = axios.create({
    baseURL: 'http://localhost:8080/api',  // API Gateway URL
    timeout: 10000,
    headers: {
        'Content-Type': 'application/json',
    },
})

// ìš”ì²­ ì¸í„°ì…‰í„° (í† í° ìë™ ì¶”ê°€)
api.interceptors.request.use((config) => {
    const token = localStorage.getItem('token')
    if (token) {
        config.headers.Authorization = `Bearer ${token}`
    }
    return config
})

// ì‘ë‹µ ì¸í„°ì…‰í„° (ì—ëŸ¬ ì²˜ë¦¬)
api.interceptors.response.use(
    (response) => response,
    (error) => {
        if (error.response?.status === 401) {
            // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
            localStorage.removeItem('token')
            window.location.href = '/login'
        }
        return Promise.reject(error)
    }
)

export default api
```

### 6.2 ì—ëŸ¬ ì²˜ë¦¬ íŒ¨í„´

```javascript
const sendMutation = useMutation({
    mutationFn: sendMessage,
    onError: (error) => {
        // 1. ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬
        if (!error.response) {
            alert('ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”')
            return
        }
        
        // 2. HTTP ìƒíƒœ ì½”ë“œë³„ ì²˜ë¦¬
        switch (error.response.status) {
            case 400:
                alert('ì˜ëª»ëœ ìš”ì²­ì…ë‹ˆë‹¤')
                break
            case 401:
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤')
                navigate('/login')
                break
            case 403:
                alert('ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤')
                break
            case 404:
                alert('ë©”ì‹œì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤')
                break
            case 500:
                alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤')
                break
            default:
                alert(`ì˜¤ë¥˜: ${error.response.data?.message || error.message}`)
        }
    },
})
```

---

## 7. ì• ë‹ˆë©”ì´ì…˜

### 7.1 Framer Motion íŒ¨í„´

#### í˜ì´ë“œ ì¸ (Fade In)
```jsx
<motion.div
    initial={{ opacity: 0 }}
    animate={{ opacity: 1 }}
    transition={{ duration: 0.5 }}
>
    Content
</motion.div>
```

#### ìŠ¬ë¼ì´ë“œ ì—… (Slide Up)
```jsx
<motion.div
    initial={{ opacity: 0, y: 20 }}    // ì•„ë˜ì—ì„œ ì‹œì‘
    animate={{ opacity: 1, y: 0 }}     // ì œìë¦¬ë¡œ
    transition={{ duration: 0.5 }}
>
    Content
</motion.div>
```

#### ìŠ¤íƒœê±° ì• ë‹ˆë©”ì´ì…˜ (Stagger)
```jsx
// ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œë“¤ì´ ìˆœì°¨ì ìœ¼ë¡œ ë‚˜íƒ€ë‚¨
{messages.map((msg, index) => (
    <motion.div
        key={msg.id}
        initial={{ opacity: 0, y: 10 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ 
            duration: 0.3,
            delay: index * 0.1  // ê° ì•„ì´í…œë§ˆë‹¤ 0.1ì´ˆì”© ì§€ì—°
        }}
    >
        {msg.content}
    </motion.div>
))}
```

#### í˜¸ë²„/íƒ­ íš¨ê³¼
```jsx
<motion.button
    whileHover={{ scale: 1.05 }}       // ë§ˆìš°ìŠ¤ ì˜¬ë¦¬ë©´ 5% í™•ëŒ€
    whileTap={{ scale: 0.95 }}         // í´ë¦­í•˜ë©´ 5% ì¶•ì†Œ
>
    Click Me
</motion.button>
```

---

## 8. ì‹¤ì „ ì‹œë‚˜ë¦¬ì˜¤

### 8.1 ì‹œë‚˜ë¦¬ì˜¤ 1: ë©”ì‹œì§€ ë³´ë‚´ê¸°

```
1. ì‚¬ìš©ìê°€ "/messages/compose" ì ‘ì†
   â†“
2. MessageCompose ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸
   â†“
3. useAuthStoreì—ì„œ user ì •ë³´ í™•ì¸
   â†“
4. ì‚¬ìš©ìê°€ í¼ ì‘ì„±:
   - receiverId: 2
   - content: "ì•ˆë…•í•˜ì„¸ìš”"
   â†“
5. "ì „ì†¡" ë²„íŠ¼ í´ë¦­
   â†“
6. handleSubmit() ì‹¤í–‰:
   - e.preventDefault()
   - ë¡œê·¸ì¸ ì²´í¬
   - ì…ë ¥ê°’ ê²€ì¦
   â†“
7. sendMutation.mutate({
      senderId: 1,
      receiverId: 2,
      content: "ì•ˆë…•í•˜ì„¸ìš”"
   })
   â†“
8. messageService.sendMessage() í˜¸ì¶œ
   â†“
9. POST /api/messages ìš”ì²­
   Headers: { Authorization: "Bearer ..." }
   Body: { senderId: 1, receiverId: 2, content: "ì•ˆë…•í•˜ì„¸ìš”" }
   â†“
10. API Gateway â†’ message-service ë¼ìš°íŒ…
    â†“
11. MessageController.create() ì‹¤í–‰
    â†“
12. MessageService.create() ì‹¤í–‰
    - Entity ìƒì„±
    - DB ì €ì¥
    - Kafka ì´ë²¤íŠ¸ ë°œí–‰
    â†“
13. 201 Created ì‘ë‹µ
    Body: { id: 100, senderId: 1, receiverId: 2, ... }
    â†“
14. onSuccess() ì‹¤í–‰
    â†“
15. navigate('/messages/sent')
    â†“
16. Sent í˜ì´ì§€ë¡œ ì´ë™
    â†“
17. useQueryë¡œ ë³´ë‚¸ ë©”ì‹œì§€ ëª©ë¡ ì¡°íšŒ
    â†“
18. ë°©ê¸ˆ ë³´ë‚¸ ë©”ì‹œì§€ê°€ ëª©ë¡ì— í‘œì‹œë¨
```

### 8.2 ì‹œë‚˜ë¦¬ì˜¤ 2: ë©”ì‹œì§€ ì½ê¸°

```
1. ì‚¬ìš©ì Bê°€ "/messages/inbox" ì ‘ì†
   â†“
2. Inbox ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸
   â†“
3. useQuery ì‹¤í–‰:
   queryKey: ['messages', 'inbox', 2]
   queryFn: () => messageService.getInbox(2)
   â†“
4. ìºì‹œ í™•ì¸ â†’ ì—†ìŒ â†’ API í˜¸ì¶œ
   â†“
5. GET /api/messages/inbox/2
   â†“
6. ë°±ì—”ë“œì—ì„œ ë°ì´í„° ì¡°íšŒ:
   SELECT * FROM messages 
   WHERE receiver_id = 2 AND is_read = false
   ORDER BY created_at DESC
   â†“
7. ì‘ë‹µ:
   [
     { id: 100, senderId: 1, content: "ì•ˆë…•í•˜ì„¸ìš”", read: false },
     { id: 99, senderId: 3, content: "ë°˜ê°‘ìŠµë‹ˆë‹¤", read: false }
   ]
   â†“
8. React Queryê°€ ìºì‹œì— ì €ì¥
   â†“
9. data ì—…ë°ì´íŠ¸ â†’ í™”ë©´ ë Œë”ë§
   â†“
10. ì‚¬ìš©ìê°€ ë©”ì‹œì§€ 100ë²ˆ í´ë¦­
    â†“
11. handleSelect(message) ì‹¤í–‰
    â†“
12. navigate('/messages/100')
    â†“
13. MessageDetail ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸
    â†“
14. useQueryë¡œ ë©”ì‹œì§€ ìƒì„¸ ì¡°íšŒ
    â†“
15. GET /api/messages/100
    â†“
16. ë©”ì‹œì§€ í‘œì‹œ
    â†“
17. useEffect ì‹¤í–‰:
    - message.receiverId === user.id? â†’ true
    - message.read === false? â†’ true
    - markReadMutation.isPending? â†’ false
    â†“
18. markReadMutation.mutate() ì‹¤í–‰
    â†“
19. PATCH /api/messages/100/read
    â†“
20. ë°±ì—”ë“œì—ì„œ read=true ì—…ë°ì´íŠ¸
    â†“
21. onSuccess():
    - detail ìºì‹œ ì—…ë°ì´íŠ¸ (read: true)
    - inbox ìºì‹œ ë¬´íš¨í™”
    â†“
22. ë‹¤ì‹œ Inboxë¡œ ëŒì•„ê°€ë©´ ìë™ìœ¼ë¡œ ì¬ì¡°íšŒ
    â†“
23. ë©”ì‹œì§€ 100ë²ˆì´ ì½ìŒ ìƒíƒœë¡œ í‘œì‹œë¨
```

### 8.3 ì‹œë‚˜ë¦¬ì˜¤ 3: ë©”ì‹œì§€ ì‚­ì œ

```
1. ì‚¬ìš©ìê°€ Inboxì—ì„œ íœ´ì§€í†µ ë²„íŠ¼ í´ë¦­
   â†“
2. handleDelete(100, event) í˜¸ì¶œ
   â†“
3. e.stopPropagation() 
   â†’ MessageDetailë¡œ ì´ë™ ë°©ì§€
   â†“
4. window.confirm("ìª½ì§€ë¥¼ ì‚­ì œí• ê¹Œìš”?")
   â†“
5. ì‚¬ìš©ìê°€ "í™•ì¸" í´ë¦­
   â†“
6. deleteMutation.mutate(100)
   â†“
7. messageService.deleteMessage(100)
   â†“
8. DELETE /api/messages/100
   â†“
9. ë°±ì—”ë“œ:
   - Message ì¡°íšŒ
   - Kafka ì‚­ì œ ì´ë²¤íŠ¸ ë°œí–‰
   - DBì—ì„œ ì‚­ì œ
   â†“
10. 204 No Content ì‘ë‹µ
    â†“
11. onSuccess():
    - invalidateQueries(['messages', 'inbox', 2])
    - invalidateQueries(['messages', 'all'])
    â†“
12. React Queryê°€ í•´ë‹¹ ìºì‹œ ì‚­ì œ
    â†“
13. useQueryê°€ ìë™ìœ¼ë¡œ ì¬ì‹¤í–‰
    â†“
14. GET /api/messages/inbox/2 (ë‹¤ì‹œ ì¡°íšŒ)
    â†“
15. ì‚­ì œëœ ë©”ì‹œì§€ ì œì™¸ëœ ëª©ë¡ ë°˜í™˜
    â†“
16. í™”ë©´ ìë™ ì—…ë°ì´íŠ¸
    â†“
17. ë©”ì‹œì§€ 100ë²ˆì´ ëª©ë¡ì—ì„œ ì‚¬ë¼ì§
```

---

## 9. í•µì‹¬ ê°œë… ìš”ì•½

### 9.1 React Queryì˜ 3ê°€ì§€ í•µì‹¬

1. **ìºì‹±**: ê°™ì€ ë°ì´í„° ì¬ìš”ì²­ ì‹œ ìºì‹œ í™œìš©
2. **ìë™ ê°±ì‹ **: staleTime ì§€ë‚œ ë°ì´í„° ë°±ê·¸ë¼ìš´ë“œ ê°±ì‹ 
3. **ë¬´íš¨í™”**: invalidateQueries()ë¡œ ìºì‹œ ì‚­ì œ í›„ ì¬ì¡°íšŒ

### 9.2 ì»´í¬ë„ŒíŠ¸ í†µì‹  íŒ¨í„´

```javascript
// 1. Propsë¡œ ì „ë‹¬
<MessageList onSelect={handleSelect} onDelete={handleDelete} />

// 2. React Routerë¡œ ë°ì´í„° ì „ë‹¬
navigate('/compose', { state: { receiverId: 100 } })

// 3. URL íŒŒë¼ë¯¸í„°
navigate('/messages/100')  // useParamsë¡œ id ì¶”ì¶œ

// 4. ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°
navigate('/compose?to=100')  // useSearchParamsë¡œ ì¶”ì¶œ

// 5. ì „ì—­ ìƒíƒœ
const { user } = useAuthStore()  // Zustand
```

### 9.3 ì„±ëŠ¥ ìµœì í™”

```javascript
// 1. useMemo - ë¶ˆí•„ìš”í•œ ì¬ê³„ì‚° ë°©ì§€
const filtered = useMemo(() => {
    return messages.filter(...)
}, [messages, searchKeyword])

// 2. React Query ìºì‹±
staleTime: 15000  // 15ì´ˆê°„ ì¬ì¡°íšŒ ì•ˆ í•¨

// 3. ì¡°ê±´ë¶€ ì¿¼ë¦¬ ì‹¤í–‰
enabled: !!receiverId  // receiverId ìˆì„ ë•Œë§Œ ì‹¤í–‰

// 4. ì½ê¸° ì „ìš© íŠ¸ëœì­ì…˜ (ë°±ì—”ë“œ)
@Transactional(readOnly = true)
```

---

## 10. ë””ë²„ê¹… íŒ

### 10.1 React Query DevTools

```jsx
import { ReactQueryDevtools } from '@tanstack/react-query-devtools'

<QueryClientProvider client={queryClient}>
    <App />
    <ReactQueryDevtools initialIsOpen={false} />
</QueryClientProvider>
```

**í™•ì¸í•  ìˆ˜ ìˆëŠ” ê²ƒ:**
- ëª¨ë“  ì¿¼ë¦¬ ìƒíƒœ (fresh, fetching, stale, inactive)
- ìºì‹œ ë°ì´í„°
- ì¿¼ë¦¬ í‚¤

### 10.2 ì½˜ì†” ë¡œê¹…

```javascript
useEffect(() => {
    console.log('ğŸ” [Inbox] messages:', messages)
    console.log('ğŸ” [Inbox] filtered:', filtered)
    console.log('ğŸ” [Inbox] isLoading:', isLoading)
}, [messages, filtered, isLoading])
```

### 10.3 Network íƒ­ í™•ì¸

**Chrome DevTools â†’ Network**
- API ìš”ì²­ í™•ì¸
- Request Headers (Authorization)
- Response Body
- HTTP ìƒíƒœ ì½”ë“œ

---

ì´ ê°€ì´ë“œëŠ” message í”„ë¡ íŠ¸ì—”ë“œì˜ ëª¨ë“  ë¡œì§ì„ ë‹¨ê³„ë³„ë¡œ ì„¤ëª…í•©ë‹ˆë‹¤. ì‹¤ì œ ì½”ë“œì™€ í•¨ê»˜ ë³´ë©´ì„œ í•™ìŠµí•˜ì„¸ìš”! ğŸš€
