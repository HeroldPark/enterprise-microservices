# JPA (Java Persistence API) ì™„ì „ ê°€ì´ë“œ
## message-serviceë¥¼ ì˜ˆì œë¡œ ë°°ìš°ëŠ” JPA

---

## ğŸ“š ëª©ì°¨

1. [JPAë€ ë¬´ì—‡ì¸ê°€?](#1-jpaë€-ë¬´ì—‡ì¸ê°€)
2. [Entity í´ë˜ìŠ¤](#2-entity-í´ë˜ìŠ¤)
3. [Repository ì¸í„°í˜ì´ìŠ¤](#3-repository-ì¸í„°í˜ì´ìŠ¤)
4. [Query Methods](#4-query-methods)
5. [Transaction ê´€ë¦¬](#5-transaction-ê´€ë¦¬)
6. [ì„±ëŠ¥ ìµœì í™”](#6-ì„±ëŠ¥-ìµœì í™”)
7. [ì‹¤ì „ ì˜ˆì œ](#7-ì‹¤ì „-ì˜ˆì œ)

---

## 1. JPAë€ ë¬´ì—‡ì¸ê°€?

### 1.1 ê°œë…

**JPA (Java Persistence API)**ëŠ” ìë°” ê°ì²´ì™€ ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë§¤í•‘í•˜ëŠ” í‘œì¤€ ORM ê¸°ìˆ ì…ë‹ˆë‹¤.

```
Java Object (Entity)  â†â†’  JPA  â†â†’  Database Table
     Message                           messages
```

### 1.2 ì™œ JPAë¥¼ ì‚¬ìš©í•˜ëŠ”ê°€?

#### âŒ JPA ì—†ì´ (ìˆœìˆ˜ JDBC)
```java
// ë³µì¡í•œ SQL ì‘ì„±
String sql = "INSERT INTO messages (sender_id, receiver_id, content, is_read, created_at) VALUES (?, ?, ?, ?, ?)";

// PreparedStatement ìƒì„±
PreparedStatement pstmt = connection.prepareStatement(sql);
pstmt.setLong(1, message.getSenderId());
pstmt.setLong(2, message.getReceiverId());
pstmt.setString(3, message.getContent());
pstmt.setBoolean(4, false);
pstmt.setTimestamp(5, Timestamp.valueOf(LocalDateTime.now()));

// ì‹¤í–‰
pstmt.executeUpdate();

// ResultSet ì²˜ë¦¬
ResultSet rs = pstmt.executeQuery("SELECT * FROM messages WHERE id = ?");
Message message = new Message();
if (rs.next()) {
    message.setId(rs.getLong("id"));
    message.setSenderId(rs.getLong("sender_id"));
    // ... ë°˜ë³µì ì¸ ë§¤í•‘ ì½”ë“œ
}
```

#### âœ… JPA ì‚¬ìš©
```java
// ê°„ë‹¨í•œ ê°ì²´ ì €ì¥
messageRepository.save(message);

// ê°„ë‹¨í•œ ì¡°íšŒ
Message message = messageRepository.findById(1L).orElse(null);
```

---

## 2. Entity í´ë˜ìŠ¤

### 2.1 ê¸°ë³¸ êµ¬ì¡°

```java
@Entity                    // â‘  JPA Entityì„ì„ ì„ ì–¸
@Table(name = "messages")  // â‘¡ í…Œì´ë¸” ì´ë¦„ ì§€ì •
@Getter                    // â‘¢ Lombok: getter ìë™ ìƒì„±
@Setter                    // â‘£ Lombok: setter ìë™ ìƒì„±
@NoArgsConstructor         // â‘¤ Lombok: ê¸°ë³¸ ìƒì„±ì ìë™ ìƒì„±
public class Message {
    // í•„ë“œ ì •ì˜
}
```

### 2.2 ì£¼ìš” ì• ë…¸í…Œì´ì…˜ ìƒì„¸ ë¶„ì„

#### ğŸ“Œ `@Entity`
```java
@Entity  // ì´ í´ë˜ìŠ¤ê°€ JPA Entityì„ì„ ì„ ì–¸
public class Message {
    // ...
}
```
- JPAê°€ ê´€ë¦¬í•˜ëŠ” í´ë˜ìŠ¤
- ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸”ê³¼ ë§¤í•‘ë¨
- ë°˜ë“œì‹œ ê¸°ë³¸ ìƒì„±ì(no-args constructor) í•„ìš”

#### ğŸ“Œ `@Table`
```java
@Table(
    name = "messages",  // í…Œì´ë¸” ì´ë¦„
    indexes = {         // ì¸ë±ìŠ¤ ì •ì˜
        @Index(name = "idx_messages_receiver_created", 
               columnList = "receiverId, createdAt"),
        @Index(name = "idx_messages_sender_created", 
               columnList = "senderId, createdAt")
    }
)
```

**ì¸ë±ìŠ¤ì˜ ì—­í• :**
```sql
-- ì¸ë±ìŠ¤ê°€ ì—†ì„ ë•Œ (SLOW)
SELECT * FROM messages WHERE receiver_id = 2;
-- â†’ ì „ì²´ í…Œì´ë¸” ìŠ¤ìº” (1,000,000ê°œ í–‰ ëª¨ë‘ í™•ì¸)

-- ì¸ë±ìŠ¤ê°€ ìˆì„ ë•Œ (FAST)
SELECT * FROM messages WHERE receiver_id = 2;
-- â†’ ì¸ë±ìŠ¤ë¥¼ í†µí•´ ë°”ë¡œ ì°¾ìŒ (100ê°œ í–‰ë§Œ í™•ì¸)
```

#### ğŸ“Œ `@Id` + `@GeneratedValue`
```java
@Id                                          // Primary Key
@GeneratedValue(strategy = GenerationType.IDENTITY)  // ìë™ ì¦ê°€
private Long id;
```

**ID ìƒì„± ì „ëµ:**

| ì „ëµ | ì„¤ëª… | ì˜ˆì‹œ |
|------|------|------|
| `IDENTITY` | ë°ì´í„°ë² ì´ìŠ¤ê°€ ìë™ ìƒì„± (AUTO_INCREMENT) | MySQL, PostgreSQL |
| `SEQUENCE` | ì‹œí€€ìŠ¤ ì‚¬ìš© | Oracle, PostgreSQL |
| `TABLE` | ë³„ë„ í…Œì´ë¸” ì‚¬ìš© | ëª¨ë“  DB |
| `AUTO` | JPAê°€ ìë™ ì„ íƒ | ê¸°ë³¸ê°’ |

```java
// IDENTITY ì‚¬ìš© ì‹œ
Message message = new Message();
message.setContent("Hello");
messageRepository.save(message);
// DBê°€ ìë™ìœ¼ë¡œ ID ìƒì„±: id = 1, 2, 3, ...
```

#### ğŸ“Œ `@Column`
```java
@Column(
    name = "is_read",      // â‘  ì»¬ëŸ¼ ì´ë¦„ (ì¹´ë©œì¼€ì´ìŠ¤ â†’ ìŠ¤ë„¤ì´í¬ì¼€ì´ìŠ¤)
    nullable = false,      // â‘¡ NOT NULL ì œì•½ì¡°ê±´
    length = 500,          // â‘¢ VARCHAR(500)
    unique = false,        // â‘£ UNIQUE ì œì•½ì¡°ê±´
    updatable = true,      // â‘¤ UPDATE ê°€ëŠ¥ ì—¬ë¶€
    insertable = true      // â‘¥ INSERT ê°€ëŠ¥ ì—¬ë¶€
)
private String content;
```

**ì‹¤ì œ ìƒì„±ë˜ëŠ” SQL:**
```sql
CREATE TABLE messages (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    sender_id BIGINT NOT NULL,
    receiver_id BIGINT NOT NULL,
    content VARCHAR(500) NOT NULL,
    is_read BOOLEAN NOT NULL,
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL
);
```

#### ğŸ“Œ `@CreationTimestamp` / `@UpdateTimestamp`
```java
@CreationTimestamp
@Column(nullable = false, updatable = false)
private LocalDateTime createdAt;  // ìƒì„± ì‹œ ìë™ ì„¤ì •

@UpdateTimestamp
@Column(nullable = false)
private LocalDateTime updatedAt;  // ìˆ˜ì • ì‹œë§ˆë‹¤ ìë™ ì—…ë°ì´íŠ¸
```

**ë™ì‘ ë°©ì‹:**
```java
Message message = new Message();
message.setContent("Hello");
messageRepository.save(message);

// ìë™ìœ¼ë¡œ ì„¤ì •ë¨:
// createdAt = 2024-01-15 10:30:00
// updatedAt = 2024-01-15 10:30:00

// ìˆ˜ì • ì‹œ
message.setContent("Hi");
messageRepository.save(message);

// updatedAtë§Œ ì—…ë°ì´íŠ¸:
// createdAt = 2024-01-15 10:30:00 (ë³€ê²½ ì—†ìŒ)
// updatedAt = 2024-01-15 10:35:00 (ì—…ë°ì´íŠ¸ë¨)
```

### 2.3 ì „ì²´ Entity ì½”ë“œ ë¶„ì„

```java
@Entity
@Table(name = "messages", indexes = {
    // ì¡°íšŒ ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•œ ë³µí•© ì¸ë±ìŠ¤
    @Index(name = "idx_messages_receiver_created", 
           columnList = "receiverId, createdAt"),
    @Index(name = "idx_messages_sender_created", 
           columnList = "senderId, createdAt")
})
@Getter
@Setter
@NoArgsConstructor
public class Message {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(nullable = false)
    private Long senderId;      // ë³´ë‚¸ ì‚¬ëŒ

    @Column(nullable = false)
    private Long receiverId;    // ë°›ëŠ” ì‚¬ëŒ

    @Column(nullable = false, length = 500)
    private String content;     // ë©”ì‹œì§€ ë‚´ìš©

    @Column(name = "is_read", nullable = false)
    private boolean isRead;     // ì½ìŒ ì—¬ë¶€

    @CreationTimestamp
    @Column(nullable = false, updatable = false)
    private LocalDateTime createdAt;  // ìƒì„±ì¼ì‹œ

    @UpdateTimestamp
    @Column(nullable = false)
    private LocalDateTime updatedAt;  // ìˆ˜ì •ì¼ì‹œ
}
```

---

## 3. Repository ì¸í„°í˜ì´ìŠ¤

### 3.1 JpaRepositoryë€?

```java
public interface MessageRepository extends JpaRepository<Message, Long> {
    // â‘  Message: Entity íƒ€ì…
    // â‘¡ Long: Primary Key íƒ€ì…
}
```

### 3.2 ì œê³µë˜ëŠ” ê¸°ë³¸ ë©”ì„œë“œ

```java
// === ì €ì¥ ===
Message saved = messageRepository.save(message);           // INSERT or UPDATE
List<Message> savedAll = messageRepository.saveAll(list);  // ì—¬ëŸ¬ ê°œ ì €ì¥

// === ì¡°íšŒ ===
Optional<Message> msg = messageRepository.findById(1L);    // IDë¡œ ì¡°íšŒ
List<Message> all = messageRepository.findAll();           // ì „ì²´ ì¡°íšŒ
long count = messageRepository.count();                    // ê°œìˆ˜ ì„¸ê¸°
boolean exists = messageRepository.existsById(1L);         // ì¡´ì¬ ì—¬ë¶€

// === ì‚­ì œ ===
messageRepository.deleteById(1L);                          // IDë¡œ ì‚­ì œ
messageRepository.delete(message);                         // ê°ì²´ë¡œ ì‚­ì œ
messageRepository.deleteAll();                             // ì „ì²´ ì‚­ì œ
```

**ì‹¤ì œ ìƒì„±ë˜ëŠ” SQL:**
```java
messageRepository.save(message);
// INSERT INTO messages (sender_id, receiver_id, content, is_read, created_at, updated_at) 
// VALUES (1, 2, 'Hello', false, '2024-01-15 10:30:00', '2024-01-15 10:30:00')

messageRepository.findById(1L);
// SELECT * FROM messages WHERE id = 1

messageRepository.deleteById(1L);
// DELETE FROM messages WHERE id = 1
```

---

## 4. Query Methods

### 4.1 ë©”ì„œë“œ ì´ë¦„ìœ¼ë¡œ ì¿¼ë¦¬ ìë™ ìƒì„±

JPAëŠ” **ë©”ì„œë“œ ì´ë¦„ì˜ ê·œì¹™**ì— ë”°ë¼ ìë™ìœ¼ë¡œ SQLì„ ìƒì„±í•©ë‹ˆë‹¤.

#### ğŸ“Œ ê¸°ë³¸ íŒ¨í„´
```
findBy + í•„ë“œëª… + ì¡°ê±´ + OrderBy + ì •ë ¬í•„ë“œ + ì •ë ¬ë°©í–¥
```

### 4.2 ì‹¤ì „ ì˜ˆì œ

#### ì˜ˆì œ 1: ë°›ì€ ì‚¬ëŒìœ¼ë¡œ ì¡°íšŒ + ì½ì§€ ì•Šì€ ë©”ì‹œì§€ë§Œ + ìµœì‹ ìˆœ ì •ë ¬
```java
List<Message> findByReceiverIdAndIsReadFalseOrderByCreatedAtDesc(Long receiverId);
```

**ë¶„í•´:**
- `findBy`: ì¡°íšŒ ì¿¼ë¦¬
- `ReceiverId`: receiverId í•„ë“œ
- `And`: AND ì¡°ê±´
- `IsReadFalse`: isRead = false
- `OrderBy`: ì •ë ¬
- `CreatedAt`: createdAt í•„ë“œë¡œ
- `Desc`: ë‚´ë¦¼ì°¨ìˆœ

**ìƒì„±ë˜ëŠ” SQL:**
```sql
SELECT * FROM messages 
WHERE receiver_id = ? 
  AND is_read = false 
ORDER BY created_at DESC
```

**ì‚¬ìš© ì˜ˆ:**
```java
List<Message> unreadMessages = messageRepository
    .findByReceiverIdAndIsReadFalseOrderByCreatedAtDesc(2L);

// ê²°ê³¼: receiverId=2ì¸ ì•ˆ ì½ì€ ë©”ì‹œì§€ë“¤ì„ ìµœì‹ ìˆœìœ¼ë¡œ ë°˜í™˜
```

#### ì˜ˆì œ 2: ë³´ë‚¸ ì‚¬ëŒìœ¼ë¡œ ì¡°íšŒ + ìµœì‹ ìˆœ ì •ë ¬
```java
List<Message> findBySenderIdOrderByCreatedAtDesc(Long senderId);
```

**ìƒì„±ë˜ëŠ” SQL:**
```sql
SELECT * FROM messages 
WHERE sender_id = ? 
ORDER BY created_at DESC
```

#### ì˜ˆì œ 3: ì „ì²´ ì¡°íšŒ + ìµœì‹ ìˆœ ì •ë ¬
```java
List<Message> findAllByOrderByCreatedAtDesc();
```

**ìƒì„±ë˜ëŠ” SQL:**
```sql
SELECT * FROM messages 
ORDER BY created_at DESC
```

### 4.3 Query Method í‚¤ì›Œë“œ ì´ì •ë¦¬

| í‚¤ì›Œë“œ | ì˜ˆì œ | SQL |
|--------|------|-----|
| `And` | `findByNameAndAge` | `WHERE name = ? AND age = ?` |
| `Or` | `findByNameOrAge` | `WHERE name = ? OR age = ?` |
| `Is`, `Equals` | `findByNameIs` | `WHERE name = ?` |
| `Between` | `findByAgeBetween` | `WHERE age BETWEEN ? AND ?` |
| `LessThan` | `findByAgeLessThan` | `WHERE age < ?` |
| `LessThanEqual` | `findByAgeLessThanEqual` | `WHERE age <= ?` |
| `GreaterThan` | `findByAgeGreaterThan` | `WHERE age > ?` |
| `GreaterThanEqual` | `findByAgeGreaterThanEqual` | `WHERE age >= ?` |
| `After` | `findByDateAfter` | `WHERE date > ?` |
| `Before` | `findByDateBefore` | `WHERE date < ?` |
| `IsNull` | `findByNameIsNull` | `WHERE name IS NULL` |
| `IsNotNull` | `findByNameIsNotNull` | `WHERE name IS NOT NULL` |
| `Like` | `findByNameLike` | `WHERE name LIKE ?` |
| `NotLike` | `findByNameNotLike` | `WHERE name NOT LIKE ?` |
| `StartingWith` | `findByNameStartingWith` | `WHERE name LIKE 'value%'` |
| `EndingWith` | `findByNameEndingWith` | `WHERE name LIKE '%value'` |
| `Containing` | `findByNameContaining` | `WHERE name LIKE '%value%'` |
| `OrderBy` | `findByAgeOrderByNameDesc` | `ORDER BY name DESC` |
| `Not` | `findByAgeNot` | `WHERE age <> ?` |
| `In` | `findByAgeIn(List)` | `WHERE age IN (?)` |
| `NotIn` | `findByAgeNotIn(List)` | `WHERE age NOT IN (?)` |
| `True` | `findByActiveTrue` | `WHERE active = true` |
| `False` | `findByActiveFalse` | `WHERE active = false` |
| `IgnoreCase` | `findByNameIgnoreCase` | `WHERE UPPER(name) = UPPER(?)` |

### 4.4 ë³µì¡í•œ ì¿¼ë¦¬ ì˜ˆì œ

```java
// 1. íŠ¹ì • ê¸°ê°„ + ì½ì§€ ì•Šì€ ë©”ì‹œì§€
List<Message> findByReceiverIdAndIsReadFalseAndCreatedAtBetween(
    Long receiverId, 
    LocalDateTime start, 
    LocalDateTime end
);
// SQL: WHERE receiver_id = ? AND is_read = false AND created_at BETWEEN ? AND ?

// 2. ë‚´ìš©ì— íŠ¹ì • í‚¤ì›Œë“œ í¬í•¨
List<Message> findByContentContaining(String keyword);
// SQL: WHERE content LIKE '%keyword%'

// 3. ì—¬ëŸ¬ ìˆ˜ì‹ ì
List<Message> findByReceiverIdIn(List<Long> receiverIds);
// SQL: WHERE receiver_id IN (1, 2, 3, ...)

// 4. Top N ì¡°íšŒ
List<Message> findTop10ByReceiverIdOrderByCreatedAtDesc(Long receiverId);
// SQL: SELECT * FROM messages WHERE receiver_id = ? ORDER BY created_at DESC LIMIT 10

// 5. ì¡´ì¬ ì—¬ë¶€ í™•ì¸
boolean existsByReceiverIdAndIsReadFalse(Long receiverId);
// SQL: SELECT COUNT(*) > 0 FROM messages WHERE receiver_id = ? AND is_read = false

// 6. ê°œìˆ˜ ì„¸ê¸°
long countByReceiverId(Long receiverId);
// SQL: SELECT COUNT(*) FROM messages WHERE receiver_id = ?
```

### 4.5 @Query ì• ë…¸í…Œì´ì…˜ (ì§ì ‘ SQL ì‘ì„±)

ë³µì¡í•œ ì¿¼ë¦¬ëŠ” ì§ì ‘ ì‘ì„±:

```java
@Query("SELECT m FROM Message m WHERE m.receiverId = :receiverId AND m.isRead = false")
List<Message> findUnreadMessages(@Param("receiverId") Long receiverId);

// Native SQL ì‚¬ìš©
@Query(value = "SELECT * FROM messages WHERE receiver_id = ? AND is_read = false", 
       nativeQuery = true)
List<Message> findUnreadMessagesNative(Long receiverId);
```

---

## 5. Transaction ê´€ë¦¬

### 5.1 `@Transactional` ì´í•´í•˜ê¸°

```java
@Service
@RequiredArgsConstructor
public class MessageService {

    private final MessageRepository messageRepository;

    @Transactional  // â† ì´ ë©”ì„œë“œëŠ” í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì‹¤í–‰
    public MessageResponseDto create(MessageCreateRequestDto dto) {
        Message message = new Message();
        message.setSenderId(dto.getSenderId());
        message.setReceiverId(dto.getReceiverId());
        message.setContent(dto.getContent());

        Message saved = messageRepository.save(message);
        
        // ì´ë²¤íŠ¸ ë°œí–‰ ë“± ì¶”ê°€ ì‘ì—…
        
        return toDto(saved);
    }
}
```

### 5.2 Transactionì˜ ACID ì›ì¹™

#### **A**tomicity (ì›ìì„±)
```java
@Transactional
public void transferMessage() {
    messageRepository.save(message1);  // â‘  ì„±ê³µ
    messageRepository.save(message2);  // â‘¡ ì‹¤íŒ¨
    
    // â‘¡ ì‹¤íŒ¨ ì‹œ â‘ ë„ ë¡¤ë°± (ëª¨ë‘ ì„±ê³µ ë˜ëŠ” ëª¨ë‘ ì‹¤íŒ¨)
}
```

#### **C**onsistency (ì¼ê´€ì„±)
```java
@Transactional
public void deleteMessage(Long id) {
    messageRepository.deleteById(id);  // ë©”ì‹œì§€ ì‚­ì œ
    // ì—°ê´€ëœ ì•Œë¦¼, ë¡œê·¸ ë“±ë„ í•¨ê»˜ ì²˜ë¦¬ â†’ ë°ì´í„° ì¼ê´€ì„± ìœ ì§€
}
```

#### **I**solation (ê²©ë¦¬ì„±)
```java
// íŠ¸ëœì­ì…˜ A
@Transactional
public void updateMessage1() {
    Message msg = messageRepository.findById(1L).get();
    msg.setContent("Updated");
}

// íŠ¸ëœì­ì…˜ B (ë™ì‹œ ì‹¤í–‰)
@Transactional
public void updateMessage2() {
    Message msg = messageRepository.findById(1L).get();
    // Aì˜ ë³€ê²½ì‚¬í•­ì€ Aê°€ ì»¤ë°‹ë˜ê¸° ì „ê¹Œì§€ ë³´ì´ì§€ ì•ŠìŒ
}
```

#### **D**urability (ì§€ì†ì„±)
```java
@Transactional
public void saveMessage() {
    messageRepository.save(message);
    // ì»¤ë°‹ í›„ ì‹œìŠ¤í…œì´ ë‹¤ìš´ë˜ì–´ë„ ë°ì´í„°ëŠ” ì˜êµ¬ ì €ì¥ë¨
}
```

### 5.3 `@Transactional` ì˜µì…˜

```java
@Transactional(
    readOnly = true,          // ì½ê¸° ì „ìš© (ì„±ëŠ¥ ìµœì í™”)
    timeout = 5,              // 5ì´ˆ íƒ€ì„ì•„ì›ƒ
    isolation = Isolation.READ_COMMITTED,  // ê²©ë¦¬ ìˆ˜ì¤€
    propagation = Propagation.REQUIRED     // ì „íŒŒ ë°©ì‹
)
public List<Message> getMessages() {
    return messageRepository.findAll();
}
```

#### readOnly = true
```java
@Transactional(readOnly = true)  // ì½ê¸° ì „ìš©
public MessageResponseDto get(Long id) {
    Message message = messageRepository.findById(id)
            .orElseThrow(() -> new ResourceNotFoundException("Message not found"));
    return toDto(message);
}
```

**ì¥ì :**
- ë³€ê²½ ê°ì§€(Dirty Checking) ë¹„í™œì„±í™” â†’ ì„±ëŠ¥ í–¥ìƒ
- ì½ê¸° ì „ìš© íŒíŠ¸ ì œê³µ â†’ ë°ì´í„°ë² ì´ìŠ¤ ìµœì í™”

---

## 6. ì„±ëŠ¥ ìµœì í™”

### 6.1 N+1 ë¬¸ì œ

#### âŒ ë¬¸ì œ ìƒí™©
```java
// ë©”ì‹œì§€ 100ê°œ ì¡°íšŒ
List<Message> messages = messageRepository.findAll();

// ê° ë©”ì‹œì§€ì˜ ë°œì‹ ì ì •ë³´ ì¡°íšŒ
for (Message msg : messages) {
    User sender = userRepository.findById(msg.getSenderId()).get();
    // 1ë²ˆì˜ ë©”ì‹œì§€ ì¡°íšŒ + 100ë²ˆì˜ ì‚¬ìš©ì ì¡°íšŒ = 101ë²ˆì˜ ì¿¼ë¦¬!
}
```

#### âœ… í•´ê²°ë°©ë²• 1: Fetch Join
```java
@Query("SELECT m FROM Message m JOIN FETCH m.sender WHERE m.receiverId = :receiverId")
List<Message> findByReceiverIdWithSender(@Param("receiverId") Long receiverId);
```

### 6.2 ì¸ë±ìŠ¤ í™œìš©

```java
@Table(indexes = {
    // receiverIdë¡œ ìì£¼ ì¡°íšŒ â†’ ì¸ë±ìŠ¤ ì¶”ê°€
    @Index(name = "idx_receiver", columnList = "receiverId"),
    
    // receiverId + createdAt ë³µí•© ì¡°íšŒ â†’ ë³µí•© ì¸ë±ìŠ¤
    @Index(name = "idx_receiver_created", columnList = "receiverId, createdAt")
})
```

**ì„±ëŠ¥ ë¹„êµ:**
```
ì¸ë±ìŠ¤ ì—†ìŒ: 1,000,000ê°œ í–‰ ìŠ¤ìº” â†’ 5ì´ˆ
ì¸ë±ìŠ¤ ìˆìŒ: 100ê°œ í–‰ë§Œ í™•ì¸ â†’ 0.01ì´ˆ
```

### 6.3 Batch Insert

```java
// âŒ í•˜ë‚˜ì”© ì €ì¥ (100ë²ˆì˜ INSERT)
for (Message msg : messages) {
    messageRepository.save(msg);
}

// âœ… ë°°ì¹˜ë¡œ ì €ì¥ (1ë²ˆì˜ Batch INSERT)
messageRepository.saveAll(messages);
```

### 6.4 DTO Projection

```java
// âŒ ì „ì²´ Entity ì¡°íšŒ (ëª¨ë“  í•„ë“œ SELECT)
List<Message> messages = messageRepository.findAll();

// âœ… í•„ìš”í•œ í•„ë“œë§Œ ì¡°íšŒ
@Query("SELECT new com.example.dto.MessageSummaryDto(m.id, m.content) FROM Message m")
List<MessageSummaryDto> findAllSummary();
```

---

## 7. ì‹¤ì „ ì˜ˆì œ

### 7.1 ë©”ì‹œì§€ ìƒì„± (Create)

```java
@Service
@RequiredArgsConstructor
public class MessageService {

    private final MessageRepository messageRepository;

    @Transactional
    public MessageResponseDto create(MessageCreateRequestDto dto) {
        // DTO â†’ Entity ë³€í™˜
        Message message = new Message();
        message.setSenderId(dto.getSenderId());
        message.setReceiverId(dto.getReceiverId());
        message.setContent(dto.getContent());
        message.setRead(false);  // ê¸°ë³¸ê°’ ì„¤ì •

        // DB ì €ì¥ (createdAt, updatedAt ìë™ ì„¤ì •)
        Message saved = messageRepository.save(message);
        
        // Entity â†’ DTO ë³€í™˜
        return toDto(saved);
    }
    
    private MessageResponseDto toDto(Message m) {
        return new MessageResponseDto(
            m.getId(),
            m.getSenderId(),
            m.getReceiverId(),
            m.getContent(),
            m.isRead(),
            m.getCreatedAt(),
            m.getUpdatedAt()
        );
    }
}
```

**ì‹¤í–‰ë˜ëŠ” SQL:**
```sql
INSERT INTO messages (sender_id, receiver_id, content, is_read, created_at, updated_at) 
VALUES (1, 2, 'Hello', false, '2024-01-15 10:30:00', '2024-01-15 10:30:00')
```

### 7.2 ë©”ì‹œì§€ ì¡°íšŒ (Read)

```java
@Transactional(readOnly = true)
public MessageResponseDto get(Long id) {
    // Optional ì²˜ë¦¬
    Message message = messageRepository.findById(id)
            .orElseThrow(() -> new ResourceNotFoundException("Message not found: " + id));
    
    return toDto(message);
}

@Transactional(readOnly = true)
public List<MessageResponseDto> inbox(Long receiverId) {
    // Query Method ì‚¬ìš©
    List<Message> messages = messageRepository
            .findByReceiverIdAndIsReadFalseOrderByCreatedAtDesc(receiverId);
    
    // Streamìœ¼ë¡œ ë³€í™˜
    return messages.stream()
            .map(this::toDto)
            .toList();
}
```

**ì‹¤í–‰ë˜ëŠ” SQL:**
```sql
-- get()
SELECT * FROM messages WHERE id = 1

-- inbox()
SELECT * FROM messages 
WHERE receiver_id = 2 
  AND is_read = false 
ORDER BY created_at DESC
```

### 7.3 ë©”ì‹œì§€ ìˆ˜ì • (Update)

```java
@Transactional
public MessageResponseDto markRead(Long id) {
    // ì¡°íšŒ
    Message message = messageRepository.findById(id)
            .orElseThrow(() -> new ResourceNotFoundException("Message not found: " + id));
    
    // ìˆ˜ì • (Dirty Checking)
    message.setRead(true);
    
    // save() í˜¸ì¶œ ì•ˆ í•´ë„ ìë™ UPDATE!
    // @Transactionalì´ ìˆìœ¼ë©´ ë³€ê²½ ê°ì§€ í›„ ìë™ ì €ì¥
    
    return toDto(message);
}
```

**Dirty Checkingì´ë€?**
```java
@Transactional
public void update() {
    Message msg = messageRepository.findById(1L).get();
    
    // 1. íŠ¸ëœì­ì…˜ ì‹œì‘ ì‹œ ìŠ¤ëƒ…ìƒ· ì €ì¥
    // 2. ì—”í‹°í‹° ìˆ˜ì •
    msg.setContent("Updated");
    
    // 3. íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì‹œ ìŠ¤ëƒ…ìƒ·ê³¼ ë¹„êµ
    // 4. ë³€ê²½ì‚¬í•­ ê°ì§€ â†’ ìë™ UPDATE
    // save() í˜¸ì¶œ ë¶ˆí•„ìš”!
}
```

**ì‹¤í–‰ë˜ëŠ” SQL:**
```sql
-- ì¡°íšŒ
SELECT * FROM messages WHERE id = 1

-- ìë™ UPDATE (Dirty Checking)
UPDATE messages SET is_read = true, updated_at = '2024-01-15 10:35:00' WHERE id = 1
```

### 7.4 ë©”ì‹œì§€ ì‚­ì œ (Delete)

```java
@Transactional
public void delete(Long id) {
    // ì¡´ì¬ í™•ì¸ í›„ ì‚­ì œ
    Message message = messageRepository.findById(id)
            .orElseThrow(() -> new ResourceNotFoundException("Message not found: " + id));
    
    messageRepository.deleteById(id);
}
```

**ì‹¤í–‰ë˜ëŠ” SQL:**
```sql
-- ì¡°íšŒ
SELECT * FROM messages WHERE id = 1

-- ì‚­ì œ
DELETE FROM messages WHERE id = 1
```

### 7.5 ë³µì¡í•œ ì¡°íšŒ ì˜ˆì œ

```java
// 1. íŠ¹ì • ê¸°ê°„ì˜ ë©”ì‹œì§€
@Transactional(readOnly = true)
public List<MessageResponseDto> getMessagesBetween(
        Long receiverId, 
        LocalDateTime start, 
        LocalDateTime end) {
    
    return messageRepository
            .findByReceiverIdAndCreatedAtBetween(receiverId, start, end)
            .stream()
            .map(this::toDto)
            .toList();
}

// 2. í‚¤ì›Œë“œ ê²€ìƒ‰
@Transactional(readOnly = true)
public List<MessageResponseDto> searchMessages(String keyword) {
    return messageRepository
            .findByContentContaining(keyword)
            .stream()
            .map(this::toDto)
            .toList();
}

// 3. ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ê°œìˆ˜
@Transactional(readOnly = true)
public long getUnreadCount(Long receiverId) {
    return messageRepository
            .countByReceiverIdAndIsReadFalse(receiverId);
}
```

---

## 8. ì‹¤ì „ íŒ

### 8.1 Entity ì„¤ê³„ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] `@Entity` ì• ë…¸í…Œì´ì…˜ ì¶”ê°€
- [ ] `@Table`ë¡œ í…Œì´ë¸” ì´ë¦„ ëª…ì‹œ
- [ ] `@Id` + `@GeneratedValue`ë¡œ PK ì„¤ì •
- [ ] í•„ìˆ˜ í•„ë“œì— `nullable = false`
- [ ] ì¸ë±ìŠ¤ê°€ í•„ìš”í•œ í•„ë“œì— `@Index` ì¶”ê°€
- [ ] `@CreationTimestamp`, `@UpdateTimestamp` í™œìš©
- [ ] Lombok `@Getter`, `@Setter`, `@NoArgsConstructor` ì‚¬ìš©

### 8.2 Repository ì„¤ê³„ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] `JpaRepository<Entity, ID>` ìƒì†
- [ ] Query Method ë„¤ì´ë° ê·œì¹™ ì¤€ìˆ˜
- [ ] ë³µì¡í•œ ì¿¼ë¦¬ëŠ” `@Query` ì‚¬ìš©
- [ ] ì„±ëŠ¥ì´ ì¤‘ìš”í•œ ì¡°íšŒëŠ” DTO Projection ê³ ë ¤

### 8.3 Service ì„¤ê³„ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] ì“°ê¸° ì‘ì—…ì— `@Transactional`
- [ ] ì½ê¸° ì‘ì—…ì— `@Transactional(readOnly = true)`
- [ ] Entity â†” DTO ë³€í™˜ ë©”ì„œë“œ ë¶„ë¦¬
- [ ] ì˜ˆì™¸ ì²˜ë¦¬ ì ì ˆíˆ êµ¬í˜„

### 8.4 ì„±ëŠ¥ ìµœì í™” ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] N+1 ë¬¸ì œ í™•ì¸ ë° í•´ê²°
- [ ] ì ì ˆí•œ ì¸ë±ìŠ¤ ì„¤ì •
- [ ] Batch ì²˜ë¦¬ í™œìš©
- [ ] ë¶ˆí•„ìš”í•œ í•„ë“œ ì¡°íšŒ ìµœì†Œí™”
- [ ] íŠ¸ëœì­ì…˜ ë²”ìœ„ ìµœì†Œí™”

---

## 9. ìš”ì•½

### JPAì˜ í•µì‹¬ ê°œë…

1. **Entity**: ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸”ê³¼ ë§¤í•‘ë˜ëŠ” ìë°” í´ë˜ìŠ¤
2. **Repository**: ë°ì´í„°ë² ì´ìŠ¤ CRUD ì‘ì—…ì„ ìœ„í•œ ì¸í„°í˜ì´ìŠ¤
3. **Query Method**: ë©”ì„œë“œ ì´ë¦„ìœ¼ë¡œ ìë™ SQL ìƒì„±
4. **Transaction**: ë°ì´í„° ì¼ê´€ì„±ì„ ë³´ì¥í•˜ëŠ” ì‘ì—… ë‹¨ìœ„
5. **Dirty Checking**: ë³€ê²½ ê°ì§€ë¥¼ í†µí•œ ìë™ UPDATE

### message-serviceì˜ JPA êµ¬ì¡°

```
Message Entity
    â†“
MessageRepository (JpaRepository ìƒì†)
    â†“
MessageService (@Transactional)
    â†“
MessageController
```

### ì‹¤ì œ ë™ì‘ íë¦„

```
1. HTTP ìš”ì²­
   â†“
2. Controllerê°€ Service í˜¸ì¶œ
   â†“
3. Serviceê°€ Repository ë©”ì„œë“œ í˜¸ì¶œ
   â†“
4. JPAê°€ SQL ìë™ ìƒì„± ë° ì‹¤í–‰
   â†“
5. ê²°ê³¼ë¥¼ Entityë¡œ ë§¤í•‘
   â†“
6. Serviceê°€ DTOë¡œ ë³€í™˜
   â†“
7. HTTP ì‘ë‹µ
```

---

## ğŸ“š ì¶”ê°€ í•™ìŠµ ìë£Œ

- [Spring Data JPA ê³µì‹ ë¬¸ì„œ](https://docs.spring.io/spring-data/jpa/docs/current/reference/html/)
- [Hibernate ê³µì‹ ë¬¸ì„œ](https://hibernate.org/orm/documentation/)
- [JPA Query Method í‚¤ì›Œë“œ](https://docs.spring.io/spring-data/jpa/reference/jpa/query-methods.html)
