# PrivateKey ë””ì½”ë”© ì˜¤ë¥˜ ìµœì¢… í•´ê²°

## ğŸš¨ ì˜¤ë¥˜
```
java.security.InvalidKeyException: Unable to decode key
```

## ğŸ” ì›ì¸
ê¸°ì¡´ ì½”ë“œëŠ” PKCS#8 í˜•ì‹ë§Œ ì§€ì›í–ˆìœ¼ë‚˜, AWS IoT ì¸ì¦ì„œëŠ” PKCS#1 (RSA PRIVATE KEY) í˜•ì‹ì¼ ìˆ˜ ìˆìŒ

## âœ… í•´ê²°
Amazonì˜ ê³µì‹ `PrivateKeyReader` ë¡œì§ì„ ì ìš©í•˜ì—¬ **PKCS#1ê³¼ PKCS#8 ëª¨ë‘ ì§€ì›**

---

## ğŸ“ ì£¼ìš” ë³€ê²½ ì‚¬í•­

### 1. PrivateKey íŒŒì‹± ë¡œì§ ê°œì„ 

#### ë³€ê²½ ì „ (PKCS#8ë§Œ ì§€ì›):
```java
private PrivateKey parsePrivateKey(String privateKeyPem) {
    String privateKeyData = privateKeyPem
            .replace("-----BEGIN PRIVATE KEY-----", "")
            .replace("-----END PRIVATE KEY-----", "")
            .replaceAll("\\s", "");

    byte[] decoded = Base64.getDecoder().decode(privateKeyData);
    
    // âŒ PKCS#8ë§Œ ì§€ì›
    PKCS8EncodedKeySpec keySpec = new PKCS8EncodedKeySpec(decoded);
    KeyFactory keyFactory = KeyFactory.getInstance("RSA");
    return keyFactory.generatePrivate(keySpec);
}
```

#### ë³€ê²½ í›„ (PKCS#1 ë° PKCS#8 ì§€ì›):
```java
private PrivateKey getPrivateKey(byte[] keyBytes) throws Exception {
    InputStream stream = new ByteArrayInputStream(keyBytes);
    BufferedReader br = new BufferedReader(new InputStreamReader(stream, "UTF-8"));
    StringBuilder builder = new StringBuilder();
    boolean inKey = false;
    boolean isRSAKey = false;

    // PEM íŒŒì¼ íŒŒì‹±
    for (String line = br.readLine(); line != null; line = br.readLine()) {
        if (!inKey) {
            if (line.startsWith("-----BEGIN ") && line.endsWith(" PRIVATE KEY-----")) {
                inKey = true;
                isRSAKey = line.contains("RSA");  // âœ… RSA í‚¤ ê°ì§€
            }
            continue;
        } else {
            if (line.startsWith("-----END ") && line.endsWith(" PRIVATE KEY-----")) {
                break;
            }
            builder.append(line);
        }
    }

    byte[] encoded = org.apache.commons.codec.binary.Base64.decodeBase64(builder.toString());
    
    java.security.spec.KeySpec keySpec;
    if (isRSAKey) {
        // âœ… PKCS#1 í˜•ì‹ (RSA PRIVATE KEY)
        keySpec = getRSAKeySpec(encoded);
    } else {
        // âœ… PKCS#8 í˜•ì‹ (PRIVATE KEY)
        keySpec = new PKCS8EncodedKeySpec(encoded);
    }

    KeyFactory kf = KeyFactory.getInstance("RSA");
    return kf.generatePrivate(keySpec);
}
```

### 2. PKCS#1 â†’ RSAPrivateCrtKeySpec ë³€í™˜ ì¶”ê°€

```java
private RSAPrivateCrtKeySpec getRSAKeySpec(byte[] keyBytes) throws IOException {
    DerParser parser = new DerParser(keyBytes);
    Asn1Object sequence = parser.read();
    
    if (sequence.getType() != DerParser.SEQUENCE) {
        throw new IOException("Invalid DER: not a sequence");
    }

    parser = sequence.getParser();
    parser.read(); // Skip version
    
    // RSA í‚¤ì˜ 9ê°œ ì»´í¬ë„ŒíŠ¸ ì¶”ì¶œ
    BigInteger modulus = parser.read().getInteger();
    BigInteger publicExp = parser.read().getInteger();
    BigInteger privateExp = parser.read().getInteger();
    BigInteger prime1 = parser.read().getInteger();
    BigInteger prime2 = parser.read().getInteger();
    BigInteger exp1 = parser.read().getInteger();
    BigInteger exp2 = parser.read().getInteger();
    BigInteger crtCoef = parser.read().getInteger();

    return new RSAPrivateCrtKeySpec(modulus, publicExp, privateExp, 
            prime1, prime2, exp1, exp2, crtCoef);
}
```

### 3. DER Parser í´ë˜ìŠ¤ ì¶”ê°€

Amazonì˜ DER íŒŒì„œë¥¼ ë‚´ë¶€ static í´ë˜ìŠ¤ë¡œ êµ¬í˜„:
- `DerParser`: ASN.1 DER ë””ì½”ë”
- `Asn1Object`: ASN.1 TLV ê°ì²´

### 4. Apache Commons Codec ì˜ì¡´ì„± ì¶”ê°€

#### build.gradle:
```gradle
// Apache Commons Codec (Base64 ë””ì½”ë”©ìš©)
implementation 'commons-codec:commons-codec:1.15'
```

---

## ğŸ”‘ ì§€ì›í•˜ëŠ” PEM í˜•ì‹

### PKCS#1 (RSA PRIVATE KEY) âœ…
```
-----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEAy8Dbv8prpJ/0kKhlGeJYozo2t60EG8L0561g13R29LvMR5hy
...
-----END RSA PRIVATE KEY-----
```

### PKCS#8 (PRIVATE KEY) âœ…
```
-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQDLwNu/ymukn/SQ
...
-----END PRIVATE KEY-----
```

---

## ğŸš€ ì ìš© ë°©ë²•

### 1. ì½”ë“œ êµì²´
```bash
# ì••ì¶• í•´ì œ
unzip mqtt-service-updated.zip

# ê¸°ì¡´ íŒŒì¼ êµì²´
rm -rf backend/mqtt-service
mv mqtt-service backend/
```

### 2. Docker ì¬ë¹Œë“œ
```bash
# ìºì‹œ ì—†ì´ ì¬ë¹Œë“œ
docker-compose build --no-cache mqtt-service

# ì¬ì‹œì‘
docker-compose up -d mqtt-service
```

### 3. ë¡œê·¸ í™•ì¸
```bash
docker logs -f mqtt-service
```

---

## âœ… ì„±ê³µ ë¡œê·¸

```
Initializing AWS IoT MQTT Client
Endpoint: a2uullhbffujtb-ats.iot.ap-northeast-2.amazonaws.com
Client ID: mqtt-service-prod
Creating KeyStore from certificate and private key
KeyStore created successfully
AWS IoT MQTT Client initialized successfully
Initializing MQTT connection...
Connecting to AWS IoT...
Connection status changed to CONNECTED
Subscribing to MQTT topics...
Successfully subscribed to topic: device/topic/+
Successfully connected to AWS IoT and subscribed to topics
Started MqttServiceApplication in 9.234 seconds
```

---

## ğŸ” ê²€ì¦ ë°©ë²•

### 1. KeyStore ìƒì„± í™•ì¸
```bash
docker logs mqtt-service | grep "KeyStore created"
# KeyStore created successfully
```

### 2. ì—°ê²° ìƒíƒœ í™•ì¸
```bash
docker logs mqtt-service | grep "CONNECTED"
# Connection status changed to CONNECTED
```

### 3. í† í”½ êµ¬ë… í™•ì¸
```bash
docker logs mqtt-service | grep "subscribed"
# Successfully subscribed to topic: device/topic/+
```

### 4. AWS IoT Consoleì—ì„œ í…ŒìŠ¤íŠ¸
```
AWS Console â†’ IoT Core â†’ Test â†’ MQTT test client
â†’ Subscribe to topic: device/topic/+

â†’ Publish to topic: device/topic/B0/TEST
â†’ Payload: {"test": "hello"}

mqtt-service ë¡œê·¸ í™•ì¸:
â†’ "Received MQTT message from topic: device/topic/B0/TEST"
```

---

## ğŸ“Š ê¸°ìˆ  ìƒì„¸

### PKCS#1 vs PKCS#8

| í•­ëª© | PKCS#1 | PKCS#8 |
|------|--------|--------|
| í˜•ì‹ | RSA ì „ìš© | ë²”ìš© (RSA, EC, DSA) |
| í—¤ë” | `-----BEGIN RSA PRIVATE KEY-----` | `-----BEGIN PRIVATE KEY-----` |
| ì¸ì½”ë”© | RSA íŒŒë¼ë¯¸í„° ì§ì ‘ ì €ì¥ | ì•Œê³ ë¦¬ì¦˜ ID + í‚¤ ë°ì´í„° |
| AWS IoT | âœ… ì¼ë°˜ì ìœ¼ë¡œ ì‚¬ìš© | âœ… ì§€ì› |
| OpenSSL ê¸°ë³¸ | PKCS#1 | - |

### RSA í‚¤ êµ¬ì¡° (PKCS#1)

```
RSAPrivateKey ::= SEQUENCE {
  version           INTEGER,
  modulus           INTEGER,  -- n
  publicExponent    INTEGER,  -- e
  privateExponent   INTEGER,  -- d
  prime1            INTEGER,  -- p
  prime2            INTEGER,  -- q
  exponent1         INTEGER,  -- d mod (p-1)
  exponent2         INTEGER,  -- d mod (q-1)
  coefficient       INTEGER   -- (inverse of q) mod p
}
```

---

## ğŸ› íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ì—¬ì „íˆ "Unable to decode key" ì˜¤ë¥˜
```bash
# 1. ê°œì¸ í‚¤ íŒŒì¼ í˜•ì‹ í™•ì¸
docker exec mqtt-service cat /app/certs/private.pem.key | head -n 1

# PKCS#1 ì¶œë ¥:
# -----BEGIN RSA PRIVATE KEY-----

# PKCS#8 ì¶œë ¥:
# -----BEGIN PRIVATE KEY-----

# ì•”í˜¸í™”ëœ í‚¤ (ì§€ì› ì•ˆ í•¨):
# -----BEGIN ENCRYPTED PRIVATE KEY-----
```

### ì•”í˜¸í™”ëœ ê°œì¸ í‚¤ì¸ ê²½ìš°
```bash
# OpenSSLë¡œ ì•”í˜¸ ì œê±°
openssl rsa -in private.pem.key -out private-decrypted.pem.key

# ë³€í™˜ëœ í‚¤ ì‚¬ìš©
cp private-decrypted.pem.key certs/private.pem.key
```

### ì¤„ë°”ê¿ˆ ë¬¸ì œ (Windows)
```bash
# CRLF â†’ LF ë³€í™˜
dos2unix certs/private.pem.key

# ë˜ëŠ” ì§ì ‘ ë³€í™˜
sed -i 's/\r$//' certs/private.pem.key
```

---

## ğŸ“š ì°¸ê³  ìë£Œ

ì´ ì½”ë“œëŠ” Amazonì˜ ê³µì‹ AWS IoT SDK ìƒ˜í”Œ ì½”ë“œ (`PrivateKeyReader.java`)ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.

**ì¶œì²˜**: 
- AWS IoT Device SDK for Java
- Apache License 2.0
- Copyright 2016 Amazon.com, Inc.

---

## ğŸ‰ ìµœì¢… ì •ë¦¬

### ë³€ê²½ ì‚¬í•­
1. âœ… PKCS#1 (RSA PRIVATE KEY) ì§€ì› ì¶”ê°€
2. âœ… PKCS#8 (PRIVATE KEY) ê¸°ì¡´ ì§€ì› ìœ ì§€
3. âœ… Amazonì˜ ê²€ì¦ëœ DER íŒŒì„œ í†µí•©
4. âœ… Apache Commons Codec ì˜ì¡´ì„± ì¶”ê°€

### ê²°ê³¼
- âœ… AWS IoTì—ì„œ ìƒì„±í•œ ëª¨ë“  ê°œì¸ í‚¤ í˜•ì‹ ì§€ì›
- âœ… OpenSSLë¡œ ìƒì„±í•œ í‚¤ ì§€ì›
- âœ… ì•”í˜¸í™”ë˜ì§€ ì•Šì€ PEM í‚¤ë§Œ ì§€ì› (ë³´ì•ˆìƒ ê¶Œì¥)

**ì´ì œ ëª¨ë“  í˜•ì‹ì˜ ê°œì¸ í‚¤ë¡œ AWS IoTì— ì—°ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!** ğŸŠ
