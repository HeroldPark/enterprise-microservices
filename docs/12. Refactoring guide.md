# ğŸ”§ API Gateway ë¦¬íŒ©í† ë§ ê°€ì´ë“œ

## ğŸ“ ë³€ê²½ëœ íŒŒì¼ êµ¬ì¡°

```
backend/api-gateway/src/main/java/com/enterprise/gateway/config/
â”œâ”€â”€ GatewayConfig.java              (ìˆ˜ì •)
â”œâ”€â”€ GatewayRouteProperties.java     (ì‹ ê·œ)
â”œâ”€â”€ SecurityConfig.java             (ìˆ˜ì •)
â”œâ”€â”€ SecurityPathProperties.java     (ì‹ ê·œ)

backend/api-gateway/src/main/resources/
â””â”€â”€ application.yml                 (ì‹ ê·œ ì„¤ì • ì¶”ê°€)
```

---

## âœ… ë³€ê²½ ì‚¬í•­

### 1ï¸âƒ£ GatewayConfig.java (ë¼ìš°íŒ… ì„¤ì •)

**Before (í•˜ë“œì½”ë”©):**
```java
.path("/api/auth/**")
.uri("lb://user-service")
```

**After (ì„¤ì • íŒŒì¼):**
```java
.path(routeProperties.getUser().getAuthPath())
.uri(routeProperties.getUser().getServiceUri())
```

### 2ï¸âƒ£ GatewayRouteProperties.java (ì‹ ê·œ)

ê° ì„œë¹„ìŠ¤ë³„ ë¼ìš°íŒ… ì„¤ì •ì„ ê´€ë¦¬í•˜ëŠ” Properties í´ë˜ìŠ¤:
- User Service
- Product Service
- Order Service
- Board Service

### 3ï¸âƒ£ SecurityConfig.java (ë³´ì•ˆ ì„¤ì •)

**Before (í•˜ë“œì½”ë”©):**
```java
.pathMatchers("/api/orders/**").permitAll()
```

**After (ì„¤ì • íŒŒì¼):**
```java
securityPaths.getPublicPaths().getOrders().forEach(path ->
    exchange.pathMatchers(path).permitAll()
)
```

### 4ï¸âƒ£ SecurityPathProperties.java (ì‹ ê·œ)

ë³´ì•ˆ ê²½ë¡œ ì„¤ì •ì„ ê´€ë¦¬í•˜ëŠ” Properties í´ë˜ìŠ¤:
- Public Paths (ì¸ì¦ ë¶ˆí•„ìš”)
- Authenticated Paths (ì¸ì¦ í•„ìš”)

### 5ï¸âƒ£ application.yml (ì„¤ì •)

ëª¨ë“  ë¼ìš°íŒ… ë° ë³´ì•ˆ ì„¤ì •ì„ YAMLë¡œ ê´€ë¦¬

---

## ğŸš€ ì ìš© ë°©ë²•

### 1. íŒŒì¼ ì¶”ê°€

```bash
# Properties í´ë˜ìŠ¤ ì¶”ê°€
cp GatewayRouteProperties.java backend/api-gateway/src/main/java/com/enterprise/gateway/config/
cp SecurityPathProperties.java backend/api-gateway/src/main/java/com/enterprise/gateway/config/
```

### 2. ê¸°ì¡´ íŒŒì¼ êµì²´

```bash
# Config í´ë˜ìŠ¤ êµì²´
cp GatewayConfig-REFACTORED.java backend/api-gateway/src/main/java/com/enterprise/gateway/config/GatewayConfig.java
cp SecurityConfig-REFACTORED.java backend/api-gateway/src/main/java/com/enterprise/gateway/config/SecurityConfig.java
```

### 3. application.yml ì—…ë°ì´íŠ¸

```bash
# ê¸°ì¡´ application.ymlì— ìƒˆ ì„¤ì • ì¶”ê°€
cat application-gateway.yml >> backend/api-gateway/src/main/resources/application.yml
```

**ë˜ëŠ” ì§ì ‘ í¸ì§‘:**
```bash
vim backend/api-gateway/src/main/resources/application.yml
```

### 4. ì¬ë¹Œë“œ

```bash
cd backend/api-gateway
./gradlew clean build

cd ../..
docker-compose down
docker-compose up -d
```

---

## ğŸ“Š ì¥ì 

### 1. **ìŠ¤ì¼€ì¼ ì•„ì›ƒ ìš©ì´**

ìƒˆë¡œìš´ ì„œë¹„ìŠ¤ ì¶”ê°€ ì‹œ **ì½”ë“œ ìˆ˜ì • ì—†ì´ ì„¤ì •ë§Œ ì¶”ê°€:**

```yaml
gateway:
  routes:
    payment:  # ìƒˆë¡œìš´ ê²°ì œ ì„œë¹„ìŠ¤
      service-uri: lb://payment-service
      api-path: /api/payments/**
      require-auth: true
```

### 2. **í™˜ê²½ë³„ ì„¤ì • ë¶„ë¦¬**

Dev/Staging/Prod í™˜ê²½ë³„ë¡œ ë‹¤ë¥¸ ë³´ì•ˆ ì •ì±… ì ìš©:

```yaml
# Dev: ì¸ì¦ ëŠìŠ¨
spring.profiles.active: dev
gateway.security.authenticate-all: false

# Prod: ì¸ì¦ ì—„ê²©
spring.profiles.active: prod
gateway.security.authenticate-all: true
```

### 3. **ìœ ì§€ë³´ìˆ˜ ê°„í¸**

ê²½ë¡œ ë³€ê²½ ì‹œ **application.ymlë§Œ ìˆ˜ì •:**

```yaml
# ì£¼ë¬¸ API ê²½ë¡œ ë³€ê²½
order:
  api-path: /api/v2/orders/**  # v1 â†’ v2
```

### 4. **ì¤‘ì•™ ì§‘ì¤‘ì‹ ê´€ë¦¬**

ëª¨ë“  ë¼ìš°íŒ…/ë³´ì•ˆ ì„¤ì •ì´ **application.yml**ì— ì§‘ì¤‘:
- ì–´ë–¤ ê²½ë¡œê°€ publicì¸ì§€ í•œëˆˆì— í™•ì¸
- ì„œë¹„ìŠ¤ë³„ URI ê´€ë¦¬ ìš©ì´
- ì¸ì¦ ìš”êµ¬ì‚¬í•­ ëª…í™•

---

## ğŸ”§ ì„¤ì • ì˜ˆì‹œ

### ì˜ˆì‹œ 1: ìƒˆ ì„œë¹„ìŠ¤ ì¶”ê°€ (ê²°ì œ ì„œë¹„ìŠ¤)

**application.yml:**
```yaml
gateway:
  routes:
    payment:
      service-uri: lb://payment-service
      api-path: /api/payments/**
      require-auth: true
```

**GatewayRouteProperties.java:**
```java
@Data
public static class PaymentServiceConfig {
    private String serviceUri = "lb://payment-service";
    private String apiPath = "/api/payments/**";
    private boolean requireAuth = true;
}
```

**GatewayConfig.java:**
```java
routes.route("payment-service", r -> r
    .path(routeProperties.getPayment().getApiPath())
    .filters(f -> f
        .stripPrefix(routeProperties.getStripPrefix())
        .filter(jwtAuthenticationFilter.apply(
            new JwtAuthenticationFilter.Config(
                routeProperties.getPayment().isRequireAuth()))))
    .uri(routeProperties.getPayment().getServiceUri()));
```

### ì˜ˆì‹œ 2: ë³´ì•ˆ ì •ì±… ë³€ê²½

**ì£¼ë¬¸ì„ ì¸ì¦ í•„ìš”ë¡œ ë³€ê²½:**

```yaml
# application.yml
gateway:
  security:
    public-paths:
      orders: []  # ë¹„ì›€
    authenticated-paths:
      orders:  # ì¶”ê°€
        - /api/orders/**
```

---

## ğŸ“ ì„¤ì • íŒŒì¼ êµ¬ì¡°

```yaml
gateway:
  routes:
    strip-prefix: 1  # ê³µí†µ ì„¤ì •
    
    user:            # ì„œë¹„ìŠ¤ë³„ ì„¤ì •
      service-uri: lb://user-service
      auth-path: /api/auth/**
      api-path: /api/users/**
    
    product:
      service-uri: lb://product-service
      api-path: /api/products/**
      require-auth: false
    
  security:
    authenticate-all: false  # ê¸°ë³¸ ì •ì±…
    
    public-paths:    # ì¸ì¦ ë¶ˆí•„ìš”
      auth:
        - /api/auth/**
      orders:
        - /api/orders/**
    
    authenticated-paths:  # ì¸ì¦ í•„ìš”
      boards-write:
        - /api/boards/**
```

---

## ğŸ¯ ë§ˆì´ê·¸ë ˆì´ì…˜ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] GatewayRouteProperties.java ì¶”ê°€
- [ ] SecurityPathProperties.java ì¶”ê°€
- [ ] GatewayConfig.java êµì²´
- [ ] SecurityConfig.java êµì²´
- [ ] application.yml ì—…ë°ì´íŠ¸
- [ ] ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
- [ ] ëª¨ë“  ì—”ë“œí¬ì¸íŠ¸ ë™ì‘ í™•ì¸
- [ ] ì¸ì¦ ì •ì±… í™•ì¸

---

## ğŸš¨ ì£¼ì˜ì‚¬í•­

1. **ê¸°ì¡´ ì„¤ì •ê³¼ ì¶©ëŒ ë°©ì§€**
   - application.ymlì˜ ê¸°ì¡´ ì„¤ì •ê³¼ ì¶©ëŒí•˜ì§€ ì•Šë„ë¡ ì£¼ì˜

2. **í”„ë¡œíŒŒì¼ ì„¤ì •**
   - dev/prod í”„ë¡œíŒŒì¼ë³„ë¡œ ë‹¤ë¥¸ ì„¤ì • ê°€ëŠ¥
   - `spring.profiles.active`ë¡œ í™˜ê²½ ì „í™˜

3. **í…ŒìŠ¤íŠ¸ í•„ìˆ˜**
   - ë¼ìš°íŒ… ë³€ê²½ í›„ ëª¨ë“  API í…ŒìŠ¤íŠ¸
   - ì¸ì¦/ë¹„ì¸ì¦ ê²½ë¡œ í™•ì¸

4. **ì ì§„ì  ì ìš©**
   - í•œ ë²ˆì— ëª¨ë‘ ë³€ê²½í•˜ì§€ ë§ê³  ì„œë¹„ìŠ¤ë³„ë¡œ ì ì§„ ì ìš©
   - ë¡¤ë°± ê³„íš ì¤€ë¹„

---

## ğŸ’¡ ì¶”ê°€ ê°œì„  ì‚¬í•­

### 1. ë™ì  ë¦¬ë¡œë“œ

```yaml
management:
  endpoints:
    web:
      exposure:
        include: refresh
```

```bash
# ì„¤ì • ë³€ê²½ í›„ ì¬ì‹œì‘ ì—†ì´ ë¦¬ë¡œë“œ
curl -X POST http://localhost:8080/actuator/refresh
```

### 2. Config Server í†µí•©

```yaml
spring:
  cloud:
    config:
      uri: http://config-server:8888
```

ì„¤ì •ì„ Gitì—ì„œ ê´€ë¦¬í•˜ê³  ë™ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸

### 3. ëª¨ë‹ˆí„°ë§

```yaml
gateway:
  routes:
    user:
      metrics-enabled: true
```

ê° ë¼ìš°íŠ¸ë³„ ë©”íŠ¸ë¦­ ìˆ˜ì§‘

---

## ğŸ“ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ë¬¸ì œ 1: Properties ë°”ì¸ë”© ì•ˆ ë¨

**í•´ê²°:**
```java
@EnableConfigurationProperties({
    GatewayRouteProperties.class,
    SecurityPathProperties.class
})
```

### ë¬¸ì œ 2: ìˆœí™˜ ì°¸ì¡° ì—ëŸ¬

**í•´ê²°:**
Properties í´ë˜ìŠ¤ì—ì„œ `@Lazy` ì‚¬ìš©

### ë¬¸ì œ 3: ì„¤ì • ë¡œë”© ìˆœì„œ

**í•´ê²°:**
`@Order` ì–´ë…¸í…Œì´ì…˜ìœ¼ë¡œ ìˆœì„œ ì¡°ì •