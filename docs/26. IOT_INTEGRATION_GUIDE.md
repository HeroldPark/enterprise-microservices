# IoT ë©”ì‹œì§€ íë¦„ í†µí•© ê°€ì´ë“œ

## ğŸ“Š ì•„í‚¤í…ì²˜ ê°œìš”

```
IoT Device â†â†’ AWS IoT Core â†â†’ mqtt-service â†â†’ Kafka â†â†’ message-service
```

### ë©”ì‹œì§€ íë¦„

#### 1ï¸âƒ£ **IoT â†’ Backend (ë°ì´í„° ìˆ˜ì‹ )**
```
IoT Device â†’ AWS IoT Core â†’ mqtt-service â†’ Kafka Topic â†’ message-service
```

#### 2ï¸âƒ£ **Backend â†’ IoT (ëª…ë ¹ ì „ì†¡)**
```
message-service â†’ Kafka Topic â†’ mqtt-service â†’ AWS IoT Core â†’ IoT Device
```

---

## ğŸ”„ ìƒì„¸ ë©”ì‹œì§€ íë¦„

### ğŸ“¥ IoT ë””ë°”ì´ìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì‹ 

```mermaid
graph LR
    A[IoT Device] -->|MQTT Publish| B[AWS IoT Core]
    B -->|Topic: device/topic/+| C[mqtt-service]
    C -->|MqttMessageListener| D[Base64 Decode]
    D -->|Parse Message Type| E[Create MqttMessage DTO]
    E -->|KafkaProducerService| F[Kafka Topic]
    F -->|device.data.topic| G[message-service]
    G -->|IoTDeviceMessageConsumer| H[Process Data]
```

**ì²˜ë¦¬ ê³¼ì •:**

1. **IoT Device**: AWS IoT Coreë¡œ MQTT ë©”ì‹œì§€ ë°œí–‰
   - Topic: `device/topic/B0/{deviceId}`
   - Payload: Base64 ì¸ì½”ë”©ëœ ë°”ì´ë„ˆë¦¬ ë°ì´í„°

2. **mqtt-service (MqttMessageListener)**:
   - MQTT ë©”ì‹œì§€ ìˆ˜ì‹  (QoS 0)
   - Base64 ë””ì½”ë”©
   - ë©”ì‹œì§€ íƒ€ì… íŒŒì‹± (byte[4])
   - `MqttMessage` DTO ìƒì„±

3. **mqtt-service (KafkaProducerService)**:
   - ë©”ì‹œì§€ íƒ€ì…ì— ë”°ë¼ Kafka í† í”½ ê²°ì •
   - Kafkaë¡œ JSON ë©”ì‹œì§€ ì „ì†¡

4. **message-service (IoTDeviceMessageConsumer)**:
   - Kafkaì—ì„œ ë©”ì‹œì§€ ìˆ˜ì‹ 
   - ë©”ì‹œì§€ íƒ€ì…ë³„ ì²˜ë¦¬
     - PERIODIC: ì£¼ê¸°ì  ì„¼ì„œ ë°ì´í„°
     - DISCRETE: ì´ë²¤íŠ¸ì„± ë°ì´í„°
     - REQUEST: ë””ë°”ì´ìŠ¤ ë“±ë¡ ìš”ì²­
     - RESPONSE: ì‘ë‹µ
     - FOTA: íŒì›¨ì–´ ì—…ë°ì´íŠ¸ ìƒíƒœ
     - REBOOT: ì¬ì‹œì‘ ì™„ë£Œ

### ğŸ“¤ IoT ë””ë°”ì´ìŠ¤ë¡œ ëª…ë ¹ ì „ì†¡

```mermaid
graph LR
    A[REST API] -->|POST /api/iot/command| B[message-service]
    B -->|IoTCommandProducer| C[Kafka Topic]
    C -->|mqtt.command.topic| D[mqtt-service]
    D -->|MqttCommandConsumer| E[Create PublishRequest]
    E -->|MqttPublishService| F[AWS IoT MQTT Client]
    F -->|Topic: device/topic/A0/{deviceId}| G[AWS IoT Core]
    G -->|MQTT Subscribe| H[IoT Device]
```

**ì²˜ë¦¬ ê³¼ì •:**

1. **REST API í˜¸ì¶œ**:
   ```bash
   POST /api/iot/command
   {
     "deviceId": "DEVICE_001",
     "messageType": "ECHO",
     "payload": "base64EncodedMessage",
     "qos": 0,
     "topicType": "REQUEST"
   }
   ```

2. **message-service (IoTCommandProducer)**:
   - `IoTCommandDto` ìƒì„±
   - Kafka Topic `mqtt.command.topic`ìœ¼ë¡œ ë°œí–‰

3. **mqtt-service (MqttCommandConsumer)**:
   - Kafkaì—ì„œ ëª…ë ¹ ìˆ˜ì‹ 
   - `PublishRequest` ë³€í™˜

4. **mqtt-service (MqttPublishService)**:
   - AWS IoT MQTT Clientë¡œ ë°œí–‰
   - Topic: `device/topic/A0/{deviceId}`

5. **IoT Device**:
   - MQTT Subscribeë¡œ ëª…ë ¹ ìˆ˜ì‹ 
   - ëª…ë ¹ ì‹¤í–‰

---

## ğŸ“‹ Kafka Topic êµ¬ì„±

### MQTT â†’ Message (IoT ë°ì´í„°)

| Topic | ìš©ë„ | ë©”ì‹œì§€ íƒ€ì… |
|-------|------|------------|
| `device.data.topic` | ì„¼ì„œ ë°ì´í„° | PERIODIC, DISCRETE, ECHO |
| `device.request.topic` | ë””ë°”ì´ìŠ¤ ë“±ë¡ | REQUEST |
| `device.response.topic` | ì‘ë‹µ | RESPONSE |
| `device.fota.topic` | íŒì›¨ì–´ ì—…ë°ì´íŠ¸ | FOTA |
| `device.reboot.topic` | ì¬ì‹œì‘ | REBOOT |

### Message â†’ MQTT (IoT ëª…ë ¹)

| Topic | ìš©ë„ |
|-------|------|
| `mqtt.command.topic` | IoT ë””ë°”ì´ìŠ¤ ì œì–´ ëª…ë ¹ |

---

## ğŸ› ï¸ ì£¼ìš” ì½”ë“œ ë³€ê²½ì‚¬í•­

### 1. mqtt-service

#### ìƒˆë¡œ ì¶”ê°€ëœ íŒŒì¼:
- `MqttCommandDto.java`: Kafka ëª…ë ¹ ìˆ˜ì‹  DTO
- `MqttCommandConsumer.java`: Kafka ëª…ë ¹ Consumer
- `KafkaConsumerConfig.java`: Kafka Consumer ì„¤ì •

#### ìˆ˜ì •ëœ íŒŒì¼:
- `application.yml`: `mqtt-command` í† í”½ ì¶”ê°€
- `KafkaConfig.java`: `mqttCommandTopic` Bean ì¶”ê°€
- `build.gradle`: Kafka ì˜ì¡´ì„± ì¶”ê°€

### 2. message-service

#### ìƒˆë¡œ ì¶”ê°€ëœ íŒŒì¼:
- `dto/iot/IoTDeviceMessageDto.java`: IoT ë©”ì‹œì§€ DTO
- `dto/iot/IoTCommandDto.java`: IoT ëª…ë ¹ DTO
- `kafka/IoTDeviceMessageConsumer.java`: IoT ë©”ì‹œì§€ Consumer
- `kafka/IoTCommandProducer.java`: IoT ëª…ë ¹ Producer
- `controller/IoTDeviceController.java`: IoT ì œì–´ REST API

#### ìˆ˜ì •ëœ íŒŒì¼:
- `application.yml`: IoT ê´€ë ¨ Kafka í† í”½ ì¶”ê°€

---

## ğŸš€ ì‹¤í–‰ ë°©ë²•

### 1. í•„ìˆ˜ ì¡°ê±´

- Docker & Docker Compose
- AWS IoT Core ì„¤ì • (Thing, Certificate, Policy)
- Kafka ì‹¤í–‰ ì¤‘

### 2. ì¸ì¦ì„œ ì„¤ì •

mqtt-serviceì˜ `certs/` ë””ë ‰í† ë¦¬ì— AWS IoT ì¸ì¦ì„œ ë°°ì¹˜:
```
certs/
â”œâ”€â”€ certificate.pem.crt
â”œâ”€â”€ private.pem.key
â””â”€â”€ AmazonRootCA1.pem
```

### 3. Docker Compose ì‹¤í–‰

```bash
# ì „ì²´ ì„œë¹„ìŠ¤ ì‹œì‘
docker-compose up -d

# ë¡œê·¸ í™•ì¸
docker-compose logs -f mqtt-service message-service
```

### 4. ê°œë³„ ì„œë¹„ìŠ¤ ì‹¤í–‰

#### mqtt-service
```bash
cd mqtt-service
./gradlew bootRun
```

#### message-service
```bash
cd message-service
./gradlew bootRun
```

---

## ğŸ“¡ API ì‚¬ìš© ì˜ˆì œ

### 1. IoT ëª…ë ¹ ì „ì†¡

#### Echo ëª…ë ¹ (í…ŒìŠ¤íŠ¸ìš©)
```bash
curl -X POST http://localhost:8086/api/iot/echo/DEVICE_001 \
  -H "Content-Type: text/plain" \
  -d "SGVsbG8gRGV2aWNl"  # Base64: "Hello Device"
```

#### FOTA ëª…ë ¹ (íŒì›¨ì–´ ì—…ë°ì´íŠ¸)
```bash
curl -X POST http://localhost:8086/api/iot/fota/DEVICE_001 \
  -H "Content-Type: text/plain" \
  -d "base64EncodedFirmwareData"
```

#### Reboot ëª…ë ¹
```bash
curl -X POST http://localhost:8086/api/iot/reboot/DEVICE_001 \
  -H "Content-Type: text/plain" \
  -d "base64EncodedRebootCommand"
```

#### ì¼ë°˜ ëª…ë ¹
```bash
curl -X POST http://localhost:8086/api/iot/command \
  -H "Content-Type: application/json" \
  -d '{
    "deviceId": "DEVICE_001",
    "messageType": "NTP",
    "payload": "base64EncodedPayload",
    "qos": 0,
    "topicType": "REQUEST"
  }'
```

### 2. ì‘ë‹µ ì˜ˆì‹œ

```json
{
  "success": true,
  "commandId": "550e8400-e29b-41d4-a716-446655440000",
  "deviceId": "DEVICE_001",
  "messageType": "ECHO",
  "message": "Command sent successfully"
}
```

---

## ğŸ” ëª¨ë‹ˆí„°ë§

### 1. Kafka UI
```
http://localhost:8090
```
- Kafka í† í”½ ëª¨ë‹ˆí„°ë§
- ë©”ì‹œì§€ í™•ì¸
- Consumer ê·¸ë£¹ ìƒíƒœ

### 2. Swagger UI

**mqtt-service**:
```
http://localhost:8088/swagger-ui.html
```

**message-service**:
```
http://localhost:8086/swagger-ui.html
```

### 3. Actuator

**mqtt-service**:
```
http://localhost:8088/actuator/health
http://localhost:8088/actuator/metrics
```

**message-service**:
```
http://localhost:8086/actuator/health
http://localhost:8086/actuator/metrics
```

---

## ğŸ“Š ë©”ì‹œì§€ íƒ€ì…ë³„ ì²˜ë¦¬

### IoT â†’ Backend

| íƒ€ì… | ì½”ë“œ | Kafka Topic | ì„¤ëª… |
|------|------|-------------|------|
| PERIODIC | 0 | device.data.topic | ì£¼ê¸°ì  ì„¼ì„œ ë°ì´í„° (ì˜¨ë„, ìŠµë„ ë“±) |
| DISCRETE | 1 | device.data.topic | ì´ë²¤íŠ¸ì„± ë°ì´í„° (ì•ŒëŒ, ê°ì§€ ë“±) |
| REQUEST | 2 | device.request.topic | ë””ë°”ì´ìŠ¤ ë“±ë¡/ì¸ì¦ ìš”ì²­ |
| RESPONSE | 3 | device.response.topic | ëª…ë ¹ ì‹¤í–‰ ê²°ê³¼ |
| ECHO | 5 | device.data.topic | í…ŒìŠ¤íŠ¸ìš© Echo |
| FOTA | 6 | device.fota.topic | íŒì›¨ì–´ ì—…ë°ì´íŠ¸ ì§„í–‰ ìƒí™© |
| REBOOT | 7 | device.reboot.topic | ì¬ì‹œì‘ ì™„ë£Œ ì•Œë¦¼ |

### Backend â†’ IoT

ëª¨ë“  ëª…ë ¹ì€ `mqtt.command.topic`ì„ í†µí•´ ì „ì†¡ë˜ë©°, ë‹¤ìŒ íƒ€ì…ì„ ì§€ì›:
- ECHO: í…ŒìŠ¤íŠ¸
- FOTA: íŒì›¨ì–´ ì—…ë°ì´íŠ¸ ì‹œì‘
- REBOOT: ì¬ì‹œì‘ ëª…ë ¹
- NTP: ì‹œê°„ ë™ê¸°í™”

---

## ğŸ”§ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### 1. MQTT ì—°ê²° ì‹¤íŒ¨

**ì¦ìƒ**: mqtt-serviceê°€ AWS IoTì— ì—°ê²°ë˜ì§€ ì•ŠìŒ

**í•´ê²°ë°©ë²•**:
```bash
# ì¸ì¦ì„œ í™•ì¸
ls -l mqtt-service/certs/

# ì¸ì¦ì„œ ê¶Œí•œ í™•ì¸
chmod 600 mqtt-service/certs/*.key

# AWS IoT Endpoint í™•ì¸
# application.ymlì˜ aws.iot.endpoint í™•ì¸
```

### 2. Kafka ë©”ì‹œì§€ ìˆ˜ì‹  ì•ˆë¨

**ì¦ìƒ**: message-serviceê°€ IoT ë©”ì‹œì§€ë¥¼ ë°›ì§€ ëª»í•¨

**í•´ê²°ë°©ë²•**:
```bash
# Kafka í† í”½ í™•ì¸
docker exec -it kafka kafka-topics --bootstrap-server localhost:9092 --list

# Consumer ê·¸ë£¹ í™•ì¸
docker exec -it kafka kafka-consumer-groups --bootstrap-server localhost:9092 --list

# ë©”ì‹œì§€ í™•ì¸
docker exec -it kafka kafka-console-consumer \
  --bootstrap-server localhost:9092 \
  --topic device.data.topic \
  --from-beginning
```

### 3. ëª…ë ¹ ì „ì†¡ ì‹¤íŒ¨

**ì¦ìƒ**: REST APIëŠ” ì„±ê³µí•˜ì§€ë§Œ IoT ë””ë°”ì´ìŠ¤ê°€ ëª…ë ¹ì„ ë°›ì§€ ëª»í•¨

**í•´ê²°ë°©ë²•**:
```bash
# mqtt-service ë¡œê·¸ í™•ì¸
docker logs -f mqtt-service

# Kafka ëª…ë ¹ í† í”½ í™•ì¸
docker exec -it kafka kafka-console-consumer \
  --bootstrap-server localhost:9092 \
  --topic mqtt.command.topic \
  --from-beginning

# AWS IoT Core ë¡œê·¸ í™•ì¸ (CloudWatch)
```

---

## ğŸ“ ê°œë°œ ê°€ì´ë“œ

### ìƒˆë¡œìš´ ë©”ì‹œì§€ íƒ€ì… ì¶”ê°€

1. **Enum ì¶”ê°€**:
   ```java
   // MqttMessage.java, IoTDeviceMessageDto.java
   public enum MessageType {
       // ... ê¸°ì¡´ íƒ€ì…ë“¤
       NEW_TYPE(9)  // ìƒˆë¡œìš´ íƒ€ì…
   }
   ```

2. **Kafka í† í”½ ì¶”ê°€** (ì„ íƒì‚¬í•­):
   ```yaml
   # application.yml
   kafka:
     topics:
       new-type: device.newtype.topic
   ```

3. **Consumer ì²˜ë¦¬ ì¶”ê°€**:
   ```java
   // IoTDeviceMessageConsumer.java
   @KafkaListener(topics = "${kafka.topic.new-type}")
   public void consumeNewType(String messageJson) {
       // ì²˜ë¦¬ ë¡œì§
   }
   ```

4. **Producer ë©”ì„œë“œ ì¶”ê°€**:
   ```java
   // IoTCommandProducer.java
   public CompletableFuture<SendResult> sendNewTypeCommand(
           String deviceId, String payload) {
       // ë°œí–‰ ë¡œì§
   }
   ```

### ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì¶”ê°€

`IoTDeviceMessageConsumer.java`ì˜ ì²˜ë¦¬ ë©”ì„œë“œì—ì„œ êµ¬í˜„:

```java
private void processPeriodicData(IoTDeviceMessageDto message) {
    // 1. ë°ì´í„° íŒŒì‹±
    // 2. DB ì €ì¥
    // 3. ì´ìƒ ê°ì§€
    // 4. ì•Œë¦¼ ë°œì†¡
}
```

---

## ğŸ“š ì°¸ê³  ìë£Œ

- [AWS IoT Core ë¬¸ì„œ](https://docs.aws.amazon.com/iot/)
- [Apache Kafka ë¬¸ì„œ](https://kafka.apache.org/documentation/)
- [Spring Kafka ë¬¸ì„œ](https://spring.io/projects/spring-kafka)

---

## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸

### ì´ˆê¸° ì„¤ì •
- [ ] AWS IoT Thing ìƒì„±
- [ ] ì¸ì¦ì„œ ë°œê¸‰ ë° `certs/` ë””ë ‰í† ë¦¬ ë°°ì¹˜
- [ ] IoT Policy ì„¤ì •
- [ ] Kafka ì‹¤í–‰ í™•ì¸

### ì„œë¹„ìŠ¤ ì‹œì‘
- [ ] mqtt-service ì •ìƒ ì‹œì‘
- [ ] message-service ì •ìƒ ì‹œì‘
- [ ] Kafka í† í”½ ìë™ ìƒì„± í™•ì¸
- [ ] Eureka ì„œë¹„ìŠ¤ ë“±ë¡ í™•ì¸

### í…ŒìŠ¤íŠ¸
- [ ] IoT ë””ë°”ì´ìŠ¤ì—ì„œ ë©”ì‹œì§€ ìˆ˜ì‹  í™•ì¸
- [ ] Kafkaì—ì„œ ë©”ì‹œì§€ í™•ì¸
- [ ] message-serviceì—ì„œ ì²˜ë¦¬ ë¡œê·¸ í™•ì¸
- [ ] REST APIë¡œ ëª…ë ¹ ì „ì†¡ í…ŒìŠ¤íŠ¸
- [ ] IoT ë””ë°”ì´ìŠ¤ì—ì„œ ëª…ë ¹ ìˆ˜ì‹  í™•ì¸

---

## ğŸ¯ ë‹¤ìŒ ë‹¨ê³„

1. **ë°ì´í„° íŒŒì‹± êµ¬í˜„**: Base64 ë©”ì‹œì§€ë¥¼ êµ¬ì¡°í™”ëœ ë°ì´í„°ë¡œ ë³€í™˜
2. **DB ì—°ë™**: ë””ë°”ì´ìŠ¤ ë°ì´í„° ì˜êµ¬ ì €ì¥
3. **ì•Œë¦¼ ì‹œìŠ¤í…œ**: ì´ìƒ ê°ì§€ ì‹œ ì•Œë¦¼ ë°œì†¡
4. **ëŒ€ì‹œë³´ë“œ**: ì‹¤ì‹œê°„ ë””ë°”ì´ìŠ¤ ëª¨ë‹ˆí„°ë§ UI
5. **ë³´ì•ˆ ê°•í™”**: ë””ë°”ì´ìŠ¤ ì¸ì¦ ë° ì•”í˜¸í™”

---

**ë¬¸ì˜ì‚¬í•­ì´ë‚˜ ì´ìŠˆê°€ ìˆìœ¼ë©´ ê°œë°œíŒ€ì— ì—°ë½í•˜ì„¸ìš”.**
