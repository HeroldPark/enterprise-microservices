# Message Service Kafka ë©”ì‹œì§€ í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ

## ğŸ§¹ ì‚¬ì „ ì¤€ë¹„: Kafka í† í”½ ì´ˆê¸°í™”

ë¨¼ì € ê¸°ì¡´ì˜ ì˜ëª»ëœ ë©”ì‹œì§€ë¥¼ ì œê±°í•©ë‹ˆë‹¤:

```bash
# 1ë‹¨ê³„: message-service ì¤‘ì§€
docker-compose stop message-service

# 2ë‹¨ê³„: í† í”½ ì‚­ì œ
docker exec kafka kafka-topics --bootstrap-server localhost:9092 --delete --topic message.created
docker exec kafka kafka-topics --bootstrap-server localhost:9092 --delete --topic message.read
docker exec kafka kafka-topics --bootstrap-server localhost:9092 --delete --topic message.deleted

# 3ë‹¨ê³„: Consumer ê·¸ë£¹ ì‚­ì œ
docker exec kafka kafka-consumer-groups --bootstrap-server localhost:9092 --delete --group message-service-group

# 4ë‹¨ê³„: message-service ì¬ì‹œì‘
docker-compose start message-service

# 5ë‹¨ê³„: ë¡œê·¸ í™•ì¸ (15ì´ˆ ëŒ€ê¸°)
sleep 15
docker-compose logs message-service | tail -50
```

---

## ğŸ“¨ í…ŒìŠ¤íŠ¸ ë°©ë²•

```
http://localhost:8086 ìœ¼ë¡œ ì ‘ì†í•˜ëŠ” ê²ƒì€ ë‚´ë¶€ì—ì„œ ì ‘ì†í•˜ëŠ” ê²ƒì´ë¯€ë¡œ /api ì—†ëŠ” ëª…ë ¹ì–´ê°€ ë§ë‹¤.
http://localhost:8080 ìœ¼ë¡œ ì ‘ì†í•˜ëŠ” ê²ƒì€ ì™¸ë¶€ì—ì„œ ì ‘ì†í•˜ëŠ” ê²ƒì´ë¯€ë¡œ /api ê°€ ìˆì–´ì•¼ í•œë‹¤.

YOUR_JWT_TOKEN : eyJhbGciOiJIUzUxMiJ9.eyJyb2xlIjoiQURNSU4iLCJzdWIiOiJhZG1pbiIsImlhdCI6MTc2ODIwNDcxMSwiZXhwIjoxNzY4MjkxMTExfQ.bjvSAldMbqGnSRKyvRBqp0Ym8QHHro8-jKD4vqKbu-dYFyCxOJUfo1kTqg_vOC6MRuVhkNmxHx-UhwcpsErq-w
```

### ë°©ë²• 1: REST APIë¥¼ í†µí•œ ë©”ì‹œì§€ í…ŒìŠ¤íŠ¸ (ê¶Œì¥)

message-serviceëŠ” REST APIë¥¼ ì œê³µí•˜ë¯€ë¡œ, APIë¥¼ í†µí•´ ë©”ì‹œì§€ë¥¼ ìƒì„±í•˜ë©´ ìë™ìœ¼ë¡œ Kafka ì´ë²¤íŠ¸ê°€ ë°œí–‰ë©ë‹ˆë‹¤.

#### 1-1. ë©”ì‹œì§€ ìƒì„± API í˜¸ì¶œ

```bash
# ë©”ì‹œì§€ ìƒì„± (JSON í˜•ì‹)
curl -X POST http://localhost:8086/api/messages \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -d '{
    "senderId": 1,
    "receiverId": 2,
    "content": "ì•ˆë…•í•˜ì„¸ìš”! í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ì…ë‹ˆë‹¤."
  }'
```

**ì˜ˆìƒ ì‘ë‹µ:**
```json
{
  "id": 1,
  "senderId": 1,
  "receiverId": 2,
  "content": "ì•ˆë…•í•˜ì„¸ìš”! í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ì…ë‹ˆë‹¤.",
  "isRead": false,
  "createdAt": "2026-01-12T07:45:00.000Z"
}
```

#### 1-2. Kafka ì´ë²¤íŠ¸ í™•ì¸

```bash
# message-service ë¡œê·¸ì—ì„œ ì´ë²¤íŠ¸ ë°œí–‰ í™•ì¸
docker-compose logs message-service | grep -i "published message created event"

# ì˜ˆìƒ ì¶œë ¥:
# Published message created event: messageId=1
```

#### 1-3. Consumerì—ì„œ ì´ë²¤íŠ¸ ìˆ˜ì‹  í™•ì¸

```bash
# Consumer ë¡œê·¸ í™•ì¸
docker-compose logs message-service | grep -i "received message created event"

# ì˜ˆìƒ ì¶œë ¥:
# Received message created event from partition 0, offset 0: MessageCreatedEvent(...)
# Successfully processed message created event: messageId=1
```

---

### ë°©ë²• 2: Kafka Console Producerë¡œ ì§ì ‘ í…ŒìŠ¤íŠ¸

Kafka CLIë¥¼ ì‚¬ìš©í•˜ì—¬ ì§ì ‘ ë©”ì‹œì§€ë¥¼ ë°œí–‰í•©ë‹ˆë‹¤.

#### 2-1. ì˜¬ë°”ë¥¸ JSON í˜•ì‹ìœ¼ë¡œ ë©”ì‹œì§€ ë°œí–‰

```bash
# ë©”ì‹œì§€ ìƒì„± ì´ë²¤íŠ¸ ë°œí–‰
docker exec -it kafka kafka-console-producer \
  --bootstrap-server localhost:9092 \
  --topic message.created \
  --property "parse.key=true" \
  --property "key.separator=:"
```

**ì…ë ¥í•  ë‚´ìš© (í•œ ì¤„ì”©):**
```
1:{"messageId":1,"senderId":1,"receiverId":2,"content":"í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€","timestamp":"2026-01-12T08:00:00Z"}
2:{"messageId":2,"senderId":2,"receiverId":1,"content":"ë‹µì¥ì…ë‹ˆë‹¤","timestamp":"2026-01-12T08:01:00Z"}
```

ì¢…ë£Œ: `Ctrl+C`

#### 2-2. Consumerì—ì„œ ìˆ˜ì‹  í™•ì¸

```bash
docker-compose logs -f message-service | grep -i "received message"
```

**ì˜ˆìƒ ì¶œë ¥:**
```
Received message created event from partition 0, offset 0: MessageCreatedEvent(messageId=1, senderId=1, receiverId=2, content=í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€)
Successfully processed message created event: messageId=1
```

---

### ë°©ë²• 3: Kafka UIë¥¼ í†µí•œ í…ŒìŠ¤íŠ¸ (ê°€ì¥ ì‰¬ì›€)

#### 3-1. Kafka UI ì ‘ì†

ë¸Œë¼ìš°ì €ì—ì„œ ì—´ê¸°:
```
http://localhost:8090
```

#### 3-2. í† í”½ í™•ì¸

1. ì™¼ìª½ ë©”ë‰´ì—ì„œ **Topics** í´ë¦­
2. `message.created`, `message.read`, `message.deleted` í† í”½ í™•ì¸

#### 3-3. ë©”ì‹œì§€ ë°œí–‰

1. `message.created` í† í”½ í´ë¦­
2. **Produce Message** ë²„íŠ¼ í´ë¦­
3. **Key** ì…ë ¥: `1`
4. **Content** ì…ë ¥:
```json
{
  "messageId": 1,
  "senderId": 1,
  "receiverId": 2,
  "content": "Kafka UI í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€",
  "timestamp": "2026-01-12T08:00:00Z"
}
```
5. **Produce Message** ë²„íŠ¼ í´ë¦­

#### 3-4. Consumer í™•ì¸

```bash
docker-compose logs -f message-service
```

---

## ğŸ” í…ŒìŠ¤íŠ¸ ê²€ì¦

### 1. í† í”½ ë©”ì‹œì§€ í™•ì¸

```bash
# message.created í† í”½ì˜ ëª¨ë“  ë©”ì‹œì§€ ì½ê¸°
docker exec kafka kafka-console-consumer \
  --bootstrap-server localhost:9092 \
  --topic message.created \
  --from-beginning \
  --max-messages 10
```

### 2. Consumer ê·¸ë£¹ ìƒíƒœ í™•ì¸

```bash
docker exec kafka kafka-consumer-groups \
  --bootstrap-server localhost:9092 \
  --describe \
  --group message-service-group
```

**ì •ìƒ ìƒíƒœ:**
```
GROUP                  TOPIC           PARTITION  CURRENT-OFFSET  LOG-END-OFFSET  LAG
message-service-group  message.created 0          2               2               0
message-service-group  message.created 1          0               0               0
message-service-group  message.created 2          0               0               0
```

- **LAG = 0**: ëª¨ë“  ë©”ì‹œì§€ê°€ ì²˜ë¦¬ë¨ âœ…

### 3. ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸ í™•ì¸

```bash
# ì „ì²´ ì´ë²¤íŠ¸ ì²˜ë¦¬ ë¡œê·¸
docker-compose logs message-service | grep -E "(Published|Received|Successfully processed)"
```

**ì˜ˆìƒ ì¶œë ¥:**
```
Published message created event: messageId=1
Received message created event from partition 0, offset 0: MessageCreatedEvent(...)
Successfully processed message created event: messageId=1
```

---

## ğŸ“‹ ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### ì‹œë‚˜ë¦¬ì˜¤ 1: ë©”ì‹œì§€ ìƒì„± â†’ ì½ìŒ â†’ ì‚­ì œ

```bash
# 1. ë©”ì‹œì§€ ìƒì„±
curl -X POST http://localhost:8086/api/messages \
  -H "Content-Type: application/json" \
  -d '{
    "senderId": 1,
    "receiverId": 2,
    "content": "ì „ì²´ ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸"
  }'

# 2. ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬
curl -X PATCH http://localhost:8086/api/messages/1/read \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"

# 3. ë©”ì‹œì§€ ì‚­ì œ
curl -X DELETE http://localhost:8086/api/messages/1 \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

### ê° ë‹¨ê³„ì—ì„œ ë°œí–‰ë˜ëŠ” Kafka ì´ë²¤íŠ¸:

1. **message.created** â†’ MessageCreatedEvent
2. **message.read** â†’ MessageReadEvent
3. **message.deleted** â†’ MessageDeletedEvent

### ë¡œê·¸ í™•ì¸:

```bash
# ìƒì„± ì´ë²¤íŠ¸
docker-compose logs message-service | grep "message created"

# ì½ìŒ ì´ë²¤íŠ¸
docker-compose logs message-service | grep "message read"

# ì‚­ì œ ì´ë²¤íŠ¸
docker-compose logs message-service | grep "message deleted"
```

---

## ğŸ¯ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸

### ëŒ€ëŸ‰ ë©”ì‹œì§€ ë°œí–‰ í…ŒìŠ¤íŠ¸

```bash
# 100ê°œì˜ ë©”ì‹œì§€ ë°œí–‰
docker exec kafka kafka-producer-perf-test \
  --topic message.created \
  --num-records 100 \
  --record-size 256 \
  --throughput 10 \
  --producer-props bootstrap.servers=localhost:9092
```

### Consumer ì²˜ë¦¬ í™•ì¸

```bash
# Consumer lag ëª¨ë‹ˆí„°ë§
watch -n 1 'docker exec kafka kafka-consumer-groups \
  --bootstrap-server localhost:9092 \
  --describe \
  --group message-service-group'
```

---

## ğŸ› ë¬¸ì œ í•´ê²°

### ë¬¸ì œ 1: ë©”ì‹œì§€ê°€ Consumerì— ë„ë‹¬í•˜ì§€ ì•ŠìŒ

**í™•ì¸ì‚¬í•­:**
```bash
# 1. í† í”½ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
docker exec kafka kafka-topics --bootstrap-server localhost:9092 --list

# 2. Producerê°€ ì„±ê³µí–ˆëŠ”ì§€ í™•ì¸
docker-compose logs message-service | grep -i "published"

# 3. Consumerê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸
docker-compose logs message-service | grep -i "consumer"
```

### ë¬¸ì œ 2: ì—­ì§ë ¬í™” ì˜¤ë¥˜ ì¬ë°œ

**í•´ê²°:**
```bash
# í† í”½ ì¬ì´ˆê¸°í™”
./clean-kafka-topics.sh
```

### ë¬¸ì œ 3: Consumer lag ì¦ê°€

**ì›ì¸:** Consumer ì²˜ë¦¬ ì†ë„ < Producer ë°œí–‰ ì†ë„

**í•´ê²°:**
- Consumer ë™ì‹œì„± ì¦ê°€ (application.ymlì˜ concurrency ì„¤ì •)
- íŒŒí‹°ì…˜ ìˆ˜ ì¦ê°€

---

## âœ… í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸

ì™„ë£Œëœ í•­ëª©ì— ì²´í¬:

- [ ] Kafka í† í”½ ì´ˆê¸°í™” ì™„ë£Œ
- [ ] message-service ì •ìƒ ì‹œì‘ í™•ì¸
- [ ] ë©”ì‹œì§€ ìƒì„± API í…ŒìŠ¤íŠ¸ ì„±ê³µ
- [ ] message.created ì´ë²¤íŠ¸ ë°œí–‰ í™•ì¸
- [ ] Consumerì—ì„œ ì´ë²¤íŠ¸ ìˆ˜ì‹  í™•ì¸
- [ ] ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸
- [ ] message.read ì´ë²¤íŠ¸ í™•ì¸
- [ ] ë©”ì‹œì§€ ì‚­ì œ í…ŒìŠ¤íŠ¸
- [ ] message.deleted ì´ë²¤íŠ¸ í™•ì¸
- [ ] Consumer lag = 0 í™•ì¸
- [ ] ì—ëŸ¬ ë¡œê·¸ ì—†ìŒ

---

## ğŸ“Š ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ

### Kafka UI ëŒ€ì‹œë³´ë“œ

```
http://localhost:8090
```

**í™•ì¸ ê°€ëŠ¥í•œ ì •ë³´:**
- í† í”½ ëª©ë¡ ë° ìƒì„¸ ì •ë³´
- ë©”ì‹œì§€ ë‚´ìš©
- Consumer ê·¸ë£¹ ìƒíƒœ
- íŒŒí‹°ì…˜ ë¶„í¬
- Offset ì •ë³´

### ì‹¤ì‹œê°„ ë¡œê·¸ ëª¨ë‹ˆí„°ë§

```bash
# ëª¨ë“  Kafka ê´€ë ¨ ë¡œê·¸
docker-compose logs -f message-service | grep -i kafka

# ì´ë²¤íŠ¸ ì²˜ë¦¬ ë¡œê·¸ë§Œ
docker-compose logs -f message-service | grep -E "(Published|Received|processed)"
```

---

## ğŸ‰ ì„±ê³µ ê¸°ì¤€

ë‹¤ìŒê³¼ ê°™ì€ ë¡œê·¸ê°€ ë³´ì´ë©´ **í…ŒìŠ¤íŠ¸ ì„±ê³µ**ì…ë‹ˆë‹¤:

```
âœ… Published message created event: messageId=1
âœ… Received message created event from partition 0, offset 0
âœ… Successfully processed message created event: messageId=1
âœ… Consumer lag: 0
âœ… No errors in logs
```

---

## ğŸ“ ì¶”ê°€ í…ŒìŠ¤íŠ¸ ì•„ì´ë””ì–´

1. **ë™ì‹œì„± í…ŒìŠ¤íŠ¸**: ì—¬ëŸ¬ ì‚¬ìš©ìê°€ ë™ì‹œì— ë©”ì‹œì§€ ë°œì†¡
2. **ì¥ì•  ë³µêµ¬ í…ŒìŠ¤íŠ¸**: Kafka ì¬ì‹œì‘ í›„ ë©”ì‹œì§€ ì†ì‹¤ ì—¬ë¶€ í™•ì¸
3. **íŒŒí‹°ì…˜ ë¦¬ë°¸ëŸ°ì‹± í…ŒìŠ¤íŠ¸**: Consumer ìˆ˜ ë³€ê²½ ì‹œ ë™ì‘
4. **ì—ëŸ¬ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸**: ì˜ëª»ëœ í˜•ì‹ì˜ ë©”ì‹œì§€ ë°œí–‰ ì‹œ ErrorHandlingDeserializer ë™ì‘ í™•ì¸

---

**ì´ì œ ìœ„ì˜ ë°©ë²• ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•´ì„œ í…ŒìŠ¤íŠ¸ë¥¼ ì‹œì‘í•˜ì„¸ìš”!** ğŸš€
