# kafka 사용법

root@ip-172-31-43-60:/home/ubuntu# apt update
root@ip-172-31-43-60:/home/ubuntu# java -version

root@ip-172-31-43-60:/home/ubuntu# wget https://dlcdn.apache.org/kafka/4.0.0/kafka_2.13-4.0.0.tgz
root@ip-172-31-43-60:/home/ubuntu# tar -xzf kafka_2.13-4.0.0.tgz
root@ip-172-31-43-60:/home/ubuntu# cd kafka_2.13-4.0.0
root@ip-172-31-43-60:/home/ubuntu/kafka_2.13-4.0.0# export KAFKA_HEAP_OPTS="-Xmx400m -Xms400m"

root@ip-172-31-43-60:/home/ubuntu/kafka_2.13-4.0.0# dd if=/dev/zero of=/swapfile bs=128M count=16

root@ip-172-31-43-60:/home/ubuntu/kafka_2.13-4.0.0# chmod 600 /swapfile
root@ip-172-31-43-60:/home/ubuntu/kafka_2.13-4.0.0# mkswap /swapfile
root@ip-172-31-43-60:/home/ubuntu/kafka_2.13-4.0.0# swapon /swapfile

root@ip-172-31-43-60:/home/ubuntu/kafka_2.13-4.0.0# vi /etc/fstab
    - 마지막 라인 추가
```
LABEL=cloudimg-rootfs   /        ext4   discard,commit=30,errors=remount-ro     0 1
LABEL=BOOT      /boot   ext4    defaults        0 2
LABEL=UEFI      /boot/efi       vfat    umask=0077      0 1
/swapfile swap swap defaults 0 0
```

# 설정 확인 - 2G 정도의 swap memory 확인 가능
root@ip-172-31-43-60:/home/ubuntu/kafka_2.13-4.0.0# free
               total        used        free      shared  buff/cache   available
Mem:         3929044     2036944      218344        2848     1987356     1892100
Swap:        2097148           0     2097148

root@ip-172-31-43-60:/home/ubuntu/kafka_2.13-4.0.0# vi config/server.properties
```
advertised.listeners=PLAINTEXT://localhost:9092,CONTROLLER://localhost:9093

# AWS EC2의 public ip 주소로 변경.
advertised.listeners=PLAINTEXT://43.200.200.241:9092,CONTROLLER://43.200.200.241:9093
```

root@ip-172-31-43-60:/home/ubuntu/kafka_2.13-4.0.0# KAFKA_CLUSTER_ID="$(bin/kafka-storage.sh random-uuid)"

# 초기 로그 폴더가 /tmp/kraft-combined-logs에 setting 된다.
root@ip-172-31-43-60:/home/ubuntu/kafka_2.13-4.0.0# bin/kafka-storage.sh format --standalone -t $KAFKA_CLUSTER_ID -c config/server.properties
Formatting dynamic metadata voter directory /tmp/kraft-combined-logs with metadata.version 4.0-IV3.

# EC2 inbound 규칙에 9092, 9093을 추가한다.
# 아름 명령어 실행하면 kafka server staarted 메시지를 볼 수 있다.

root@ip-172-31-43-60:/home/ubuntu/kafka_2.13-4.0.0# bin/kafka-server-start.sh config/server.properties
~~~
[2025-12-23 07:27:26,292] INFO [KafkaRaftServer nodeId=1] Kafka Server started (kafka.server.KafkaRaftServer)

Ctrl+C 하면 중단된다.

# 백그라운드로 실행
root@ip-172-31-43-60:/home/ubuntu/kafka_2.13-4.0.0# bin/kafka-server-start.sh -daemon config/server.properties

# 로그 읽기
tail -f logs/kafkaServer.out

# 실행 프로세서 확인
lsof -i:9092
```
COMMAND    PID USER   FD   TYPE  DEVICE SIZE/OFF NODE NAME
java    277659 root  163u  IPv6 2271409      0t0  TCP *:9092 (LISTEN)
```

# 종료
bin/kafka-server-stop.sh

# Kafka 입문·실전
## 2.1. Kafka의 기본 구성 (Topic, Consumer, Producer)

topic : 카프카에 넣을 메시지의 종류를 구분하는 개념(즉, 카테고리)

## 2.2. 토픽 생성하기 조회하기 삭제하기

root@ip-172-31-43-60:/home/ubuntu/kafka_2.13-4.0.0# bin/kafka-topics.sh --bootstrap-server localhost:9092 --create --topic email.send
```
WARNING: Due to limitations in metric names, topics with a period ('.') or underscore ('_') could collide. To avoid issues it is best to use either, but not both.
Created topic email.send.
```

# 확인

root@ip-172-31-43-60:/home/ubuntu/kafka_2.13-4.0.0# bin/kafka-topics.sh --bootstrap-server localhost:9092 --list
```
email.send
```

# 세부 정보 확인

root@ip-172-31-43-60:/home/ubuntu/kafka_2.13-4.0.0# bin/kafka-topics.sh --bootstrap-server localhost:9092 --describe --topic email.send
```
Topic: email.send       TopicId: GArSUYBPSlKWm73028kXBg PartitionCount: 1       ReplicationFactor: 1    Configs: segment.bytes=1073741824
        Topic: email.send       Partition: 0    Leader: 1       Replicas: 1     Isr: 1  Elr:    LastKnownElr:
```

# 삭제

## 2.3. Kafka에 메시지 넣기 Kafka에서 메시지 조회하기

# 메시지 넣기 - key-value 쌍으로 넣을 수도 있고, value 만 넣을 수도 있다.

root@ip-172-31-43-60:/home/ubuntu/kafka_2.13-4.0.0# bin/kafka-console-producer.sh --bootstrap-server localhost:9092 --topic email.send
>hello1
>hello2
>hello 3
>^Croot@ip-172-31-43-60:/home/ubuntu/kafka_2.13-4.0.0#

# 읽어 오기 - RabbitMQ나 ActiveMQ 와 달리 Kafka는 여러번 읽어 올 수 있다.

root@ip-172-31-43-60:/home/ubuntu/kafka_2.13-4.0.0# bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic email.send --from-beginning
hello1
hello2
hello 3

# 읽어 오기 & 생산 하기

읽어오기(consumer)가 진행되는 동안에도 생산하기(producer)가 동시에 진행된다.

## 2.4. 메시지를 어디까지 읽었는 지 기억하고, 그 다음 메시지부터 처리하기 (Consumer Group, Offset)

root@ip-172-31-43-60:/home/ubuntu/kafka_2.13-4.0.0# bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic email.send --from-beginning --group email-send-group
hello1
hello2
hello 3

# consumer group 조회
root@ip-172-31-43-60:/home/ubuntu/kafka_2.13-4.0.0# bin/kafka-consumer-groups.sh --bootstrap-server localhost:9092 --list
```
email-send-group
```

# 세부 정보 확인
root@ip-172-31-43-60:/home/ubuntu/kafka_2.13-4.0.0# bin/kafka-consumer-groups.sh --bootstrap-server localhost:9092 -group email-send-group --describe

Consumer group 'email-send-group' has no active members.

GROUP            TOPIC           PARTITION  CURRENT-OFFSET  LOG-END-OFFSET  LAG             CONSUMER-ID     HOST            CLIENT-ID
email-send-group email.end       0          0               0               0               -               -               -
email-send-group email.send      0          3               3               0               -               -               -

# 한 개 추가
root@ip-172-31-43-60:/home/ubuntu/kafka_2.13-4.0.0# bin/kafka-console-producer.sh --bootstrap-server localhost:9092 --topic email.send
>hello5
>^C

# 다시 읽기 - email-send-groupoup 이 존재할 경우, from-beginning 무시하고 current-offset 부터 읽어 온다.

root@ip-172-31-43-60:/home/ubuntu/kafka_2.13-4.0.bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic email.send --from-beginning --group email-send-groupoup
hello5
^CProcessed a total of 1 messages

## 2.5. [실습] Spring Boot에 Kakfa 연결을 위한 코드 추가하기

- Sprong boot : Spring for Apache kafka 의존성 추가