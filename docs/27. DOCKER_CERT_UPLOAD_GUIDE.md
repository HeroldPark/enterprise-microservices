# Docker ì»¨í…Œì´ë„ˆì— AWS IoT ì¸ì¦ì„œ ì—…ë¡œë“œ ê°€ì´ë“œ

## ğŸ¯ ëª©í‘œ
AWS IoT ì¸ì¦ì„œ íŒŒì¼ì„ Docker ì»¨í…Œì´ë„ˆì˜ `/app/certs/` ë””ë ‰í† ë¦¬ì— ì—…ë¡œë“œ

---

## ğŸ“ í•„ìš”í•œ íŒŒì¼

AWS IoT Consoleì—ì„œ ë‹¤ìš´ë¡œë“œí•´ì•¼ í•  íŒŒì¼:
1. **certificate.pem.crt** - Thing Certificate (ë””ë°”ì´ìŠ¤ ì¸ì¦ì„œ)
2. **private.pem.key** - Private Key (ê°œì¸ í‚¤)
3. **AmazonRootCA1.pem** - Root CA Certificate (ë£¨íŠ¸ ì¸ì¦ì„œ)

---

## ğŸš€ ë°©ë²• 1: Volume Mount (ê¶Œì¥)

### ê°œë…
í˜¸ìŠ¤íŠ¸(ë¡œì»¬ PC)ì˜ ë””ë ‰í† ë¦¬ë¥¼ Docker ì»¨í…Œì´ë„ˆì— ì—°ê²°

```
ë¡œì»¬ PCì˜ certs/               Docker ì»¨í…Œì´ë„ˆì˜ /app/certs/
â”œâ”€â”€ certificate.pem.crt    â†’   â”œâ”€â”€ certificate.pem.crt
â”œâ”€â”€ private.pem.key        â†’   â”œâ”€â”€ private.pem.key
â””â”€â”€ AmazonRootCA1.pem      â†’   â””â”€â”€ AmazonRootCA1.pem
```

### ë‹¨ê³„ë³„ ì§„í–‰

#### 1. í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— certs ë””ë ‰í† ë¦¬ ìƒì„±
```bash
# docker-compose.ymlì´ ìˆëŠ” ë””ë ‰í† ë¦¬ì—ì„œ ì‹¤í–‰
mkdir -p certs
```

**ë””ë ‰í† ë¦¬ êµ¬ì¡°**:
```
your-project/
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ mqtt-service/
â”‚   â”œâ”€â”€ message-service/
â”‚   â””â”€â”€ ...
â””â”€â”€ certs/                    # â† ì—¬ê¸°ì— ìƒì„±
    â”œâ”€â”€ certificate.pem.crt   # â† ì¸ì¦ì„œ íŒŒì¼ ë°°ì¹˜
    â”œâ”€â”€ private.pem.key       # â† ê°œì¸ í‚¤ íŒŒì¼ ë°°ì¹˜
    â””â”€â”€ AmazonRootCA1.pem     # â† ë£¨íŠ¸ CA íŒŒì¼ ë°°ì¹˜
```

#### 2. AWS IoTì—ì„œ ì¸ì¦ì„œ ë‹¤ìš´ë¡œë“œ

**AWS Console ì ‘ì†**:
```
AWS Console â†’ IoT Core â†’ Manage â†’ Things â†’ [Your Thing] â†’ Security â†’ Certificates
```

**ë‹¤ìš´ë¡œë“œ**:
- âœ… Device certificate (certificate.pem.crt)
- âœ… Private key file (private.pem.key)
- âœ… Root CA certificate (AmazonRootCA1.pem)
  - https://www.amazontrust.com/repository/AmazonRootCA1.pem

#### 3. ë‹¤ìš´ë¡œë“œí•œ íŒŒì¼ì„ certs/ ë””ë ‰í† ë¦¬ì— ë³µì‚¬

**Windows (PowerShell)**:
```powershell
# ë‹¤ìš´ë¡œë“œ í´ë”ì—ì„œ certs í´ë”ë¡œ ë³µì‚¬
Copy-Item "C:\Users\YourName\Downloads\certificate.pem.crt" -Destination ".\certs\"
Copy-Item "C:\Users\YourName\Downloads\private.pem.key" -Destination ".\certs\"
Copy-Item "C:\Users\YourName\Downloads\AmazonRootCA1.pem" -Destination ".\certs\"
```

**Mac / Linux**:
```bash
# ë‹¤ìš´ë¡œë“œ í´ë”ì—ì„œ certs í´ë”ë¡œ ë³µì‚¬
cp ~/Downloads/certificate.pem.crt ./certs/
cp ~/Downloads/private.pem.key ./certs/
cp ~/Downloads/AmazonRootCA1.pem ./certs/
```

**ë˜ëŠ” ì§ì ‘ ì´ë™**:
- íŒŒì¼ íƒìƒ‰ê¸°ì—ì„œ ë‹¤ìš´ë¡œë“œí•œ íŒŒì¼ì„ `certs/` í´ë”ë¡œ ë“œë˜ê·¸ ì•¤ ë“œë¡­

#### 4. íŒŒì¼ ê¶Œí•œ ì„¤ì • (Mac/Linuxë§Œ í•´ë‹¹)
```bash
chmod 600 certs/private.pem.key       # ê°œì¸ í‚¤ëŠ” ì†Œìœ ìë§Œ ì½ê¸°
chmod 644 certs/certificate.pem.crt   # ì¸ì¦ì„œëŠ” ì½ê¸° ê°€ëŠ¥
chmod 644 certs/AmazonRootCA1.pem     # ë£¨íŠ¸ CAëŠ” ì½ê¸° ê°€ëŠ¥
```

**WindowsëŠ” ê¶Œí•œ ì„¤ì • ë¶ˆí•„ìš”**

#### 5. docker-compose.yml í™•ì¸
```yaml
mqtt-service:
  volumes:
    - ./certs:/app/certs:ro  # ì´ë¯¸ ì„¤ì •ë˜ì–´ ìˆìŒ
    #  ^^^^^ ë¡œì»¬ì˜ certs í´ë”
    #         ^^^^^^^^^ ì»¨í…Œì´ë„ˆì˜ /app/certs
    #                  ^^ ì½ê¸° ì „ìš© (read-only)
```

**í•´ì„**:
- `./certs`: docker-compose.ymlì´ ìˆëŠ” ìœ„ì¹˜ì˜ certs í´ë”
- `/app/certs`: ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì˜ ê²½ë¡œ
- `ro`: read-only (ì»¨í…Œì´ë„ˆì—ì„œ íŒŒì¼ ìˆ˜ì • ë¶ˆê°€)

#### 6. ì„œë¹„ìŠ¤ ì‹œì‘/ì¬ì‹œì‘
```bash
# ì„œë¹„ìŠ¤ ì¬ì‹œì‘
docker-compose restart mqtt-service

# ë˜ëŠ” ì „ì²´ ì¬ì‹œì‘
docker-compose down
docker-compose up -d
```

#### 7. ì¸ì¦ì„œ ë§ˆìš´íŠ¸ í™•ì¸
```bash
# ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì— íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
docker exec mqtt-service ls -la /app/certs

# ì˜ˆìƒ ì¶œë ¥:
# -rw-r--r-- 1 appuser appgroup 1220 Jan 16 01:00 certificate.pem.crt
# -rw------- 1 appuser appgroup 1675 Jan 16 01:00 private.pem.key
# -rw-r--r-- 1 appuser appgroup 1188 Jan 16 01:00 AmazonRootCA1.pem
```

#### 8. ë¡œê·¸ í™•ì¸
```bash
docker logs -f mqtt-service

# ì„±ê³µ ë¡œê·¸:
# "Initializing AWS IoT MQTT Client"
# "Endpoint: a2uullhbffujtb-ats.iot.ap-northeast-2.amazonaws.com"
# "AWS IoT MQTT Client initialized successfully"
# "Successfully connected to AWS IoT"
```

---

## ğŸš€ ë°©ë²• 2: Docker CP (ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆì— ë³µì‚¬)

ì»¨í…Œì´ë„ˆê°€ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì¼ ë•Œ íŒŒì¼ì„ ë³µì‚¬í•˜ëŠ” ë°©ë²•

### ë‹¨ê³„ë³„ ì§„í–‰

#### 1. ë¡œì»¬ì— ì„ì‹œ ë””ë ‰í† ë¦¬ ìƒì„±
```bash
mkdir -p temp-certs
```

#### 2. ì¸ì¦ì„œ íŒŒì¼ì„ ì„ì‹œ ë””ë ‰í† ë¦¬ì— ë³µì‚¬
```bash
cp ~/Downloads/certificate.pem.crt temp-certs/
cp ~/Downloads/private.pem.key temp-certs/
cp ~/Downloads/AmazonRootCA1.pem temp-certs/
```

#### 3. Docker ì»¨í…Œì´ë„ˆì— íŒŒì¼ ë³µì‚¬
```bash
# ê° íŒŒì¼ì„ ì»¨í…Œì´ë„ˆë¡œ ë³µì‚¬
docker cp temp-certs/certificate.pem.crt mqtt-service:/app/certs/
docker cp temp-certs/private.pem.key mqtt-service:/app/certs/
docker cp temp-certs/AmazonRootCA1.pem mqtt-service:/app/certs/
```

#### 4. ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ê¶Œí•œ ì„¤ì •
```bash
# ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ ì†Œìœ ì ë³€ê²½
docker exec -u root mqtt-service chown -R appuser:appgroup /app/certs
docker exec -u root mqtt-service chmod 600 /app/certs/private.pem.key
docker exec -u root mqtt-service chmod 644 /app/certs/certificate.pem.crt
docker exec -u root mqtt-service chmod 644 /app/certs/AmazonRootCA1.pem
```

#### 5. ì„œë¹„ìŠ¤ ì¬ì‹œì‘
```bash
docker-compose restart mqtt-service
```

**âš ï¸ ì£¼ì˜**: ì´ ë°©ë²•ì€ ì»¨í…Œì´ë„ˆë¥¼ ì¬ìƒì„±í•˜ë©´ íŒŒì¼ì´ ì‚¬ë¼ì§‘ë‹ˆë‹¤!

---

## ğŸš€ ë°©ë²• 3: Docker Imageì— í¬í•¨ (ë¹„ì¶”ì²œ)

### ê°œë…
Dockerfileì—ì„œ ì¸ì¦ì„œë¥¼ ì´ë¯¸ì§€ì— ì§ì ‘ í¬í•¨

**âš ï¸ ê²½ê³ **: ë³´ì•ˆìƒ ë§¤ìš° ìœ„í—˜! Gitì— ì»¤ë°‹ë˜ê±°ë‚˜ ì´ë¯¸ì§€ê°€ ìœ ì¶œë  ìˆ˜ ìˆìŒ

### Dockerfile ìˆ˜ì • (ì˜ˆì‹œë§Œ - ì‚¬ìš© ê¸ˆì§€)
```dockerfile
# âŒ ì ˆëŒ€ ì´ë ‡ê²Œ í•˜ì§€ ë§ˆì„¸ìš”!
COPY certs/ /app/certs/
```

**ëŒ€ì‹  ë°©ë²• 1 ì‚¬ìš©!**

---

## ğŸš€ ë°©ë²• 4: Docker Secret (Swarm/Kubernetes)

Docker Swarmì´ë‚˜ Kubernetesë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš°

### Docker Swarm
```bash
# Secret ìƒì„±
docker secret create mqtt_cert ./certs/certificate.pem.crt
docker secret create mqtt_key ./certs/private.pem.key
docker secret create mqtt_ca ./certs/AmazonRootCA1.pem

# docker-compose.ymlì—ì„œ ì‚¬ìš©
services:
  mqtt-service:
    secrets:
      - mqtt_cert
      - mqtt_key
      - mqtt_ca

secrets:
  mqtt_cert:
    external: true
  mqtt_key:
    external: true
  mqtt_ca:
    external: true
```

---

## ğŸ“‹ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ë°©ë²• 1 (Volume Mount) ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] `certs/` ë””ë ‰í† ë¦¬ ìƒì„±
- [ ] AWS IoTì—ì„œ 3ê°œ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
- [ ] íŒŒì¼ì„ `certs/` ë””ë ‰í† ë¦¬ì— ë³µì‚¬
- [ ] íŒŒì¼ëª… í™•ì¸:
  - [ ] certificate.pem.crt
  - [ ] private.pem.key
  - [ ] AmazonRootCA1.pem
- [ ] (Mac/Linux) íŒŒì¼ ê¶Œí•œ ì„¤ì •
- [ ] docker-compose.ymlì˜ volumes ì„¤ì • í™•ì¸
- [ ] ì„œë¹„ìŠ¤ ì¬ì‹œì‘
- [ ] ì»¨í…Œì´ë„ˆ ë‚´ë¶€ íŒŒì¼ í™•ì¸
- [ ] ë¡œê·¸ì—ì„œ ì—°ê²° ì„±ê³µ í™•ì¸

---

## ğŸ” ë¬¸ì œ í•´ê²°

### ë¬¸ì œ 1: íŒŒì¼ì´ ì—†ë‹¤ê³  ë‚˜ì˜´
```bash
# í™•ì¸
docker exec mqtt-service ls -la /app/certs

# ê²°ê³¼ê°€ ë¹„ì–´ìˆìœ¼ë©´
# 1. ë¡œì»¬ certs/ ë””ë ‰í† ë¦¬ í™•ì¸
ls -la certs/

# 2. docker-compose.ymlì˜ volumes ê²½ë¡œ í™•ì¸
# 3. ìƒëŒ€ ê²½ë¡œê°€ ë§ëŠ”ì§€ í™•ì¸ (./certs)
```

### ë¬¸ì œ 2: Permission Denied
```bash
# ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ê¶Œí•œ í™•ì¸
docker exec mqtt-service ls -la /app/certs

# rootë¡œ ê¶Œí•œ ë³€ê²½
docker exec -u root mqtt-service chown -R appuser:appgroup /app/certs
```

### ë¬¸ì œ 3: íŒŒì¼ëª…ì´ ë‹¤ë¦„
```bash
# ì‹¤ì œ íŒŒì¼ëª… í™•ì¸
ls -la certs/

# íŒŒì¼ëª… ë³€ê²½ (ì˜ˆ: ë‹¤ìš´ë¡œë“œ ì‹œ ë‹¤ë¥¸ ì´ë¦„ìœ¼ë¡œ ì €ì¥ëœ ê²½ìš°)
mv certs/xxxxx-certificate.pem.crt certs/certificate.pem.crt
mv certs/xxxxx-private.pem.key certs/private.pem.key
```

### ë¬¸ì œ 4: Windowsì—ì„œ ê²½ë¡œ ë¬¸ì œ
```powershell
# Windows PowerShellì—ì„œ ì ˆëŒ€ ê²½ë¡œ ì‚¬ìš©
docker-compose.yml ìˆ˜ì •:
volumes:
  - C:/Users/YourName/project/certs:/app/certs:ro
  # ë˜ëŠ”
  - ${PWD}/certs:/app/certs:ro
```

---

## ğŸ” ë³´ì•ˆ ì£¼ì˜ì‚¬í•­

### 1. Gitì— ì¸ì¦ì„œ ì—…ë¡œë“œ ê¸ˆì§€
**.gitignore íŒŒì¼ì— ì¶”ê°€**:
```gitignore
# AWS IoT Certificates
certs/
*.pem
*.crt
*.key
```

### 2. ë°±ì—…
```bash
# ì•ˆì „í•œ ìœ„ì¹˜ì— ì¸ì¦ì„œ ë°±ì—…
# (ì™¸ë¶€ ì €ì¥ì†Œ, ì•”í˜¸í™”ëœ USB ë“±)
cp -r certs/ /secure/backup/location/
```

### 3. ê¶Œí•œ ê´€ë¦¬
```bash
# ê°œì¸ í‚¤ëŠ” ì ˆëŒ€ ê³µìœ í•˜ì§€ ì•Šê¸°
chmod 600 certs/private.pem.key
```

---

## ğŸ‰ ìµœì¢… í™•ì¸

### 1. íŒŒì¼ ì¡´ì¬ í™•ì¸
```bash
# ë¡œì»¬
ls -la certs/
# ì˜ˆìƒ: certificate.pem.crt, private.pem.key, AmazonRootCA1.pem

# ì»¨í…Œì´ë„ˆ
docker exec mqtt-service ls -la /app/certs
# ì˜ˆìƒ: ë™ì¼í•œ 3ê°œ íŒŒì¼
```

### 2. ì„œë¹„ìŠ¤ ì •ìƒ ì‘ë™ í™•ì¸
```bash
# Health check
curl http://localhost:8088/actuator/health

# ì˜ˆìƒ ê²°ê³¼:
# {"status":"UP"}
```

### 3. AWS IoT ì—°ê²° í™•ì¸
```bash
# ë¡œê·¸ í™•ì¸
docker logs mqtt-service | grep "Successfully connected"

# ì˜ˆìƒ:
# "Successfully connected to AWS IoT and subscribed to topics"
```

---

## ğŸ“ ìš”ì•½

**ê°€ì¥ ì‰¬ìš´ ë°©ë²• (ë°©ë²• 1 ê¶Œì¥)**:
1. í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— `certs/` í´ë” ë§Œë“¤ê¸°
2. AWS IoTì—ì„œ ë‹¤ìš´ë¡œë“œí•œ 3ê°œ íŒŒì¼ ë³µì‚¬
3. `docker-compose restart mqtt-service`
4. ë¡œê·¸ í™•ì¸

**ë!** ğŸŠ
