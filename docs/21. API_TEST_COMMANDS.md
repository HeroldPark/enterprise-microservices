# Message Service REST API í…ŒìŠ¤íŠ¸ ëª…ë ¹ì–´ ëª¨ìŒ

## ğŸ” JWT í† í° ì—†ì´ í…ŒìŠ¤íŠ¸ (ê°œë°œ í™˜ê²½)

```
http://localhost:8086 ìœ¼ë¡œ ì ‘ì†í•˜ëŠ” ê²ƒì€ ë‚´ë¶€ì—ì„œ ì ‘ì†í•˜ëŠ” ê²ƒì´ë¯€ë¡œ /api ì—†ëŠ” ëª…ë ¹ì–´ê°€ ë§ë‹¤.
http://localhost:8080 ìœ¼ë¡œ ì ‘ì†í•˜ëŠ” ê²ƒì€ ì™¸ë¶€ì—ì„œ ì ‘ì†í•˜ëŠ” ê²ƒì´ë¯€ë¡œ /api ê°€ ìˆì–´ì•¼ í•œë‹¤.

YOUR_JWT_TOKEN : eyJhbGciOiJIUzUxMiJ9.eyJyb2xlIjoiQURNSU4iLCJzdWIiOiJhZG1pbiIsImlhdCI6MTc2ODIwNDcxMSwiZXhwIjoxNzY4MjkxMTExfQ.bjvSAldMbqGnSRKyvRBqp0Ym8QHHro8-jKD4vqKbu-dYFyCxOJUfo1kTqg_vOC6MRuVhkNmxHx-UhwcpsErq-w
```

### 1. ë©”ì‹œì§€ ìƒì„±

```bash
curl -X POST http://localhost:8086/api/messages \
  -H "Content-Type: application/json" \
  -d '{
    "senderId": 1,
    "receiverId": 2,
    "content": "ì•ˆë…•í•˜ì„¸ìš”! ì²« ë²ˆì§¸ ë©”ì‹œì§€ì…ë‹ˆë‹¤."
  }'
```

### 2. ë©”ì‹œì§€ ëª©ë¡ ì¡°íšŒ (ìˆ˜ì‹ ìë³„)

```bash
# ì‚¬ìš©ì 2ê°€ ë°›ì€ ë©”ì‹œì§€ ì¡°íšŒ
curl -X GET "http://localhost:8086/api/messages?receiverId=2"
```

### 3. ë©”ì‹œì§€ ìƒì„¸ ì¡°íšŒ

```bash
curl -X GET http://localhost:8086/api/messages/1
```

### 4. ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬

```bash
curl -X PATCH http://localhost:8086/api/messages/1/read
```

### 5. ë©”ì‹œì§€ ì‚­ì œ

```bash
curl -X DELETE http://localhost:8086/api/messages/1
```

---

## ğŸ”’ JWT í† í°ì„ ì‚¬ìš©í•œ í…ŒìŠ¤íŠ¸ (í”„ë¡œë•ì…˜ í™˜ê²½)

### í† í° ë°œê¸‰ (user-service í•„ìš”)

```bash
# ë¡œê·¸ì¸í•˜ì—¬ JWT í† í° ë°›ê¸°
TOKEN=$(curl -X POST http://localhost:8081/api/users/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "user1",
    "password": "password123"
  }' | jq -r '.token')

echo "JWT Token: $TOKEN"
```

### ì¸ì¦ì´ í•„ìš”í•œ API í˜¸ì¶œ

```bash
# ë©”ì‹œì§€ ìƒì„±
curl -X POST http://localhost:8086/api/messages \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "senderId": 1,
    "receiverId": 2,
    "content": "ì¸ì¦ëœ ì‚¬ìš©ìì˜ ë©”ì‹œì§€ì…ë‹ˆë‹¤."
  }'

# ë©”ì‹œì§€ ì¡°íšŒ
curl -X GET "http://localhost:8086/api/messages?receiverId=2" \
  -H "Authorization: Bearer $TOKEN"

# ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬
curl -X PATCH http://localhost:8086/api/messages/1/read \
  -H "Authorization: Bearer $TOKEN"

# ë©”ì‹œì§€ ì‚­ì œ
curl -X DELETE http://localhost:8086/api/messages/1 \
  -H "Authorization: Bearer $TOKEN"
```

---

## ğŸ“Š ëŒ€ëŸ‰ ë©”ì‹œì§€ í…ŒìŠ¤íŠ¸

### Bash ìŠ¤í¬ë¦½íŠ¸ë¡œ 100ê°œ ë©”ì‹œì§€ ìƒì„±

```bash
#!/bin/bash

for i in {1..100}
do
  curl -X POST http://localhost:8086/api/messages \
    -H "Content-Type: application/json" \
    -d "{
      \"senderId\": $((i % 10 + 1)),
      \"receiverId\": $((i % 5 + 1)),
      \"content\": \"ëŒ€ëŸ‰ í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ #$i\"
    }" &
done

wait
echo "100ê°œ ë©”ì‹œì§€ ë°œì†¡ ì™„ë£Œ!"
```

---

## ğŸ¯ ì‹œë‚˜ë¦¬ì˜¤ë³„ í…ŒìŠ¤íŠ¸

### ì‹œë‚˜ë¦¬ì˜¤ 1: 1:1 ì±„íŒ… ì‹œë®¬ë ˆì´ì…˜

```bash
# User 1 â†’ User 2
curl -X POST http://localhost:8086/api/messages \
  -H "Content-Type: application/json" \
  -d '{
    "senderId": 1,
    "receiverId": 2,
    "content": "ì•ˆë…•í•˜ì„¸ìš”!"
  }'

sleep 2

# User 2 â†’ User 1 (ë‹µì¥)
curl -X POST http://localhost:8086/api/messages \
  -H "Content-Type: application/json" \
  -d '{
    "senderId": 2,
    "receiverId": 1,
    "content": "ë„¤, ì•ˆë…•í•˜ì„¸ìš”! ë°˜ê°‘ìŠµë‹ˆë‹¤."
  }'

sleep 2

# User 1ì´ ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬
curl -X PATCH http://localhost:8086/api/messages/2/read
```

### ì‹œë‚˜ë¦¬ì˜¤ 2: ê·¸ë£¹ ë©”ì‹œì§€

```bash
# User 1ì´ ì—¬ëŸ¬ ì‚¬ëŒì—ê²Œ ë©”ì‹œì§€ ë°œì†¡
for receiver in 2 3 4 5
do
  curl -X POST http://localhost:8086/api/messages \
    -H "Content-Type: application/json" \
    -d "{
      \"senderId\": 1,
      \"receiverId\": $receiver,
      \"content\": \"ê·¸ë£¹ ê³µì§€: ë‚´ì¼ íšŒì˜ê°€ ìˆìŠµë‹ˆë‹¤.\"
    }"
  sleep 1
done
```

### ì‹œë‚˜ë¦¬ì˜¤ 3: ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ì¡°íšŒ ë° ì½ìŒ ì²˜ë¦¬

```bash
# 1. User 2ê°€ ë°›ì€ ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ì¡°íšŒ
UNREAD=$(curl -s -X GET "http://localhost:8086/api/messages?receiverId=2&isRead=false")
echo "ì½ì§€ ì•Šì€ ë©”ì‹œì§€: $UNREAD"

# 2. ëª¨ë“  ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬ (jq í•„ìš”)
echo "$UNREAD" | jq -r '.[].id' | while read msgId
do
  echo "ë©”ì‹œì§€ $msgId ì½ìŒ ì²˜ë¦¬ ì¤‘..."
  curl -X PATCH http://localhost:8086/api/messages/$msgId/read
  sleep 0.5
done
```

---

## ğŸ” Kafka ì´ë²¤íŠ¸ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§

### í„°ë¯¸ë„ 1: API í˜¸ì¶œ

```bash
# ë©”ì‹œì§€ ìƒì„±
curl -X POST http://localhost:8086/api/messages \
  -H "Content-Type: application/json" \
  -d '{
    "senderId": 1,
    "receiverId": 2,
    "content": "Kafka ì´ë²¤íŠ¸ í…ŒìŠ¤íŠ¸"
  }'
```

### í„°ë¯¸ë„ 2: ë¡œê·¸ ëª¨ë‹ˆí„°ë§

```bash
# Kafka ì´ë²¤íŠ¸ ë°œí–‰/ìˆ˜ì‹  ë¡œê·¸ ì‹¤ì‹œê°„ í™•ì¸
docker-compose logs -f message-service | grep -E "(Published|Received|processed)"
```

### í„°ë¯¸ë„ 3: Kafka í† í”½ ëª¨ë‹ˆí„°ë§

```bash
# message.created í† í”½ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§
docker exec kafka kafka-console-consumer \
  --bootstrap-server localhost:9092 \
  --topic message.created \
  --from-beginning
```

---

## ğŸ“ˆ ì„±ëŠ¥ ì¸¡ì •

### Apache Bench (ab) ì‚¬ìš©

```bash
# ë™ì‹œ 10ëª…ì´ 100ê°œ ìš”ì²­
ab -n 100 -c 10 -p message.json -T application/json \
  http://localhost:8086/api/messages

# message.json íŒŒì¼ ë‚´ìš©:
# {
#   "senderId": 1,
#   "receiverId": 2,
#   "content": "ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€"
# }
```

### wrk ì‚¬ìš© (ë” ê°•ë ¥í•œ ë¶€í•˜ í…ŒìŠ¤íŠ¸)

```bash
# 30ì´ˆ ë™ì•ˆ 10ê°œ ì—°ê²°ë¡œ ë¶€í•˜ í…ŒìŠ¤íŠ¸
wrk -t10 -c10 -d30s -s post.lua http://localhost:8086/api/messages

# post.lua íŒŒì¼ ë‚´ìš©:
# wrk.method = "POST"
# wrk.headers["Content-Type"] = "application/json"
# wrk.body = '{"senderId":1,"receiverId":2,"content":"wrk í…ŒìŠ¤íŠ¸"}'
```

---

## ğŸ› ë””ë²„ê¹… ëª…ë ¹ì–´

### ìµœê·¼ ì—ëŸ¬ í™•ì¸

```bash
docker-compose logs message-service | grep -i error | tail -20
```

### íŠ¹ì • ë©”ì‹œì§€ ID ì¶”ì 

```bash
# ë©”ì‹œì§€ ID 1ë²ˆ ê´€ë ¨ ëª¨ë“  ë¡œê·¸
docker-compose logs message-service | grep "messageId=1"
```

### Kafka Consumer lag í™•ì¸

```bash
docker exec kafka kafka-consumer-groups \
  --bootstrap-server localhost:9092 \
  --describe \
  --group message-service-group
```

### ë°ì´í„°ë² ì´ìŠ¤ í™•ì¸

```bash
# MariaDB ì ‘ì†
docker exec -it mariadb-message mysql -urozeta -prozeta123 message-db

# ë©”ì‹œì§€ í…Œì´ë¸” ì¡°íšŒ
mysql> SELECT * FROM messages ORDER BY created_at DESC LIMIT 10;
```

---

## âœ… ìë™ í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸

### ì „ì²´ ì›Œí¬í”Œë¡œìš° í…ŒìŠ¤íŠ¸

```bash
#!/bin/bash

echo "=== Message Service ì „ì²´ ì›Œí¬í”Œë¡œìš° í…ŒìŠ¤íŠ¸ ==="

# 1. ë©”ì‹œì§€ ìƒì„±
echo "1. ë©”ì‹œì§€ ìƒì„± ì¤‘..."
MSG_ID=$(curl -s -X POST http://localhost:8086/api/messages \
  -H "Content-Type: application/json" \
  -d '{
    "senderId": 1,
    "receiverId": 2,
    "content": "ì „ì²´ ì›Œí¬í”Œë¡œìš° í…ŒìŠ¤íŠ¸"
  }' | jq -r '.id')

echo "   ìƒì„±ëœ ë©”ì‹œì§€ ID: $MSG_ID"
sleep 2

# 2. ë©”ì‹œì§€ ì¡°íšŒ
echo "2. ë©”ì‹œì§€ ì¡°íšŒ ì¤‘..."
curl -s -X GET http://localhost:8086/api/messages/$MSG_ID | jq '.'
sleep 1

# 3. ì½ìŒ ì²˜ë¦¬
echo "3. ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬ ì¤‘..."
curl -s -X PATCH http://localhost:8086/api/messages/$MSG_ID/read | jq '.'
sleep 1

# 4. Kafka ì´ë²¤íŠ¸ í™•ì¸
echo "4. Kafka ì´ë²¤íŠ¸ ë¡œê·¸ í™•ì¸..."
docker-compose logs message-service | grep "messageId=$MSG_ID" | tail -5

# 5. ë©”ì‹œì§€ ì‚­ì œ
echo "5. ë©”ì‹œì§€ ì‚­ì œ ì¤‘..."
curl -s -X DELETE http://localhost:8086/api/messages/$MSG_ID
sleep 1

echo ""
echo "=== í…ŒìŠ¤íŠ¸ ì™„ë£Œ ==="
```

---

## ğŸ“± Postman Collection

ìœ„ì˜ APIë¥¼ Postmanì—ì„œ í…ŒìŠ¤íŠ¸í•˜ë ¤ë©´:

1. **New Collection** ìƒì„±
2. ê° ì—”ë“œí¬ì¸íŠ¸ë¥¼ Requestë¡œ ì¶”ê°€:
   - POST `/api/messages` - ë©”ì‹œì§€ ìƒì„±
   - GET `/api/messages` - ë©”ì‹œì§€ ëª©ë¡
   - GET `/api/messages/:id` - ë©”ì‹œì§€ ìƒì„¸
   - PATCH `/api/messages/:id/read` - ì½ìŒ ì²˜ë¦¬
   - DELETE `/api/messages/:id` - ë©”ì‹œì§€ ì‚­ì œ
3. **Environment Variables** ì„¤ì •:
   - `base_url`: http://localhost:8086
   - `token`: (JWT í† í°)

---

**ì´ì œ ìœ„ì˜ ëª…ë ¹ì–´ë“¤ì„ ì‚¬ìš©í•´ì„œ Message Serviceë¥¼ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”!** ğŸš€
