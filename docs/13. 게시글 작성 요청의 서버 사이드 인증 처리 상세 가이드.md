# ê²Œì‹œê¸€ ì‘ì„± ìš”ì²­ì˜ ì„œë²„ ì‚¬ì´ë“œ ì¸ì¦ ì²˜ë¦¬ ìƒì„¸ ê°€ì´ë“œ

## ğŸ“‹ ëª©ì°¨
1. [ì „ì²´ ì•„í‚¤í…ì²˜](#ì „ì²´-ì•„í‚¤í…ì²˜)
2. [í´ë¼ì´ì–¸íŠ¸ ìš”ì²­](#1-í´ë¼ì´ì–¸íŠ¸-ìš”ì²­)
3. [Nginx í”„ë¡ì‹œ](#2-nginx-í”„ë¡ì‹œ)
4. [API Gateway ì²˜ë¦¬](#3-api-gateway-ì²˜ë¦¬)
5. [Board Service ì¸ì¦](#4-board-service-ì¸ì¦-í•µì‹¬)
6. [ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥](#5-ë°ì´í„°ë² ì´ìŠ¤-ì €ì¥)
7. [ì‘ë‹µ ë°˜í™˜](#6-ì‘ë‹µ-ë°˜í™˜)
8. [ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨](#ì‹œí€€ìŠ¤-ë‹¤ì´ì–´ê·¸ë¨)
9. [ì½”ë“œ ë ˆë²¨ ìƒì„¸ ë¶„ì„](#ì½”ë“œ-ë ˆë²¨-ìƒì„¸-ë¶„ì„)

---

## ì „ì²´ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser   â”‚
â”‚ (React App) â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ POST /api/boards + JWT
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Nginx (Frontend)    â”‚
â”‚  Port: 3000          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Proxy to API Gateway
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Gateway         â”‚
â”‚  Port: 8080          â”‚
â”‚  - CORS âœ…           â”‚
â”‚  - Security âœ…       â”‚
â”‚  - Routing âœ…        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Load Balance via Eureka
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Board Service               â”‚
â”‚  Port: 8084                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ JWT Authentication      â”‚ â”‚
â”‚  â”‚ Filter (í•µì‹¬!)          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Security Filter Chain   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Board Controller        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MariaDB             â”‚
â”‚  Port: 13309         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 1. í´ë¼ì´ì–¸íŠ¸ ìš”ì²­

### 1.1 React Component (BoardCreate.jsx)

```javascript
// ì‚¬ìš©ìê°€ "Create Post" ë²„íŠ¼ í´ë¦­
const handleSubmit = (e) => {
  e.preventDefault()
  
  const boardData = {
    title: "ê²Œì‹œê¸€ ì œëª©",
    content: "ê²Œì‹œê¸€ ë‚´ìš©",
    author: "admin"
  }
  
  createMutation.mutate({ boardData, files })
}
```

### 1.2 Service Layer (boardService.js)

```javascript
// Axiosë¥¼ í†µí•œ API í˜¸ì¶œ
export const boardService = {
  createBoard: async (boardData) => {
    const response = await api.post('/boards', boardData)
    return response.data
  }
}
```

### 1.3 Axios Interceptor (api.js)

```javascript
// âœ… JWT í† í° ìë™ ì¶”ê°€
api.interceptors.request.use((config) => {
  // 1. localStorageì—ì„œ JWT í† í° ê°€ì ¸ì˜¤ê¸°
  let token = localStorage.getItem('token')
  
  // 2. ì—†ìœ¼ë©´ Zustand persist storageì—ì„œ ê°€ì ¸ì˜¤ê¸°
  if (!token) {
    const authData = localStorage.getItem('auth-storage')
    if (authData) {
      const parsed = JSON.parse(authData)
      token = parsed?.state?.token
    }
  }
  
  // 3. Authorization í—¤ë”ì— ì¶”ê°€
  if (token) {
    config.headers.Authorization = `Bearer ${token}`
    console.log('âœ… JWT token added to request')
  }
  
  return config
})
```

### 1.4 ì‹¤ì œ HTTP ìš”ì²­

```http
POST http://localhost:3000/api/boards
Host: localhost:3000
Content-Type: application/json
Authorization: Bearer eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJhZG1pbiIsImlhdCI6MTc2NzIzMzc1MSwiZXhwIjoxNzY3MzIwMTUxfQ.wZceooNCoon4j95l_8RaEBP909ErGFk9BvW76vt5ZrI06FzToOphoWDAWztOdi-fDb6HMSjUonIb14MlRP7nGg

{
  "title": "ê²Œì‹œê¸€ ì œëª©",
  "content": "ê²Œì‹œê¸€ ë‚´ìš©",
  "author": "admin"
}
```

**ë¡œê·¸ ì¶œë ¥:**
```javascript
console.log('ğŸš€ POST /api/boards')
console.log('ğŸ“¦ Data:', boardData)
console.log('ğŸ”‘ Token:', token.substring(0, 30) + '...')
```

---

## 2. Nginx í”„ë¡ì‹œ

### 2.1 Nginx ì„¤ì • (nginx.conf)

```nginx
location /api/ {
    proxy_pass http://api-gateway:8080/api/;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}
```

### 2.2 í”„ë¡ì‹œ ì²˜ë¦¬

```
1. ìš”ì²­ ìˆ˜ì‹ : POST /api/boards
2. ë§¤ì¹­: location /api/ ê·œì¹™
3. í”„ë¡ì‹œ ëŒ€ìƒ: http://api-gateway:8080/api/boards
4. í—¤ë” ì „ë‹¬:
   - Authorization: Bearer eyJ... (âœ… JWT í† í° ìœ ì§€)
   - Host: api-gateway:8080
   - X-Real-IP: 172.18.0.1
   - X-Forwarded-For: 172.18.0.1
```

### 2.3 ì „ë‹¬ë˜ëŠ” ìš”ì²­

```http
POST http://api-gateway:8080/api/boards
Host: api-gateway:8080
Content-Type: application/json
Authorization: Bearer eyJhbGciOiJIUzUxMiJ9...
X-Real-IP: 172.18.0.1
X-Forwarded-For: 172.18.0.1

{
  "title": "ê²Œì‹œê¸€ ì œëª©",
  "content": "ê²Œì‹œê¸€ ë‚´ìš©",
  "author": "admin"
}
```

**Nginx ë¡œê·¸:**
```
172.18.0.1 - - [01/Jan/2026:03:32:47 +0000] 
"POST /api/boards HTTP/1.1" 201 245 
"http://localhost:3000/boards/create" 
"Mozilla/5.0..."
```

---

## 3. API Gateway ì²˜ë¦¬

### 3.1 CORS Filter (Order 1)

```java
// GlobalCorsConfiguration
@Bean
public CorsWebFilter corsWebFilter() {
    CorsConfiguration config = new CorsConfiguration();
    config.setAllowedOrigins(Arrays.asList("http://localhost:3000"));
    config.setAllowedMethods(Arrays.asList("*"));
    config.setAllowedHeaders(Arrays.asList("*"));
    config.setAllowCredentials(true);
    // ...
}
```

**ì²˜ë¦¬:**
```
âœ… Origin Check: http://localhost:3000 â†’ í—ˆìš©
âœ… Method Check: POST â†’ í—ˆìš©
âœ… Headers Check: Authorization â†’ í—ˆìš©
â†’ CORS í†µê³¼
```

**ë¡œê·¸:**
```
DEBUG CorsWebFilter : CORS request: POST /api/boards
DEBUG CorsWebFilter : CORS configuration: allowedOrigins=[http://localhost:3000]
DEBUG CorsWebFilter : CORS check passed
```

### 3.2 Security Filter (Order 2)

```java
// SecurityConfig.java
@Bean
public SecurityWebFilterChain securityWebFilterChain(ServerHttpSecurity http) {
    return http
        .csrf(csrf -> csrf.disable())
        .authorizeExchange(exchanges -> exchanges
            .anyExchange().permitAll()  // âœ… ëª¨ë“  ìš”ì²­ í—ˆìš©
        )
        .build();
}
```

**ì²˜ë¦¬:**
```
âœ… CSRF Check: ë¹„í™œì„±í™”
âœ… Authorization: permitAll() â†’ í†µê³¼
â†’ Security Filter í†µê³¼ (ì¸ì¦ ì²´í¬ ì•ˆ í•¨)
```

**ë¡œê·¸:**
```
DEBUG SecurityWebFilterChain : Securing POST /api/boards
DEBUG AuthorizationWebFilter : Authorization successful (permitAll)
```

### 3.3 Route Matching & Load Balancing

```yaml
# application.yml (ì»¤ìŠ¤í…€ ì„¤ì •)
gateway:
  routes:
    board:
      service-uri: lb://board-service
      api-path: /api/boards/**
```

**ì²˜ë¦¬:**
```
1. Discovery Locator: enabled
2. Eureka ì¡°íšŒ: GET http://eureka-server:8761/eureka/apps/BOARD-SERVICE
3. ì‚¬ìš© ê°€ëŠ¥ ì¸ìŠ¤í„´ìŠ¤:
   - board-service:8084 (status: UP)
4. Load Balancing: Round Robin
5. ì„ íƒëœ ì¸ìŠ¤í„´ìŠ¤: http://board-service:8084
```

**ë¡œê·¸:**
```
DEBUG RoutePredicateHandlerMapping : Route matched: ReactiveCompositeDiscoveryClient_BOARD-SERVICE
DEBUG LoadBalancerClientFilter : LoadBalancer has retrieved service instances
DEBUG ReactorLoadBalancer : Selected instance: board-service:8084
```

### 3.4 Path Rewriting (StripPrefix)

```yaml
gateway:
  routes:
    strip-prefix: 1  # /api ì œê±°
```

**ë³€í™˜:**
```
Original:  POST /api/boards
After:     POST /boards
```

**ë¡œê·¸:**
```
DEBUG StripPrefixGatewayFilterFactory : Stripping 1 path elements from /api/boards
DEBUG StripPrefixGatewayFilterFactory : New path: /boards
```

### 3.5 ìµœì¢… ì „ë‹¬

```http
POST http://board-service:8084/boards
Host: board-service:8084
Content-Type: application/json
Authorization: Bearer eyJhbGciOiJIUzUxMiJ9...  â† âœ… JWT í† í° ê·¸ëŒ€ë¡œ ì „ë‹¬

{
  "title": "ê²Œì‹œê¸€ ì œëª©",
  "content": "ê²Œì‹œê¸€ ë‚´ìš©",
  "author": "admin"
}
```

**Gateway ë¡œê·¸:**
```
DEBUG NettyRoutingFilter : Outbound route: http://board-service:8084/boards
DEBUG NettyRoutingFilter : Request headers: 
  - Authorization: Bearer eyJ...
  - Content-Type: application/json
```

---

## 4. Board Service ì¸ì¦ (í•µì‹¬!)

### 4.1 ìš”ì²­ ìˆ˜ì‹ 

```java
// DispatcherServlet
INFO  DispatcherServlet : POST "/boards", parameters={}
DEBUG DispatcherServlet : Mapped to BoardController.createBoard()
```

### 4.2 JwtAuthenticationFilter (OncePerRequestFilter)

```java
@Slf4j
@Component
@RequiredArgsConstructor
public class JwtAuthenticationFilter extends OncePerRequestFilter {

    private final JwtUtil jwtUtil;

    @Override
    protected void doFilterInternal(
            HttpServletRequest request,
            HttpServletResponse response,
            FilterChain filterChain) throws ServletException, IOException {
        
        String path = request.getRequestURI();
        String method = request.getMethod();
        
        log.debug("ğŸ” Processing request: {} {}", method, path);
        // ì¶œë ¥: ğŸ” Processing request: POST /boards
        
        // ========================================
        // STEP 1: Authorization í—¤ë” ì¶”ì¶œ
        // ========================================
        String authHeader = request.getHeader("Authorization");
        
        if (authHeader == null || !authHeader.startsWith("Bearer ")) {
            log.debug("âŒ No JWT token found in request headers");
            filterChain.doFilter(request, response);
            return;
        }
        
        log.debug("âœ… Authorization header found");
        
        try {
            // ========================================
            // STEP 2: Bearer í† í° ì¶”ì¶œ
            // ========================================
            String token = authHeader.substring(7);  // "Bearer " ì œê±°
            log.debug("ğŸ”‘ JWT token: {}...", token.substring(0, 20));
            // ì¶œë ¥: ğŸ”‘ JWT token: eyJhbGciOiJIUzUxMiJ9...
            
            // ========================================
            // STEP 3: JWT í† í° ê²€ì¦
            // ========================================
            if (!jwtUtil.validateToken(token)) {
                log.warn("âš ï¸ Invalid or expired JWT token");
                response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
                response.setContentType("application/json");
                response.getWriter().write("{\"error\":\"Invalid or expired token\"}");
                return;
            }
            
            log.info("âœ… JWT token validation successful");
            
            // ========================================
            // STEP 4: ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ
            // ========================================
            String username = jwtUtil.extractUsername(token);
            log.info("ğŸ‘¤ Authenticated user: {}", username);
            // ì¶œë ¥: ğŸ‘¤ Authenticated user: admin
            
            // ========================================
            // STEP 5: Spring Security Context ì„¤ì •
            // ========================================
            UsernamePasswordAuthenticationToken authentication = 
                new UsernamePasswordAuthenticationToken(
                    username,
                    null,
                    Collections.singletonList(new SimpleGrantedAuthority("ROLE_USER"))
                );
            
            authentication.setDetails(
                new WebAuthenticationDetailsSource().buildDetails(request)
            );
            
            SecurityContextHolder.getContext().setAuthentication(authentication);
            
            log.debug("ğŸ” Security context updated for user: {}", username);
            // ì¶œë ¥: ğŸ” Security context updated for user: admin
            
        } catch (Exception e) {
            log.error("âŒ JWT authentication failed: {}", e.getMessage());
            response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
            response.setContentType("application/json");
            response.getWriter().write("{\"error\":\"Authentication failed\"}");
            return;
        }
        
        // ========================================
        // STEP 6: ë‹¤ìŒ í•„í„°ë¡œ ì§„í–‰
        // ========================================
        filterChain.doFilter(request, response);
    }
}
```

**ìƒì„¸ ë¡œê·¸ ì¶œë ¥:**
```
DEBUG JwtAuthenticationFilter : ğŸ” Processing request: POST /boards
DEBUG JwtAuthenticationFilter : âœ… Authorization header found
DEBUG JwtAuthenticationFilter : ğŸ”‘ JWT token: eyJhbGciOiJIUzUxMiJ9...
DEBUG JwtUtil : Parsing JWT token...
DEBUG JwtUtil : Token signature verified
DEBUG JwtUtil : Token not expired
INFO  JwtAuthenticationFilter : âœ… JWT token validation successful
INFO  JwtAuthenticationFilter : ğŸ‘¤ Authenticated user: admin
DEBUG JwtAuthenticationFilter : ğŸ” Security context updated for user: admin
```

### 4.3 JwtUtil í† í° ê²€ì¦ ìƒì„¸

```java
@Component
public class JwtUtil {
    
    private final SecretKey key;
    
    public Boolean validateToken(String token) {
        try {
            // ========================================
            // STEP 1: í† í° íŒŒì‹± ë° ì„œëª… ê²€ì¦
            // ========================================
            log.debug("ğŸ” Parsing JWT token...");
            
            Jwts.parser()
                    .verifyWith(key)  // âœ… ì„œëª… ê²€ì¦ (HMAC SHA-512)
                    .build()
                    .parseSignedClaims(token);
            
            log.debug("âœ… Token signature verified");
            
            // ========================================
            // STEP 2: ë§Œë£Œ ì‹œê°„ í™•ì¸
            // ========================================
            if (isTokenExpired(token)) {
                log.warn("âš ï¸ Token validation failed: Token is expired");
                return false;
            }
            
            log.debug("âœ… Token not expired");
            log.debug("âœ… Token validation successful");
            return true;
            
        } catch (io.jsonwebtoken.security.SecurityException e) {
            log.error("âŒ Invalid JWT signature: {}", e.getMessage());
        } catch (io.jsonwebtoken.ExpiredJwtException e) {
            log.error("âŒ Expired JWT token: {}", e.getMessage());
        } catch (io.jsonwebtoken.MalformedJwtException e) {
            log.error("âŒ Malformed JWT token: {}", e.getMessage());
        } catch (Exception e) {
            log.error("âŒ JWT validation error: {}", e.getMessage());
        }
        
        return false;
    }
    
    public String extractUsername(String token) {
        // Claimsì—ì„œ subject (ì‚¬ìš©ìëª…) ì¶”ì¶œ
        Claims claims = Jwts.parser()
                .verifyWith(key)
                .build()
                .parseSignedClaims(token)
                .getPayload();
        
        String username = claims.getSubject();
        log.debug("ğŸ“ Extracted username from token: {}", username);
        return username;
    }
}
```

**ê²€ì¦ ê³¼ì •:**
```
1. í† í° êµ¬ì¡° í™•ì¸: header.payload.signature
2. ì„œëª… ê²€ì¦:
   - Header + Payload â†’ HMAC-SHA512(secret) 
   - ê³„ì‚°ëœ ì„œëª… vs í† í°ì˜ ì„œëª… ë¹„êµ
3. í´ë ˆì„ íŒŒì‹±:
   - sub: "admin"
   - iat: 1767233751
   - exp: 1767320151
4. ë§Œë£Œ í™•ì¸:
   - exp (1767320151) > now (1767234000) â†’ âœ… ìœ íš¨
```

### 4.4 Security Filter Chain

```java
@Configuration
@EnableWebSecurity
public class BoardSecurityConfig {

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        return http
            .csrf(csrf -> csrf.disable())
            .sessionManagement(session -> 
                session.sessionCreationPolicy(SessionCreationPolicy.STATELESS)
            )
            .authorizeHttpRequests(auth -> auth
                // ğŸ”“ Public: GET ìš”ì²­
                .requestMatchers(HttpMethod.GET, "/boards/**").permitAll()
                
                // ğŸ”’ Authenticated: POST ìš”ì²­
                .requestMatchers(HttpMethod.POST, "/boards/**").authenticated()
                
                .anyRequest().authenticated()
            )
            // âœ… JWT í•„í„°ë¥¼ UsernamePasswordAuthenticationFilter ì•ì— ì¶”ê°€
            .addFilterBefore(jwtAuthenticationFilter, 
                           UsernamePasswordAuthenticationFilter.class)
            .build();
    }
}
```

**ì²˜ë¦¬ ìˆœì„œ:**
```
1. JwtAuthenticationFilter ì‹¤í–‰
   â†’ JWT ê²€ì¦ âœ…
   â†’ SecurityContext ì„¤ì • âœ…
   
2. FilterSecurityInterceptor ì‹¤í–‰
   â†’ POST /boards â†’ .authenticated() í•„ìš”
   â†’ SecurityContext í™•ì¸
   â†’ Authentication ì¡´ì¬ âœ… (admin)
   â†’ ê¶Œí•œ í™•ì¸ âœ… (ROLE_USER)
   â†’ í†µê³¼ âœ…
```

**ë¡œê·¸:**
```
DEBUG FilterSecurityInterceptor : Authorizing filter invocation [POST /boards]
DEBUG FilterSecurityInterceptor : Authenticated user: admin
DEBUG FilterSecurityInterceptor : Authorization successful
```

### 4.5 Controller ì§„ì…

```java
@RestController
@RequestMapping("/boards")
public class BoardController {
    
    @PostMapping
    public ResponseEntity<BoardDto.Response> createBoard(
            @Valid @RequestBody BoardDto.CreateRequest request) {
        
        // ========================================
        // ì¸ì¦ëœ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        // ========================================
        Authentication authentication = 
            SecurityContextHolder.getContext().getAuthentication();
        
        String username = authentication.getName();
        
        log.info("ğŸ“ Creating board by authenticated user: {}", username);
        // ì¶œë ¥: ğŸ“ Creating board by authenticated user: admin
        
        // ========================================
        // ë³´ì•ˆ: authorë¥¼ ì¸ì¦ëœ ì‚¬ìš©ìë¡œ ë®ì–´ì“°ê¸°
        // ========================================
        request.setAuthor(username);  // âœ… í´ë¼ì´ì–¸íŠ¸ê°€ ë³´ë‚¸ author ë¬´ì‹œ
        
        BoardDto.Response response = boardService.createBoard(request);
        return ResponseEntity.status(HttpStatus.CREATED).body(response);
    }
}
```

**ë¡œê·¸:**
```
INFO  BoardController : ğŸ“ Creating board by authenticated user: admin
DEBUG BoardController : Request: {title=ê²Œì‹œê¸€ ì œëª©, content=ê²Œì‹œê¸€ ë‚´ìš©}
DEBUG BoardController : Author overridden to: admin
```

---

## 5. ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥

### 5.1 Service Layer

```java
@Service
public class BoardService {
    
    @Transactional
    public BoardDto.Response createBoard(BoardDto.CreateRequest request) {
        log.debug("ğŸ’¾ Creating board entity");
        
        Board board = Board.builder()
            .title(request.getTitle())
            .content(request.getContent())
            .author(request.getAuthor())  // âœ… ì¸ì¦ëœ ì‚¬ìš©ì
            .viewCount(0)
            .build();
        
        log.debug("ğŸ’¾ Saving board to database");
        Board savedBoard = boardRepository.save(board);
        
        log.info("âœ… Board created successfully with ID: {}", savedBoard.getId());
        
        return BoardDto.Response.from(savedBoard);
    }
}
```

### 5.2 JPA/Hibernate

```sql
-- Hibernateê°€ ìƒì„±í•˜ëŠ” SQL
INSERT INTO boards (
    title, 
    content, 
    author, 
    view_count, 
    created_at, 
    updated_at
) VALUES (
    'ê²Œì‹œê¸€ ì œëª©',
    'ê²Œì‹œê¸€ ë‚´ìš©',
    'admin',      -- âœ… ì¸ì¦ëœ ì‚¬ìš©ì
    0,
    '2026-01-01 03:32:47.710609',
    '2026-01-01 03:32:47.710733'
)
```

**ë¡œê·¸:**
```
DEBUG SQL : insert into boards (title, content, author, view_count, created_at, updated_at) values (?, ?, ?, ?, ?, ?)
TRACE SQL : binding parameter [1] as [VARCHAR] - [ê²Œì‹œê¸€ ì œëª©]
TRACE SQL : binding parameter [2] as [VARCHAR] - [ê²Œì‹œê¸€ ë‚´ìš©]
TRACE SQL : binding parameter [3] as [VARCHAR] - [admin]
TRACE SQL : binding parameter [4] as [INTEGER] - [0]
DEBUG SQL : generated identifier: 2
INFO  BoardService : âœ… Board created successfully with ID: 2
```

---

## 6. ì‘ë‹µ ë°˜í™˜

### 6.1 Response DTO ìƒì„±

```java
BoardDto.Response response = BoardDto.Response.builder()
    .id(2L)
    .title("ê²Œì‹œê¸€ ì œëª©")
    .content("ê²Œì‹œê¸€ ë‚´ìš©")
    .author("admin")  // âœ… ì¸ì¦ëœ ì‚¬ìš©ì
    .viewCount(0)
    .createdAt(LocalDateTime.now())
    .updatedAt(LocalDateTime.now())
    .commentCount(0)
    .attachmentCount(0)
    .build();
```

### 6.2 HTTP ì‘ë‹µ

```http
HTTP/1.1 201 Created
Content-Type: application/json
Transfer-Encoding: chunked
Date: Thu, 01 Jan 2026 03:32:47 GMT

{
  "id": 2,
  "title": "ê²Œì‹œê¸€ ì œëª©",
  "content": "ê²Œì‹œê¸€ ë‚´ìš©",
  "author": "admin",
  "viewCount": 0,
  "createdAt": "2026-01-01T03:32:47.710609",
  "updatedAt": "2026-01-01T03:32:47.710733",
  "commentCount": 0,
  "attachmentCount": 0
}
```

### 6.3 ì‘ë‹µ ê²½ë¡œ (ì—­ìˆœ)

```
Board Service (8084)
  â†“ 201 Created + JSON
API Gateway (8080)
  â†“ + CORS Headers
Nginx (80)
  â†“
Browser
```

**Gatewayê°€ ì¶”ê°€í•˜ëŠ” CORS í—¤ë”:**
```http
Access-Control-Allow-Origin: http://localhost:3000
Access-Control-Allow-Credentials: true
```

---

## ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨

```mermaid
sequenceDiagram
    participant Browser
    participant Nginx
    participant Gateway
    participant Eureka
    participant BoardService
    participant JwtFilter
    participant SecurityChain
    participant Controller
    participant Database

    Browser->>Nginx: POST /api/boards + JWT
    Note over Browser: Authorization: Bearer eyJ...
    
    Nginx->>Gateway: POST /api/boards + JWT
    Note over Nginx: Proxy to api-gateway:8080
    
    Gateway->>Gateway: CORS Filter
    Note over Gateway: Origin, Method, Headers ê²€ì¦
    
    Gateway->>Gateway: Security Filter
    Note over Gateway: permitAll() - í†µê³¼
    
    Gateway->>Eureka: Get board-service instances
    Eureka-->>Gateway: board-service:8084 (UP)
    
    Gateway->>Gateway: StripPrefix
    Note over Gateway: /api/boards â†’ /boards
    
    Gateway->>BoardService: POST /boards + JWT
    Note over Gateway: lb://board-service
    
    BoardService->>JwtFilter: doFilterInternal()
    
    JwtFilter->>JwtFilter: Extract JWT token
    Note over JwtFilter: authHeader.substring(7)
    
    JwtFilter->>JwtFilter: validateToken()
    Note over JwtFilter: ì„œëª… ê²€ì¦, ë§Œë£Œ í™•ì¸
    
    JwtFilter->>JwtFilter: extractUsername()
    Note over JwtFilter: Claims.getSubject() â†’ "admin"
    
    JwtFilter->>JwtFilter: Set SecurityContext
    Note over JwtFilter: Authentication ê°ì²´ ìƒì„±
    
    JwtFilter->>SecurityChain: filterChain.doFilter()
    
    SecurityChain->>SecurityChain: Check Authorization
    Note over SecurityChain: POST /boards â†’ authenticated()
    
    SecurityChain->>SecurityChain: Verify Authentication
    Note over SecurityChain: SecurityContext â†’ admin âœ…
    
    SecurityChain->>Controller: createBoard()
    
    Controller->>Controller: Get authenticated user
    Note over Controller: SecurityContext.getAuthentication()
    
    Controller->>Controller: Override author
    Note over Controller: request.setAuthor("admin")
    
    Controller->>Database: INSERT board
    Note over Database: author = "admin"
    
    Database-->>Controller: Board (id=2)
    
    Controller-->>SecurityChain: 201 Created + DTO
    SecurityChain-->>JwtFilter: Response
    JwtFilter-->>BoardService: Response
    BoardService-->>Gateway: 201 Created
    Gateway-->>Nginx: 201 + CORS Headers
    Nginx-->>Browser: 201 Created
    
    Note over Browser: navigate('/boards/2')
```

---

## ì½”ë“œ ë ˆë²¨ ìƒì„¸ ë¶„ì„

### JwtAuthenticationFilter ì‹¤í–‰ íë¦„

```java
// ============================================================
// í•„í„° ì‹¤í–‰ ìˆœì„œ
// ============================================================
1. doFilterInternal() í˜¸ì¶œ
   â†“
2. Authorization í—¤ë” í™•ì¸
   â”œâ”€ ì—†ìŒ â†’ ë‹¤ìŒ í•„í„°ë¡œ (ì¸ì¦ ì•ˆ í•¨)
   â””â”€ ìˆìŒ â†’ 3ë‹¨ê³„
   â†“
3. "Bearer " ì ‘ë‘ì‚¬ í™•ì¸
   â”œâ”€ ì—†ìŒ â†’ ë‹¤ìŒ í•„í„°ë¡œ
   â””â”€ ìˆìŒ â†’ 4ë‹¨ê³„
   â†“
4. JWT í† í° ì¶”ì¶œ
   token = authHeader.substring(7)
   â†“
5. validateToken(token)
   â”œâ”€ ì‹¤íŒ¨ â†’ 401 ì‘ë‹µ ë°˜í™˜
   â””â”€ ì„±ê³µ â†’ 6ë‹¨ê³„
   â†“
6. extractUsername(token)
   username = claims.getSubject()
   â†“
7. Authentication ê°ì²´ ìƒì„±
   new UsernamePasswordAuthenticationToken(
       username,
       null,
       [ROLE_USER]
   )
   â†“
8. SecurityContext ì„¤ì •
   SecurityContextHolder.getContext()
       .setAuthentication(authentication)
   â†“
9. ë‹¤ìŒ í•„í„°ë¡œ ì§„í–‰
   filterChain.doFilter(request, response)
```

### JWT í† í° êµ¬ì¡°

```
eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJhZG1pbiIsImlhdCI6MTc2NzIzMzc1MSwiZXhwIjoxNzY3MzIwMTUxfQ.wZceooNCoon4j95l_8RaEBP909ErGFk9BvW76vt5ZrI06FzToOphoWDAWztOdi-fDb6HMSjUonIb14MlRP7nGg

â”œâ”€ Header (Base64)
â”‚  {
â”‚    "alg": "HS512",
â”‚    "typ": "JWT"
â”‚  }
â”‚
â”œâ”€ Payload (Base64)
â”‚  {
â”‚    "sub": "admin",              â† ì‚¬ìš©ìëª…
â”‚    "iat": 1767233751,           â† ë°œê¸‰ ì‹œê°„
â”‚    "exp": 1767320151            â† ë§Œë£Œ ì‹œê°„
â”‚  }
â”‚
â””â”€ Signature (HMAC-SHA512)
   HMACSHA512(
     base64(header) + "." + base64(payload),
     secret_key
   )
```

### SecurityContext ì „íŒŒ

```java
// ============================================================
// SecurityContextëŠ” ThreadLocalì— ì €ì¥ë¨
// ============================================================

// 1. JwtAuthenticationFilterì—ì„œ ì„¤ì •
SecurityContextHolder.getContext()
    .setAuthentication(authentication);

// 2. ê°™ì€ Threadì˜ ëª¨ë“  í›„ì† ì²˜ë¦¬ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥

// 3. Controllerì—ì„œ ì‚¬ìš©
Authentication auth = SecurityContextHolder.getContext()
    .getAuthentication();
String username = auth.getName();  // "admin"

// 4. Service Layerì—ì„œë„ ì ‘ê·¼ ê°€ëŠ¥
@Service
public class BoardService {
    public void someMethod() {
        String user = SecurityContextHolder.getContext()
            .getAuthentication().getName();
    }
}
```

---

## í•µì‹¬ í¬ì¸íŠ¸ ì •ë¦¬

### âœ… ì¸ì¦ ì„±ê³µ ì¡°ê±´

1. **JWT í† í° ì¡´ì¬**: Authorization í—¤ë”ì— "Bearer {token}"
2. **ì„œëª… ê²€ì¦ ì„±ê³µ**: HMAC-SHA512 ì„œëª…ì´ ìœ íš¨í•¨
3. **ë§Œë£Œ ì‹œê°„ ìœ íš¨**: exp > í˜„ì¬ ì‹œê°„
4. **SecurityContext ì„¤ì •**: Authentication ê°ì²´ ìƒì„± ë° ì„¤ì •
5. **ê¶Œí•œ ê²€ì¦ í†µê³¼**: POST /boards â†’ .authenticated() ìš”êµ¬ì‚¬í•­ ì¶©ì¡±

### âŒ ì¸ì¦ ì‹¤íŒ¨ ì‹œë‚˜ë¦¬ì˜¤

1. **í† í° ì—†ìŒ**:
   ```
   â†’ JwtAuthenticationFilter í†µê³¼ (ì¸ì¦ ì•ˆ í•¨)
   â†’ SecurityFilterChain: POST /boards â†’ authenticated() í•„ìš”
   â†’ 401 Unauthorized
   ```

2. **í† í° ì„œëª… ì˜¤ë¥˜**:
   ```
   â†’ validateToken() ì‹¤íŒ¨
   â†’ SecurityException ë°œìƒ
   â†’ 401 Unauthorized ì‘ë‹µ
   ```

3. **í† í° ë§Œë£Œ**:
   ```
   â†’ isTokenExpired() = true
   â†’ validateToken() ì‹¤íŒ¨
   â†’ 401 Unauthorized ì‘ë‹µ
   ```

4. **ì˜ëª»ëœ í† í° í˜•ì‹**:
   ```
   â†’ parseSignedClaims() ì‹¤íŒ¨
   â†’ MalformedJwtException ë°œìƒ
   â†’ 401 Unauthorized ì‘ë‹µ
   ```

### ğŸ”’ ë³´ì•ˆ ê°•í™” í¬ì¸íŠ¸

1. **Author ë®ì–´ì“°ê¸°**:
   ```java
   // âŒ í´ë¼ì´ì–¸íŠ¸ê°€ ë³´ë‚¸ author ì‚¬ìš© (ìœ„í—˜!)
   boardService.createBoard(request);
   
   // âœ… ì¸ì¦ëœ ì‚¬ìš©ìë¡œ ë®ì–´ì“°ê¸° (ì•ˆì „)
   request.setAuthor(authentication.getName());
   boardService.createBoard(request);
   ```

2. **Stateless ì„¸ì…˜**:
   ```java
   .sessionManagement(session -> 
       session.sessionCreationPolicy(SessionCreationPolicy.STATELESS)
   )
   ```
   â†’ ì„œë²„ê°€ ì„¸ì…˜ì„ ì €ì¥í•˜ì§€ ì•ŠìŒ
   â†’ ëª¨ë“  ìš”ì²­ë§ˆë‹¤ JWT ê²€ì¦

3. **CSRF ë¹„í™œì„±í™”**:
   ```java
   .csrf(csrf -> csrf.disable())
   ```
   â†’ JWT ì‚¬ìš© ì‹œ CSRF ê³µê²© ë¶ˆê°€ëŠ¥
   â†’ Stateless ë°©ì‹ì´ë¯€ë¡œ Cookie ì‚¬ìš© ì•ˆ í•¨

---

## ì„±ëŠ¥ ìµœì í™”

### JWT ê²€ì¦ ìºì‹± (ì„ íƒì )

```java
@Component
public class JwtUtil {
    
    private final Cache<String, String> tokenCache = 
        CacheBuilder.newBuilder()
            .maximumSize(1000)
            .expireAfterWrite(5, TimeUnit.MINUTES)
            .build();
    
    public String extractUsername(String token) {
        return tokenCache.get(token, () -> {
            // ìºì‹œ ë¯¸ìŠ¤ ì‹œì—ë§Œ íŒŒì‹±
            Claims claims = parseToken(token);
            return claims.getSubject();
        });
    }
}
```

### ë¡œê¹… ë ˆë²¨ ì¡°ì •

```yaml
# application.yml
logging:
  level:
    com.enterprise.board.filter: INFO  # í”„ë¡œë•ì…˜
    # com.enterprise.board.filter: DEBUG  # ê°œë°œ
```

---

## ë¬¸ì œ í•´ê²° ê°€ì´ë“œ

### 401 Unauthorized ë°œìƒ ì‹œ

1. **í† í° í™•ì¸**:
   ```javascript
   console.log('Token:', localStorage.getItem('token'))
   ```

2. **í† í° ìœ íš¨ì„± í™•ì¸**:
   ```bash
   # https://jwt.io ì—ì„œ í† í° ë””ì½”ë”©
   # exp í™•ì¸: ë§Œë£Œë˜ì§€ ì•Šì•˜ëŠ”ì§€
   # sub í™•ì¸: ì‚¬ìš©ìëª…ì´ ì˜¬ë°”ë¥¸ì§€
   ```

3. **ì„œë²„ ë¡œê·¸ í™•ì¸**:
   ```bash
   docker-compose logs -f board-service | grep JWT
   ```

### 403 Forbidden ë°œìƒ ì‹œ

ê¶Œí•œ ë¶€ì¡±:
```java
// SecurityConfig í™•ì¸
.requestMatchers(HttpMethod.POST, "/boards/**").authenticated()  // âœ…
// .requestMatchers(HttpMethod.POST, "/boards/**").hasRole("ADMIN")  // âŒ
```

---

## ë§ˆë¬´ë¦¬

ì´ ë¬¸ì„œëŠ” ê²Œì‹œê¸€ ì‘ì„± ìš”ì²­ì˜ **ì™„ì „í•œ ì„œë²„ ì‚¬ì´ë“œ ì¸ì¦ ì²˜ë¦¬ ê³¼ì •**ì„ ë‹¤ë£¹ë‹ˆë‹¤.

**í•µì‹¬ ìš”ì•½:**
1. í´ë¼ì´ì–¸íŠ¸ê°€ JWT í† í°ê³¼ í•¨ê»˜ ìš”ì²­
2. GatewayëŠ” ë¼ìš°íŒ…ë§Œ ìˆ˜í–‰ (ì¸ì¦ ì•ˆ í•¨)
3. Board Serviceì˜ JwtAuthenticationFilterê°€ í† í° ê²€ì¦
4. SecurityFilterChainì´ ê¶Œí•œ í™•ì¸
5. Controllerì—ì„œ ì¸ì¦ëœ ì‚¬ìš©ì ì •ë³´ ì‚¬ìš©
6. Databaseì— ì•ˆì „í•˜ê²Œ ì €ì¥

**ë³´ì•ˆì´ ì ìš©ëœ ìƒíƒœì—ì„œëŠ” JWT í† í° ì—†ì´ëŠ” ê²Œì‹œê¸€ì„ ì‘ì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!** ğŸ”’
